<?xml version="1.0" encoding="utf-8"?>

<xforms:model id="cmis-rest-model" xmlns:xforms="http://www.w3.org/2002/xforms"
    xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
    xmlns:xi="http://www.w3.org/2001/XInclude"
    xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
    xmlns:cmis="http://docs.oasis-open.org/ns/cmis/core/200908/"
    xmlns:ev="http://www.w3.org/2001/xml-events">
    <xxforms:variable name="alfresco-uri" select="xxforms:property('chassis.alfresco.uri')"
        as="xs:anyURI"/>
    <xxforms:variable name="alfresco-username"
        select="xxforms:property('chassis.alfresco.username')"
        as="xs:string"/>
    <xxforms:variable name="alfresco-credentials"
        select="xxforms:property('chassis.alfresco.credentials')"
        as="xs:string"/>
    <xxforms:variable name="is-send-alfresco" select="xxforms:property('chassis.alfresco.send')" as="xs:boolean"/>
    
    <xxforms:variable name="alf-ticket" select="instance('ins-cmis-rest-auth')/ticket"/>
   
    <!--
curl “http://localhost:8080/alfresco/s/api/login?u=admin&pw=admin”
Returns this:
<?xml version="1.0" encoding="UTF-8"?>
<ticket>TICKET_44740de7943f7bab5be61f787c62660ff3008299</ticket>
If you go this route, you’ll want to copy and paste the ticket (everything
between the open and closing ticket tags) somewhere convenient. Every call
you make from here on out will require it, like this:
curl
"http://localhost:8080/alfresco/s/cmis?alf_ticket=TICKET_44740de7943f7b
ab5be61f787c62660ff3008299"
    -->
    <xforms:instance id="ins-cmis-rest-control">
        <control>
            <site/>
        </control>
    </xforms:instance>
    
    <xforms:instance id="ins-cmis-rest-auth">
        <ticket xmlns=""/>
    </xforms:instance>
    
    <xforms:instance id="ins-cmis-rest-create-site">
        <xi:include href="create-site.xml" xxi:omit-xml-base="true"/>
    </xforms:instance>

    <xforms:instance id="ins-cmis-rest-create-space">
        <xi:include href="create-space.xml" xxi:omit-xml-base="true"/>
    </xforms:instance>
    
    <xforms:instance id="ins-cmis-rest-create-file">
        <xi:include href="create-file.xml" xxi:omit-xml-base="true"/>
    </xforms:instance>
    
    <!-- xxforms attribs work for http auth -->
    <xforms:submission ref="instance('ins-cmis-rest-auth')" id="cmis-rest-auth-submission" method="get"
        action="{$alfresco-uri}s/api/login?u={$alfresco-username}&amp;pw={$alfresco-credentials}"
        xxforms:username="{$alfresco-username}" xxforms:password="{$alfresco-credentials}"
        replace="instance" instance="ins-cmis-rest-auth" if="$is-send-alfresco">
        <xforms:action ev:event="xforms-submit-done"> </xforms:action>
    </xforms:submission>
    
    <!--
        <xforms:dispatch target="cmis-rest-model" name="alfresco-send-document">
            <xxforms:context name="fr:name" select="concat($form-title, ' (#', $document, ').xml')"/>
            <xxforms:context name="fr:title" select="$form-title"/>
            <xxforms:context name="fr:description" select="$form-description"/>
            <xxforms:context name="fr:mimetype" select="'application/xml'"/>
        XML data -> string -> Base64
            <xxforms:context name="fr:content" select="saxon:string-to-base64Binary(saxon:serialize(xxforms:instance('fr-form-instance'), 'xml'), 'UTF-8')"/>
    </xforms:dispatch>
    -->
    <xforms:action ev:event="cmis-rest-create-site">
        <!-- 
        <xforms:send submission="cmis-rest-auth-submission"/>
        -->
        <xforms:setvalue ref="instance('ins-cmis-rest-create-site')//atom:title" value="event('fr:title')"/>
        <xforms:send submission="cmis-rest-create-site-submission"/>
        <!-- Doesn't work
        <xforms:setvalue ref="instance('ins-cmis-rest-create-space')//atom:title" value="'dataLists'"/>
        <xforms:send submission="cmis-rest-create-space-submission"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-create-space')//atom:title" value="'discussions'"/>
        <xforms:send submission="cmis-rest-create-space-submission"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-create-space')//atom:title" value="'links'"/>
        <xforms:send submission="cmis-rest-create-space-submission"/>
        -->
        <xforms:setvalue ref="instance('ins-cmis-rest-create-space')//atom:title" value="'documentLibrary'"/>
        <xforms:send submission="cmis-rest-create-space-submission"/>
    </xforms:action>
    
    <xforms:action ev:event="cmis-rest-delete-site">
        <xforms:setvalue ref="instance('ins-cmis-rest-control')//site" value="event('fr:site')"/>
        <xforms:send submission="cmis-rest-delete-site-submission"/>
    </xforms:action>
    
    <xforms:action ev:event="cmis-rest-create-document">
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//atom:title" value="concat(event('fr:name'),event('fr:file-ext'))"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//atom:summary" value="event('fr:title')"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//atom:content" value="saxon:string-to-base64Binary(saxon:serialize(event('fr:content'), 'xml'), 'UTF-8')"/>
        <!--saxon:string-to-base64Binary(saxon:serialize(event('fr:content'), 'xml'), 'UTF-8')-->
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//atom:content/@type" value="'application/octet-stream'"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//cmis:propertyString[@propertyDefinitionId='cmis:contentStreamMimeType']/cmis:value" value="event('fr:mime-type')"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//cmis:propertyString[@propertyDefinitionId='cm:author']/cmis:value" value="event('fr:author')"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-control')//site" value="event('fr:site')"/>
        <xforms:send submission="cmis-rest-create-file-submission"/>
    </xforms:action>
    
    <xforms:action ev:event="cmis-rest-update-document">
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//atom:title" value="concat(event('fr:name'),event('fr:file-ext'))"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//atom:summary" value="event('fr:title')"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//atom:content" value="saxon:string-to-base64Binary(saxon:serialize(event('fr:content'), 'xml'), 'UTF-8')"/>
        <!--saxon:string-to-base64Binary(saxon:serialize(event('fr:content'), 'xml'), 'UTF-8')-->
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//atom:content/@type" value="'application/octet-stream'"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//cmis:propertyString[@propertyDefinitionId='cmis:contentStreamMimeType']/cmis:value" value="'text/xml'"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//cmis:propertyString[@propertyDefinitionId='cm:author']/cmis:value" value="event('fr:author')"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-control')//site" value="event('fr:site')"/>
        <xforms:send submission="cmis-rest-update-file-submission"/>
    </xforms:action>
    
    <xforms:action ev:event="cmis-rest-upload-file">
        <xforms:setvalue ref="instance('ins-cmis-rest-control')//site" value="event('fr:site')"/>
       
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//atom:title" value="event('fr:title')"/>
        
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//atom:summary" value="event('fr:atombeat-uri')"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//atom:category[@term]" value="event('fr:category-term')"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//atom:category[@label]" value="event('fr:category-label')"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//atom:content" value="event('fr:file-content')"/>
        
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//atom:content/@type" value="'application/octet-stream'"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//cmis:propertyString[@propertyDefinitionId='cmis:contentStreamMimeType']/cmis:value" value="event('fr:content-type')"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-control')//site" value="event('fr:site')"/>
        <xforms:send submission="cmis-rest-create-file-submission"/>
       
    </xforms:action>
    
    <xforms:submission ref="instance('ins-cmis-rest-create-site')" id="cmis-rest-create-site-submission" method="post"
        action="{$alfresco-uri}service/cmis/p/Sites/children"
        mediatype="application/atom+xml"
        xxforms:username="{$alfresco-username}" xxforms:password="{$alfresco-credentials}"
        replace="instance" instance="ins-cmis-rest-create-site" if="$is-send-alfresco">
    </xforms:submission>
  
    <xforms:submission ref="instance('ins-cmis-rest-create-space')" id="cmis-rest-create-space-submission" method="post"
        action="{instance('ins-cmis-rest-create-site')//atom:link[@rel='down' and @type='application/atom+xml;type=feed' ]/@href}"
        mediatype="application/atom+xml"
        xxforms:username="{$alfresco-username}" xxforms:password="{$alfresco-credentials}"
        replace="instance" instance="ins-cmis-rest-create-space" if="$is-send-alfresco">
    </xforms:submission>
    <!-- These submissions are the same apart from the action definition -->
    <xforms:submission ref="instance('ins-cmis-rest-create-file')" id="cmis-rest-create-study-file-submission" method="post"
        action="{instance('ins-cmis-rest-create-space')//atom:link[@rel='down' and @type='application/atom+xml;type=feed' ]/@href}"
        mediatype="application/atom+xml"
        xxforms:username="{$alfresco-username}" xxforms:password="{$alfresco-credentials}"
        replace="instance" instance="ins-cmis-rest-create-file" if="$is-send-alfresco">
    </xforms:submission>
    <xforms:submission ref="instance('ins-cmis-rest-create-file')" id="cmis-rest-create-file-submission" method="post"
        action="{$alfresco-uri}service/cmis/p/Sites/{instance('ins-cmis-rest-control')//site}/documentLibrary/children"
        mediatype="application/atom+xml"
        xxforms:username="{$alfresco-username}" xxforms:password="{$alfresco-credentials}"
        replace="instance" instance="ins-cmis-rest-create-file" if="$is-send-alfresco">
    </xforms:submission>
    <!-- upload a file -->
    <xforms:submission ref="xxforms:instance('ins-upload')" id="cmis-rest-upload-file-submission" method="post"
        serialization="multipart/form-data"
        resource="{$alfresco-uri}service/cmis/p/Sites/{instance('ins-cmis-rest-control')//site}/documentLibrary/children"
        xxforms:username="{$alfresco-username}" xxforms:password="{$alfresco-credentials}"
        replace="none" if="$is-send-alfresco">
    </xforms:submission>
    <!-- updating -->
    <xforms:submission ref="instance('ins-cmis-rest-create-file')" id="cmis-rest-update-file-submission" method="put"
        action="{$alfresco-uri}service/cmis/p/Sites/{instance('ins-cmis-rest-control')//site}/documentLibrary/{instance('ins-cmis-rest-create-file')//atom:title}"
        mediatype="application/atom+xml"
        xxforms:username="{$alfresco-username}" xxforms:password="{$alfresco-credentials}"
        replace="instance" instance="ins-cmis-rest-create-file" if="$is-send-alfresco">
    </xforms:submission>
    <!-- deleting including all descendants -->
    <xforms:submission id="cmis-rest-delete-site-submission" method="delete"
        resource="{$alfresco-uri}service/cmis/p/Sites/{instance('ins-cmis-rest-control')//site}/descendants"
        xxforms:username="{$alfresco-username}" xxforms:password="{$alfresco-credentials}"
        replace="none"  if="$is-send-alfresco">
    </xforms:submission>
</xforms:model>