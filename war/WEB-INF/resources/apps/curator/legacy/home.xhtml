<!--
  Copyright (C) 2010 University of Oxford.
  
  This program is free software; you can redistribute it and/or modify it under the terms of the
  GNU Lesser General Public License as published by the Free Software Foundation; either version
  2.1 of the License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
  without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  See the GNU Lesser General Public License for more details.

  The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
  -->
<html 
	xmlns:xforms="http://www.w3.org/2002/xforms"
    xmlns:f="http://orbeon.org/oxf/xml/formatting" 
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:atom="http://www.w3.org/2005/Atom"
    xmlns:ar="http://purl.org/atompub/revision/1.0"
    xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
    xmlns:xi="http://www.w3.org/2001/XInclude"
    xmlns:manta="http://www.cggh.org/2010/chassis/manta/xmlns">
    
    <head>
    
        <title>Data Management - Curator - Home</title>
        <link rel="stylesheet" type="text/css" href="/apps/submitter/common/style.css"></link>
        <style type="text/css"></style>
        
        <xforms:model id="mod-main">
        
        	<xforms:instance id="ins-noparams">
        		<params/>
        	</xforms:instance>
            
			<xforms:instance id="ins-study-feed">
				<atom:feed/>
			</xforms:instance>
			
			<xforms:submission 
				id="sub-retrieve-study-feed"
				resource="/atombeat/content/studies"
				method="get"
				ref="instance('ins-noparams')"
				replace="instance"
				instance="ins-study-feed">
				<!-- TODO error handling -->
                <xforms:message 
                	ev:event="xforms-submit-error" 
                	level="modal">An error occurred (<xforms:output value="event('response-status-code')"/>) while retrieving studies.</xforms:message>
			</xforms:submission>
			
			<xforms:send 
				ev:event="xforms-model-construct-done" 
				submission="sub-retrieve-study-feed"/>
			
        </xforms:model>

       	<xi:include href="/apps/common/includes/current-user-xforms-model.xml"/>

    </head>
    
    <body>
    
    	<h1>Curator - Home</h1>
    	
    	<div id="home-nav"><xforms:output model="mod-current-user" ref="instance('ins-current-user')/name"/></div>
    	
    	<div id="content">
    	
    		<p>Welcome to the Curator home page.</p>
    		
    		<h2>Actions</h2>
    		
	    	<ul>
	    	
	    		<xforms:group ref="instance('ins-study-feed')[count(atom:entry)=0]">
		    		<li><span class="locked-action">Submit Files</span> (you have to create a study before you can submit files)</li>
	    		</xforms:group>
	    		
	    		<xforms:group ref="instance('ins-study-feed')[count(atom:entry)>0]">
		    		<li><a class="action" href="submit-files">Submit Files</a></li>
	    		</xforms:group>
	    		
	    	</ul>
	    	
	    	<h2>Studies</h2>
	    	
    		<xforms:group ref="instance('ins-study-feed')[count(atom:entry)=0]">
	    		<p>Please <a href="create-study">create a study</a>.</p>
    		</xforms:group>

    		<xforms:group ref="instance('ins-study-feed')[count(atom:entry)>0]">
		    	<fr:datatable paginated="false">
		    		<thead>
		    			<tr>
		    				<th>Code</th>
		    				<th>Title</th>
		    				<th>Created</th>
		    				<th>Updated</th>
		    				<th>By</th>
		    				<th>Actions</th>
		    			</tr>
		    		</thead>
		    		<tbody>
		    			<xforms:repeat id="rep-study-entry" nodeset="instance('ins-study-feed')/atom:entry">
		    				<tr>
		    					<td>
		    						<xforms:output ref="manta:id"/>
		    					</td>
		    					<td>
		    						<xforms:output ref="atom:title"/>
		    					</td>
		    					<td>
		    						<xforms:output ref="atom:published" xxforms:format="format-dateTime(., '[M01]/[D01]/[Y]')"/>
		    					</td>
		    					<td>
		    						<xforms:output ref="atom:updated" xxforms:format="format-dateTime(., '[M01]/[D01]/[Y]')"/>
		    					</td>
		    					<td>
		    						<xforms:output ref="ar:comment/atom:author/atom:email" />
		    					</td>
		    					<td>
		    						<a href="view-study?study={atom:link[@rel='edit']/@href}">View</a> <br/> 
		    						<a href="submit-files?study={atom:link[@rel='edit']/@href}">Submit Files</a> <br/> 
		    						<a href="study-questionnaire?study={atom:link[@rel='edit']/@href}">Questionnaire</a><br/>
		    						<a href="{atom:link[@rel='history']/@href}">History</a>
		    					</td>
		    				</tr>
		    			</xforms:repeat>
		    		</tbody>
		    	</fr:datatable>
    		</xforms:group>
    		
    	</div>
    	
    </body>
</html>

