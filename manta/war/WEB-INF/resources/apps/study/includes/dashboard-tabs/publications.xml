<?oxygen NVDLSchema="../../../../../../../oxygen/samples/nvdl/xhtml-xforms-11-orbeon.nvdl"?>
<div 
	xmlns="http://www.w3.org/1999/xhtml" 
	xmlns:xforms="http://www.w3.org/2002/xforms" 
	xmlns:ev="http://www.w3.org/2001/xml-events"
	xmlns:xi="http://www.w3.org/2001/XInclude">

	<!-- If the user has PUT access to the study entry. -->
	<xforms:group ref="instance('ins-study-entry')/atom:link[@rel='edit' and contains(@atombeat:allow, 'PUT')]">

		<p>
			<xforms:select1 ref="instance('ins-study-entry')/atom:content/study/study-is-published">
				<xforms:label>Is the study published?</xforms:label>
				<xforms:item>
					<xforms:label>Select...</xforms:label>
					<xforms:value></xforms:value>
				</xforms:item>
	
	
	           	<xforms:itemset nodeset="instance('ins-study-is-published-terms')/term">
	           		<xforms:label ref="label"/>
	           		<xforms:value ref="value"/>
	           	</xforms:itemset>
		
				
			</xforms:select1>
		</p>
	
	    <xforms:group ref="instance('ins-study-entry')/atom:content/study/publications">
	
	    	<div id="editable-list-of-publications-container">
	    		
	    		<table>
	    			<xforms:repeat nodeset="publication" id="rep-publication">
	    				<tr class="repeated-element">
	    					<td class="publication-deletion-cell">
	    						<xforms:trigger class="addRemove">
	    							<xforms:label><img src="/apps/study/common/remove.gif" alt="Remove"/></xforms:label>
	    							<xforms:delete 
	    								ev:event="DOMActivate" 
	    								context="." 
	    								nodeset="." 
	    								at="index('rep-publication')"/>
	    						</xforms:trigger>
	    					</td>
	    					<td>
	    						<span class="pmid-textbox-container">
	    							<xforms:input ref="pmid">
	    								<xforms:label>PubMedID:</xforms:label>
	    								<xforms:alert>Please provide a PubMed IDentifier.</xforms:alert>
	    							</xforms:input>
	    						</span>
	    						
	    						<br/>
	    						
		    					<xforms:group ref="publication-references">
		    						
		    						<div class="editable-list-of-publication-references-container">
		    							
		    							<table>
		    								
		    								<xforms:repeat nodeset="publication-reference" id="rep-publication-reference">
		    									
		    									<tr class="repeated-element">	
		    										<td>
		    											<xforms:trigger class="addRemove">
		    												<xforms:label>
		    													<img src="/apps/study/common/remove.gif" alt="Remove" />
		    												</xforms:label>
		    												<xforms:delete ev:event="DOMActivate" context="."
		    													nodeset="." at="index('rep-publication-reference')" />
		    											</xforms:trigger>
		    										</td>
		    										<td>
		    											<span class="publication-reference-type-menu-container">
		    												<xforms:select1 appearance="minimal" ref="publication-reference-type">
		    													<xforms:label class="invisible">Publication reference type
		    													</xforms:label>
		    													<xforms:itemset
		    														nodeset="instance('ins-publication-reference-types')/publication-reference-type">
		    														<xforms:label ref="label" />
		    														<xforms:value ref="value" />
		    													</xforms:itemset>
		    												</xforms:select1>
		    											</span>
		    											<span class="url-textbox-container">
		    												<xforms:input ref="url">
		    													<xforms:label class="invisible">URL</xforms:label>
		    													<xforms:alert>Please provide a valid URL.</xforms:alert>
		    												</xforms:input>
		    											</span>
		    											<span class="doi-textbox-container">
		    												<xforms:input ref="doi">
		    													<xforms:label class="invisible">DOI</xforms:label>
		    													<xforms:alert>Please provide a valid DOI.</xforms:alert>
		    												</xforms:input>
		    											</span>
		    										</td>
		    										
		    									</tr>
		    									
		    								</xforms:repeat>
		    								
		    								<tr>		                    	
		    									
		    									<td>
		    										<xforms:trigger class="addRemove">
		    											<xforms:label>
		    												<img src="/apps/contributor/common/add.gif" alt="Add" />
		    											</xforms:label>
		    											<xforms:insert ev:event="DOMActivate" context="."
		    												nodeset="publication-reference" at="last()"
		    												position="after" origin="instance('ins-publication-reference')" />
		    										</xforms:trigger>
		    									</td>
		    									<td>
		    										<span class="add-publication-reference-link-container">
		    											<xforms:trigger appearance="minimal" class="addRemove">
		    												<xforms:label>Add a URL or a DOI</xforms:label>
		    												<xforms:insert ev:event="DOMActivate" context="."
		    													nodeset="publication-reference" at="last()"
		    													position="after" origin="instance('ins-publication-reference')" />
		    											</xforms:trigger>
		    										</span>
		    									</td>
		    								</tr>
		    								
		    							</table>
		    							
		    						</div>
	    						
		    					</xforms:group>
	    						
	    					</td>
	    				</tr>
	    			</xforms:repeat>
	    			<xforms:group ref="instance('ins-control')/add-publication-trigger">
	    				<tr>
	    					<td>
	    						<xforms:trigger class="addRemove">
	    							<xforms:label><img src="/apps/study/common/add.gif" alt="Add"/></xforms:label>
	    							<xforms:insert 
	    								ev:event="DOMActivate" 
	    								context="instance('ins-study-entry')/atom:content/study/publications" 
	    								nodeset="publication" 
	    								at="last()" 
	    								position="after" 
	    								origin="instance('ins-publication-template')"/>
	    						</xforms:trigger>
	    					</td>
	    					<td>
	    						<span id="add-publication-link-container">
	    							<xforms:trigger appearance="minimal" class="addRemove">
	    								<xforms:label>Add a publication</xforms:label>
	    								<xforms:insert 
	    									ev:event="DOMActivate" 
	    									context="instance('ins-study-entry')/atom:content/study/publications" 
	    									nodeset="publication" 
	    									at="last()" 
	    									position="after" 
	    									origin="instance('ins-publication-template')"/>
	    							</xforms:trigger>
	    						</span>
	    					</td>
	    				</tr>
	    			</xforms:group>
	    		</table>
	    		
	    	</div>
	
		</xforms:group>		
	
	     <p>
	     	<span id="publications-save-changes-button-container">
	     	<xforms:trigger ref="instance('ins-control')/save-study-trigger">
	     		<xforms:label>Save changes</xforms:label>
	     		<xforms:action ev:event="DOMActivate" if="../study-entry-is-valid = 'true'">
	     			<xforms:send submission="sub-put-study-entry"/>
	     		</xforms:action>
	     		<xforms:action ev:event="DOMActivate" if="not(../study-entry-is-valid = 'true')">
	     			<xforms:message>Please complete all required fields.</xforms:message>
	     		</xforms:action>
	     	</xforms:trigger>
	     	</span>
	     </p>
		
	</xforms:group>
	
	<!-- If the user has GET access to the study entry, but not PUT access. -->
	<xforms:group ref="instance('ins-study-entry')/atom:link[@rel='edit' and contains(@atombeat:allow, 'GET')]">
		<xforms:group ref="instance('ins-study-entry')/atom:link[@rel='edit' and not(contains(@atombeat:allow, 'PUT'))]">
			
			<xforms:group ref="instance('ins-study-entry')/atom:content/study">
				
				<p>
					<xforms:output ref="study-is-published">
						<xforms:label>Is the study published?</xforms:label>
					</xforms:output>
					<xforms:group ref="instance('ins-control')/study-is-published-unspecified">
						<span>Unspecified</span>
					</xforms:group>
				</p>
				
				<xforms:group ref="publications[exists(publication)]">
					
					<ul>
						<xforms:repeat nodeset="publication" id="rep-publication-curator">
							<li class="publication-form-summary-item">
									<xforms:output ref="pmid">
										<xforms:label>PubMedID:</xforms:label>
									</xforms:output>
								
									<xforms:group ref="publication-references">
										<ul>
											<xforms:repeat nodeset="publication-reference">
												<li class="publication-reference-form-summary-item">
													<xforms:output ref="url">
														<xforms:label>URL:</xforms:label>
													</xforms:output>
													<xforms:output ref="doi">
														<xforms:label>DOI:</xforms:label>
													</xforms:output>
												</li>
											</xforms:repeat>
										</ul>
									</xforms:group>
								
							</li>
						</xforms:repeat>
					</ul>
					
				</xforms:group>		
				
			</xforms:group>
			
		</xforms:group>
	</xforms:group>

</div>