<!--
  Copyright (C) 2010 University of Oxford.
  
  This program is free software; you can redistribute it and/or modify it under the terms of the
  GNU Lesser General Public License as published by the Free Software Foundation; either version
  2.1 of the License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
  without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  See the GNU Lesser General Public License for more details.

  The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
  -->
<?oxygen NVDLSchema="../../../../../oxygen/samples/nvdl/xhtml-xforms-11-orbeon.nvdl"?>
<html 
	xmlns:xforms="http://www.w3.org/2002/xforms"
    xmlns:f="http://orbeon.org/oxf/xml/formatting" 
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:atom="http://www.w3.org/2005/Atom"
    xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
    xmlns:xi="http://www.w3.org/2001/XInclude"
    xmlns:manta="http://www.cggh.org/2010/chassis/manta/xmlns"
    xmlns:atombeat="http://purl.org/atombeat/xmlns"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:xxi="http://orbeon.org/oxf/xml/xinclude">
    
    <head>
        <title>Study dashboard - Study <xforms:output value="instance('ins-study-entry')/manta:id"/></title>
        <link rel="stylesheet" type="text/css" href="/ops/yui/tabview/assets/skins/sam/tabview.css"></link>
        <style type="text/css"></style>
        

        <xforms:model id="mod-study-dashboard">
        
        	<!-- non-persistent model for application state -->
        	<xforms:instance id="ins-control">
        		<control xmlns="">
        			<!-- Defaults to summary if there is no tab request-paramater, determined in the setvalue logic below. -->
        			<dashboard-tab-to-show />
        			<permissions-entry-is-valid/>
        			<save-permissions-trigger/>
        			<study-entry-is-valid/>
        			<save-study-trigger/>
        			<add-publication-trigger/>
        			<upload-is-valid/>
        			<upload-file-trigger/>
        			<href-to-copy-study-info-from/>
        			<copy-answers-control/>
        			<copy-answers-trigger/>
        			<contributor-controls/>
        			<curator-controls/>
        			<administrator-controls/>
        		</control>
        	</xforms:instance>
        	
        	<xforms:setvalue ev:event="xforms-model-construct-done" ref="instance('ins-control')/dashboard-tab-to-show" value="if(not(empty(xxforms:get-request-parameter('tab')))) then xxforms:get-request-parameter('tab') else 'summary'" />


			<xforms:action ev:event="xxforms-invalid" ev:observer="ins-permissions-entry">
				<xforms:setvalue ev:event="xforms-value-changed" ref="instance('ins-control')/permissions-entry-is-valid">false</xforms:setvalue>
			</xforms:action>
			<xforms:action ev:event="xxforms-valid" ev:observer="ins-permissions-entry">
				<xforms:setvalue ev:event="xforms-value-changed" ref="instance('ins-control')/permissions-entry-is-valid">true</xforms:setvalue>
			</xforms:action>

			<xforms:action ev:event="xxforms-invalid" ev:observer="ins-upload">
				<xforms:setvalue ev:event="xforms-value-changed" ref="instance('ins-control')/upload-is-valid">false</xforms:setvalue>
			</xforms:action>
			<xforms:action ev:event="xxforms-valid" ev:observer="ins-upload">
				<xforms:setvalue ev:event="xforms-value-changed" ref="instance('ins-control')/upload-is-valid">true</xforms:setvalue>
			</xforms:action>

			<xforms:action ev:event="xxforms-invalid" ev:observer="ins-study-entry">
				<xforms:setvalue ev:event="xforms-value-changed" ref="instance('ins-control')/study-entry-is-valid">false</xforms:setvalue>
			</xforms:action>
			<xforms:action ev:event="xxforms-valid" ev:observer="ins-study-entry">
				<xforms:setvalue ev:event="xforms-value-changed" ref="instance('ins-control')/study-entry-is-valid">true</xforms:setvalue>
			</xforms:action>

 			<!-- These binding would cause the buttons to disable when the form is invalid, but it causes a problem: The user has to change focus from a form element before the form is re-validated, causing the button to appear readonly even when the form is valid. -->
			<!-- Another workaround (besides the current use of messages) might be to use xxforms:incremental, but that creates much more traffic, i.e. on every keypress. -->
			<!-- <xforms:bind nodeset="instance('ins-control')/save-permissions-trigger" readonly="not(../permissions-entry-is-valid = 'true')"/>  -->
			<!-- <xforms:bind nodeset="instance('ins-control')/save-study-trigger" readonly="not(../study-entry-is-valid = 'true')"/> -->
			<!-- <xforms:bind nodeset="instance('ins-control')/upload-file-trigger" readonly="not(../upload-is-valid = 'true')"/> -->
        	
			<xforms:bind nodeset="instance('ins-control')/add-publication-trigger" relevant="instance('ins-study-entry')/atom:content/study/study-is-published='Yes'"/>

        	<xforms:bind nodeset="instance('ins-control')/copy-answers-control" relevant="instance('ins-study-feed')[count(atom:entry)>1]"/>
        	<xforms:bind nodeset="instance('ins-control')/copy-answers-trigger" readonly="../href-to-copy-study-info-from = ''"/>
        	
        	
			<!-- TODO: ensure a file is selected before Upload is triggered -->
        	<!--  <xforms:bind nodeset="instance('ins-upload')/media" required="true()" />  -->

			<!-- Show the appropriate tabs and help-boxes depending upon the current user roles. -->
			<xforms:bind nodeset="instance('ins-control')/contributor-controls" relevant="xxforms:instance('ins-current-user')//role = 'ROLE_CHASSIS_CONTRIBUTOR' and not(xxforms:instance('ins-current-user')//role = 'ROLE_CHASSIS_CURATOR')"/>
			<xforms:bind nodeset="instance('ins-control')/curator-controls" relevant="xxforms:instance('ins-current-user')//role = 'ROLE_CHASSIS_CURATOR'"/>
			<xforms:bind nodeset="instance('ins-control')/administrator-controls" relevant="xxforms:instance('ins-current-user')//role = 'ROLE_CHASSIS_ADMINISTRATOR'"/>

			<xforms:send 
				ev:event="xforms-model-construct-done" 
				submission="sub-get-study-entry"
				if="not(empty(xxforms:get-request-parameter('study')))"/>
				
			<xforms:load 
				ev:event="xforms-model-construct-done" 
				resource="home"
				if="empty(xxforms:get-request-parameter('study'))"/>
				
				
				        	

        	
        	
        	
			<xforms:instance id="ins-study-entry">
				<atom:entry/>
			</xforms:instance>

			<!-- Check email addresses in acknowledgements (not required) -->			
			<xforms:bind nodeset="instance('ins-study-entry')/atom:content/study/acknowledgements/person/email-address" type="xforms:email"/>

			
			<xforms:submission 
				id="sub-get-study-entry"
				resource="{xxforms:get-request-parameter('study')}"
				method="get"
				replace="instance"
				instance="ins-study-entry"
				serialization="none">
                
				<xforms:action ev:event="xforms-submit-done">
					
					<xforms:send submission="sub-get-permissions-entry"/>
					
					<!-- The success of this get-submitted-media submission will trigger the copying of the media-feed to the SSQ. -->
					<xforms:send submission="sub-get-submitted-media-feed"/>

					<!-- Only try to get a curated media feed if the user can get the curated media feed. -->
					<xforms:send submission="sub-get-curated-media-feed" if="instance('ins-study-entry')/atom:link[@rel='http://www.cggh.org/2010/chassis/terms/curatedMedia' and contains(@atombeat:allow, 'GET')]"/>
					
					<!-- Get the study info, which will use a link from the retrieved study entry. -->
					<xforms:send submission="sub-get-study-info-entry"/>

					
				</xforms:action>				
				
				<xforms:message ev:event="xforms-submit-error" level="modal">An error occurred (<xforms:output value="event('error-type')"/>) while retrieving the study.</xforms:message>
				
			</xforms:submission>


			<xforms:instance id="ins-submitted-media-feed">
				<atom:feed/>
			</xforms:instance>
			
			<xforms:submission
				id="sub-get-submitted-media-feed"
				resource="{instance('ins-study-entry')/atom:link[@rel='http://www.cggh.org/2010/chassis/terms/submittedMedia']/@href}"
				method="get"
				replace="instance"
				instance="ins-submitted-media-feed"
				serialization="none">
				
				<!-- Now that we have the media feed, copy to the questionnaire. -->
				<xforms:action ev:event="xforms-submit-done">
					<xforms:insert nodeset="xxforms:instance('ins-sq-submitted-media-feed')" origin="instance('ins-submitted-media-feed')" />
				</xforms:action>
				
                <xforms:message ev:event="xforms-submit-error" level="modal">An error occurred (<xforms:output value="event('error-type')"/>) while retrieving the submitted media.</xforms:message>
			</xforms:submission>


			<xforms:instance id="ins-study-info-entry">
				<atom:entry/>
			</xforms:instance>
			
			<xforms:submission 
				id="sub-get-study-info-entry"
				resource="{instance('ins-study-entry')/atom:link[@rel='http://www.cggh.org/2010/chassis/terms/studyInfo']/@href}"
				method="get"
				replace="instance"
				instance="ins-study-info-entry"
				serialization="none">
                
				<xforms:action ev:event="xforms-submit-done">
					
					<!-- copy data across to study questionnaire model -->
					<xforms:insert nodeset="xxforms:instance('ins-sq-study-info-entry')" origin="instance('ins-study-info-entry')" />
					
				</xforms:action>				
				
				<xforms:message ev:event="xforms-submit-error" level="modal">An error occurred (<xforms:output value="event('error-type')"/>) while retrieving the study info.</xforms:message>
				
			</xforms:submission>
			


				
		    <xforms:submission
		        id="sub-put-study-entry"
		        resource="{instance('ins-study-entry')/atom:link[@rel='edit']/@href}"
		        method="put"
		        replace="instance"
		        instance="ins-study-entry"
		        ref="instance('ins-study-entry')"
		        mediatype="application/atom+xml">
		        <xforms:message ev:event="xforms-submit-error" level="modal">An error occurred (<xforms:output value="event('error-type')"/>) while saving the study.</xforms:message>
		        <xforms:message ev:event="xforms-submit-done" level="modal">Your changes have been saved.</xforms:message>
		    </xforms:submission>
        	
        	
            
            
            
			<xforms:instance id="ins-permissions-entry">
				<atom:entry/>
			</xforms:instance> 
            
        	<!-- Ensure that the current user cannot remove themselves as administrator. -->       		
			<xforms:bind nodeset="instance('ins-permissions-entry')//atombeat:groups/atombeat:group">
                <xforms:bind nodeset="atombeat:member[text()=xxforms:get-remote-user() and position() = 1]" readonly="true()"/>
            </xforms:bind>
  
            
			<xforms:submission 
				id="sub-get-permissions-entry"
				resource="{instance('ins-study-entry')/atom:link[@rel='http://purl.org/atombeat/rel/security-descriptor']/@href}"
				method="get"
				replace="instance"
				instance="ins-permissions-entry"
				serialization="none">
                <xforms:message ev:event="xforms-submit-error" level="modal">An error occurred (<xforms:output value="event('error-type')"/>) while retrieving the study.</xforms:message>
			</xforms:submission>   
            
			<xforms:submission 
				id="sub-put-permissions-entry"
				resource="{instance('ins-study-entry')/atom:link[@rel='http://purl.org/atombeat/rel/security-descriptor']/@href}"
				method="put"
				replace="instance"
				instance="ins-permissions-entry"
				ref="instance('ins-permissions-entry')"
				mediatype="application/atom+xml">
		        <xforms:message ev:event="xforms-submit-done" level="modal">Your changes have been saved.</xforms:message>
                <xforms:message ev:event="xforms-submit-error" level="modal">An error occurred (<xforms:output value="event('error-type')"/>) while retrieving the study.</xforms:message>
			</xforms:submission>
            
       		<xforms:instance id="ins-user-template">
       			<atombeat:member/>
  			</xforms:instance>
  			
  			
  			
			<!-- Require valid email addresses in the permissions field -->			
			<xforms:bind nodeset="instance('ins-permissions-entry')/atom:content/atombeat:security-descriptor/atombeat:groups/atombeat:group[@id='GROUP_ADMINISTRATORS']/atombeat:member" type="xforms:email" required="true()"/>
  			
  			
  			
  			
  			<xforms:instance id="ins-person-template" src="/apps/common/templates/study/person-template.xml"/>
  			
  			
  			<xforms:instance id="ins-publication-template" src="/apps/common/templates/study/publication-template.xml"/>
  			
        	<xforms:bind nodeset="instance('ins-study-entry')/atom:content/study/publications">

			        <xforms:bind nodeset="publication" relevant="instance('ins-study-entry')/atom:content/study/study-is-published='Yes'">
			            
			            <xforms:bind nodeset="web-link" type="xs:anyURI" required="true()"/>
			            
			        </xforms:bind>
			        
       		</xforms:bind>       
            
            
            
            
            
			<!-- This gets the list of different file types for the upload-files tab. -->
			<xforms:instance id="ins-file-terms" src="/apps/common/constants/file-terms.xml"/>           





        	
        	<xforms:instance id="ins-study-feed">
				<atom:feed/>
			</xforms:instance>

			<xforms:submission 
				id="sub-retrieve-study-feed"
				resource="/atombeat/content/studies"
				method="get"
				replace="instance"
				instance="ins-study-feed">
				<!-- TODO error handling -->
                <xforms:message ev:event="xforms-submit-error" level="modal">
                	An error occurred (<xforms:output value="event('error-type')"/>) while retrieving a list of studies.
               	</xforms:message>
			</xforms:submission>
			
			<xforms:send 
				ev:event="xforms-model-construct-done" 
				submission="sub-retrieve-study-feed"/>
			
			
			<xforms:instance id="ins-study-info-entry-to-copy-study-info-from">
				<atom:entry/>
			</xforms:instance>
				
			<xforms:submission 
				id="sub-copy-answers"
				resource="{instance('ins-control')/href-to-copy-study-info-from}"
				method="get"
				replace="instance"
				instance="ins-study-info-entry-to-copy-study-info-from">
				
				<xforms:action ev:event="xforms-submit-done">
					
					<!-- 
						Make sure we replace only the <questionnaire> element 
						and not the whole <atom:entry>, otherwise the edit link
						will be wrong and the data will get PUT to the wrong
						URL when changes are saved.
					-->
					
					<xforms:delete nodeset="xxforms:instance('ins-sq-study-info-entry')/atom:content/study-info"/>
					<xforms:insert 
						context="xxforms:instance('ins-sq-study-info-entry')/atom:content" 
						nodeset="study-info" 
						origin="instance('ins-study-info-entry-to-copy-study-info-from')/atom:content/study-info"
						at="last()" position="after" />
					
					<xforms:message level="modal">
						Answers have now been copied from "<xforms:output value="instance('ins-study-feed')/atom:entry[atom:link[@rel='http://www.cggh.org/2010/chassis/terms/studyInfo']/@href = instance('ins-control')/href-to-copy-study-info-from]/atom:title"/> (<xforms:output value="instance('ins-study-feed')/atom:entry[atom:link[@rel='http://www.cggh.org/2010/chassis/terms/studyInfo']/@href = instance('ins-control')/href-to-copy-study-info-from]/manta:id"/>)". Be sure to update any answers that differ from study "<xforms:output value="instance('ins-study-feed')/atom:entry[atom:link[@rel='http://www.cggh.org/2010/chassis/terms/studyInfo']/@href = instance('ins-control')/href-to-copy-study-info-from]/atom:title"/> (<xforms:output value="instance('ins-study-feed')/atom:entry[atom:link[@rel='http://www.cggh.org/2010/chassis/terms/studyInfo']/@href = instance('ins-control')/href-to-copy-study-info-from]/manta:id"/>)". Changes will not be saved until you click "Save changes".
					</xforms:message>
					
				</xforms:action>
				
				
                <xforms:message ev:event="xforms-submit-error" level="modal">
                	An error occurred (<xforms:output value="event('error-type')"/>) while copying answers from the selected study.
               	</xforms:message>
			</xforms:submission>				
			
			<xforms:instance id="ins-study-is-published-terms" src="/apps/common/constants/study-is-published-terms.xml"/>
				
				
				
				
				
				
			<!--+
				| New way of handling uploads, avoids the need to use an intermediate
				| servlet for handling uploads - you can post files (one at a time) 
				| directly to AtomBeat using a multipart/form-data request.
				+-->
        	
        	
        	<!-- files are uploaded one at a time, this instance holds the data to be posted -->
        	
        	<xforms:instance id="ins-upload">
        		<upload xmlns="" scheme="http://www.cggh.org/2010/chassis/scheme/FileTypes" term="" label="">
        			<summary/>
        			<category/>
        			<media xsi:type="xs:anyURI" filename="" mediatype="" size=""/>
        		</upload>
        	</xforms:instance>
        	
        	<!-- this is a fresh instance to use when clearing out the main instance after each upload -->
        	<xforms:instance id="ins-upload-empty">
        		<upload xmlns="" scheme="http://www.cggh.org/2010/chassis/scheme/FileTypes" term="" label="">
        			<summary/>
        			<category/>
        			<media xsi:type="xs:anyURI" filename="" mediatype="" size=""/>
        		</upload>
        	</xforms:instance>
        	
        	
        	
        	<!-- some bindings on the upload instance -->
        	
        	<xforms:bind nodeset="instance('ins-upload')">
        		<xforms:bind nodeset="@term" required="true()"/>
        		<xforms:bind nodeset="@label" relevant="../@term='http://www.cggh.org/2010/chassis/terms/Other'" required="../@term='http://www.cggh.org/2010/chassis/terms/Other'"/>
        		<xforms:bind nodeset="category" calculate="concat('scheme=&quot;', ../@scheme, '&quot;; term=&quot;', ../@term, '&quot;; label=&quot;', ../@label, '&quot;;')"/>
        	</xforms:bind>        	
        	
        	
        	
        	<!-- this is the submission that sends the file to atombeat ... it uses a multipart/form-data POST request, which (thankfully) both Orbeon and AtomBeat support, although this is not standard Atom Protocol ... check the http traffic to see what's being sent -->

        	<xforms:submission
        		id="sub-post-upload"
        		method="form-data-post"
        		resource="{instance('ins-study-entry')/atom:link[@rel='http://www.cggh.org/2010/chassis/terms/submittedMedia']/@href}"
        		ref="instance('ins-upload')"
        		replace="none">
        		
        		<xforms:header>
        			<xforms:name>Accept</xforms:name>
        			<xforms:value>application/atom+xml</xforms:value>
        		</xforms:header>
        		
        		<xforms:message ev:event="xforms-submit-done" level="modal">
        			Your file has been submitted. Thank you.
        		</xforms:message>
        		
        		<!-- clear out upload -->
        		<xforms:insert ev:event="xforms-submit-done" nodeset="instance('ins-upload')" origin="instance('ins-upload-empty')"/>
        		
        		<!-- refresh submitted media -->
        		<xforms:send ev:event="xforms-submit-done" submission="sub-get-submitted-media-feed"/>
        		
        		<!-- TODO error handling -->
        		<xforms:message ev:event="xforms-submit-error" level="modal">An error occurred (<xforms:output value="event('error-type')"/>) while posting a draft upload.</xforms:message>
        		
        	</xforms:submission>
        	
        	
        	<!-- For Curator -->

        	<xforms:instance id="ins-curated-media-feed">
        		<atom:feed/>
        	</xforms:instance>
        	
        	<xforms:submission
        		id="sub-get-curated-media-feed"
        		resource="{instance('ins-study-entry')/atom:link[@rel='http://www.cggh.org/2010/chassis/terms/curatedMedia']/@href}"
        		method="get"
        		replace="instance"
        		instance="ins-curated-media-feed">
        		<xforms:message ev:event="xforms-submit-error" level="modal">An error occurred (<xforms:output value="event('error-type')"/>) while retrieving the curated media.</xforms:message>
        	</xforms:submission>        	
        	
            
        </xforms:model>
        
        <xi:include href="../common/includes/study/study-info-model.xml"/>
        
        <xi:include href="../common/includes/current-user-model.xml"/>
            	
        
    </head>
    <body>
    
		<xi:include href="../common/includes/current-user-actions.xml"/>

		<div id="content" class="study-dashboard">

		<h1>Study dashboard - <xforms:output value="instance('ins-study-entry')/atom:title"/> (<xforms:output value="instance('ins-study-entry')/manta:id"/>)</h1>

		<!-- For contributor -->
		<xforms:group ref="instance('ins-control')/contributor-controls">
			<p>
				<a href="../contributor/home">&lt;&lt; Back home</a>
			</p>
		</xforms:group>
		<!-- For curator -->
		<xforms:group ref="instance('ins-control')/curator-controls">
			<p>
				<a href="../curator/home">&lt;&lt; Back home</a>
			</p>
		</xforms:group>
		<!-- For administrator -->
		<xforms:group ref="instance('ins-control')/administrator-controls">
			<p>
				<a href="../curator/home">&lt;&lt; Back home</a>
			</p>
		</xforms:group>
		
    		<div class="yui-navset yui-navset-top">
    		
    			<ul class="yui-nav">
    				<xforms:group ref="instance('ins-control')[dashboard-tab-to-show='summary']">
	    				<li class="selected">
	    					<a href="dashboard?tab=summary&amp;study={instance('ins-study-entry')/atom:link[@rel='edit']/@href}">
	    						<em>Summary</em>
	   						</a>
	    				</li>
	    			</xforms:group>
    				<xforms:group ref="instance('ins-control')[dashboard-tab-to-show!='summary']">
	    				<li>
	    					<a href="dashboard?tab=summary&amp;study={instance('ins-study-entry')/atom:link[@rel='edit']/@href}">
	    						<em>Summary</em>
	   						</a>
	    				</li>
	    			</xforms:group>
	    			
	    			<!-- If the user has GET access to the security descriptor. -->
			    	<xforms:group ref="instance('ins-study-entry')/atom:link[@rel='http://purl.org/atombeat/rel/security-descriptor' and contains(@atombeat:allow, 'GET')]">
			    		
		    			<xforms:group ref="instance('ins-control')[dashboard-tab-to-show='permissions']">
		    				<li class="selected">
		    					<a href="dashboard?tab=permissions&amp;study={instance('ins-study-entry')/atom:link[@rel='edit']/@href}">
			    					<em>Permissions</em>
		    					</a>
		   					</li>
	   					</xforms:group>
		    			<xforms:group ref="instance('ins-control')[dashboard-tab-to-show!='permissions']">
		    				<li id="permissions-tab-link-container">
		    					<a href="dashboard?tab=permissions&amp;study={instance('ins-study-entry')/atom:link[@rel='edit']/@href}">
			    					<em>Permissions</em>
		    					</a>
		   					</li>
	   					</xforms:group>
	   					
	   				</xforms:group>
   					
   					<xforms:group ref="instance('ins-control')[dashboard-tab-to-show='acknowledgements']">
	    				<li class="selected">
	    					<a href="dashboard?tab=acknowledgements&amp;study={instance('ins-study-entry')/atom:link[@rel='edit']/@href}">
		    					<em>Acknowledgements</em>
	    					</a>
	   					</li>
   					</xforms:group>
   					<xforms:group ref="instance('ins-control')[dashboard-tab-to-show!='acknowledgements']">
	    				<li id="acknowledgements-tab-link-container">
	    					<a href="dashboard?tab=acknowledgements&amp;study={instance('ins-study-entry')/atom:link[@rel='edit']/@href}">
		    					<em>Acknowledgements</em>
	    					</a>
	   					</li>
   					</xforms:group>
   					
	    			<!-- If the user has GET access to the submitted media. -->
			    	<xforms:group ref="instance('ins-study-entry')/atom:link[@rel='http://www.cggh.org/2010/chassis/terms/submittedMedia' and contains(@atombeat:allow, 'GET')]">
			    	
	   					<xforms:group ref="instance('ins-control')[dashboard-tab-to-show='files']">
		    				<li class="selected">
		    					<a href="dashboard?tab=files&amp;study={instance('ins-study-entry')/atom:link[@rel='edit']/@href}">
			    					<em>Files</em>
		    					</a>
		   					</li>
	   					</xforms:group>
	   					<xforms:group ref="instance('ins-control')[dashboard-tab-to-show!='files']">
		    				<li id="files-tab-link-container">
		    					<a href="dashboard?tab=files&amp;study={instance('ins-study-entry')/atom:link[@rel='edit']/@href}">
			    					<em>Files</em>
		    					</a>
		   					</li>
	   					</xforms:group>
	   					
	   				</xforms:group>	
   					
   					<xforms:group ref="instance('ins-control')[dashboard-tab-to-show='publications']">
	    				<li class="selected">
	    					<a href="dashboard?tab=publications&amp;study={instance('ins-study-entry')/atom:link[@rel='edit']/@href}">
		    					<em>Publications</em>
	    					</a>
	   					</li>
	   				</xforms:group>
   					<xforms:group ref="instance('ins-control')[dashboard-tab-to-show!='publications']">
	    				<li id="publications-tab-link-container">
	    					<a href="dashboard?tab=publications&amp;study={instance('ins-study-entry')/atom:link[@rel='edit']/@href}">
		    					<em>Publications</em>
	    					</a>
	   					</li>
	   				</xforms:group>
   					
   					<xforms:group ref="instance('ins-control')[dashboard-tab-to-show='study-info']">
	    				<li class="selected">
	    					<a href="dashboard?tab=study-info&amp;study={instance('ins-study-entry')/atom:link[@rel='edit']/@href}">
		    					<em>Study info</em>
	    					</a>
	   					</li>
					</xforms:group>
   					<xforms:group ref="instance('ins-control')[dashboard-tab-to-show!='study-info']">
	    				<li id="study-info-tab-link-container">
	    					<a href="dashboard?tab=study-info&amp;study={instance('ins-study-entry')/atom:link[@rel='edit']/@href}">
		    					<em>Study info</em>
	    					</a>
	   					</li>
					</xforms:group>

    			</ul>
    			
    			
    			<div class="yui-content">
    	


   					<!-- Help boxes. Comment out if not needed. -->
   					
   					<!-- For contributor -->
   					<xforms:group ref="instance('ins-control')/contributor-controls">
				    	<xforms:group ref="instance('ins-control')[dashboard-tab-to-show='summary']">
				    			<!-- <xi:include href="includes/help-boxes/for-dashboard-tabs/for-contributor/summary.xml"/>  -->
				    	</xforms:group>
				    	<xforms:group ref="instance('ins-control')[dashboard-tab-to-show='permissions']">
				    			<xi:include href="includes/help-boxes/for-dashboard-tabs/for-contributor/permissions.xml"/>
				    	</xforms:group>
				    	<xforms:group ref="instance('ins-control')[dashboard-tab-to-show='acknowledgements']">
				    			<xi:include href="includes/help-boxes/for-dashboard-tabs/for-contributor/acknowledgements.xml"/>
				    	</xforms:group>
						<xforms:group ref="instance('ins-control')[dashboard-tab-to-show='files']">
				    			<xi:include href="includes/help-boxes/for-dashboard-tabs/for-contributor/files.xml"/>
				    	</xforms:group>
				    	<xforms:group ref="instance('ins-control')[dashboard-tab-to-show='publications']">
				    			<xi:include href="includes/help-boxes/for-dashboard-tabs/for-contributor/publications.xml"/>
				    	</xforms:group>
						<xforms:group ref="instance('ins-control')[dashboard-tab-to-show='study-info']">
				    			<!-- <xi:include href="includes/help-boxes/for-dashboard-tabs/for-contributor/study-info.xml"/>  -->
				    	</xforms:group>
				    </xforms:group>
				    
					<!-- For curator -->
   					<xforms:group ref="instance('ins-control')/curator-controls">
				    	<xforms:group ref="instance('ins-control')[dashboard-tab-to-show='summary']">
				    			<!-- <xi:include href="includes/help-boxes/for-dashboard-tabs/for-curator/summary.xml"/>  -->
				    	</xforms:group>
				    	<xforms:group ref="instance('ins-control')[dashboard-tab-to-show='permissions']">
				    			<!-- <xi:include href="includes/help-boxes/for-dashboard-tabs/for-curator/permissions.xml"/> -->
				    	</xforms:group>
				    	<xforms:group ref="instance('ins-control')[dashboard-tab-to-show='acknowledgements']">
				    			<!-- <xi:include href="includes/help-boxes/for-dashboard-tabs/for-curator/acknowledgements.xml"/> -->
				    	</xforms:group>
						<xforms:group ref="instance('ins-control')[dashboard-tab-to-show='files']">
				    			<!-- <xi:include href="includes/help-boxes/for-dashboard-tabs/for-curator/files.xml"/> -->
				    	</xforms:group>
				    	<xforms:group ref="instance('ins-control')[dashboard-tab-to-show='publications']">
				    			<!-- <xi:include href="includes/help-boxes/for-dashboard-tabs/for-curator/publications.xml"/> -->
				    	</xforms:group>
						<xforms:group ref="instance('ins-control')[dashboard-tab-to-show='study-info']">
				    			<!-- <xi:include href="includes/help-boxes/for-dashboard-tabs/for-curator/study-info.xml"/>  -->
				    	</xforms:group>
				    </xforms:group>


					<!-- Tab panels -->
					
					<!-- For all roles -->
			    	<xforms:group ref="instance('ins-control')[dashboard-tab-to-show='summary']">
			    		<xi:include href="includes/dashboard-tabs/summary.xml"/>
			    	</xforms:group>		
			    	
			    	<xforms:group ref="instance('ins-control')[dashboard-tab-to-show='permissions']">
			    	
			    		<!-- If the user has GET access to the security descriptor. -->
			    		<xforms:group ref="instance('ins-study-entry')/atom:link[@rel='http://purl.org/atombeat/rel/security-descriptor' and contains(@atombeat:allow, 'GET')]">
			    			<xi:include href="includes/dashboard-tabs/permissions.xml"/>
			    		</xforms:group>
			    		
			    	</xforms:group>	

			    	<xforms:group ref="instance('ins-control')[dashboard-tab-to-show='acknowledgements']">
			    		<xi:include href="includes/dashboard-tabs/acknowledgements.xml"/>
			    	</xforms:group>	
			    	
			    	<!-- If the user has GET access to the submitted media. -->
			    	<xforms:group ref="instance('ins-study-entry')/atom:link[@rel='http://www.cggh.org/2010/chassis/terms/submittedMedia' and contains(@atombeat:allow, 'GET')]">
			    	
					    	<xforms:group ref="instance('ins-control')[dashboard-tab-to-show='files']">
					    		<xi:include href="includes/dashboard-tabs/files.xml"/>
					    	</xforms:group>	
					    	
			    	</xforms:group>

			    	<xforms:group ref="instance('ins-control')[dashboard-tab-to-show='publications']">
			    		<xi:include href="includes/dashboard-tabs/publications.xml"/>
			    	</xforms:group>	

			    	<xforms:group ref="instance('ins-control')[dashboard-tab-to-show='study-info']">
			    		<xi:include href="includes/dashboard-tabs/study-info.xml"/>
			    	</xforms:group>

    			</div>
    			
    		</div>
    		
    	</div>
    	
    	<fr:xforms-inspector xmlns:fr="http://orbeon.org/oxf/xml/form-runner"/>
    	
    </body>
</html>

