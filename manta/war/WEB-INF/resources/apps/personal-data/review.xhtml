<!--
  Copyright (C) 2010 University of Oxford.
  
  This program is free software; you can redistribute it and/or modify it under the terms of the
  GNU Lesser General Public License as published by the Free Software Foundation; either version
  2.1 of the License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
  without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  See the GNU Lesser General Public License for more details.

  The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
  -->
<html 
	xmlns:xforms="http://www.w3.org/2002/xforms"
    xmlns:f="http://orbeon.org/oxf/xml/formatting" 
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:atom="http://www.w3.org/2005/Atom"
    xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
    xmlns:xi="http://www.w3.org/2001/XInclude"
    xmlns:manta="http://www.cggh.org/2010/chassis/manta/xmlns">
    
    <head>
    
        <title>Personal Data Home</title>

        
        <xforms:model>

			<xforms:instance id="ins-media-entry">
				<atom:entry/>
			</xforms:instance>
			
			<xforms:submission 
				id="sub-get-media-entry"
				resource="{xxforms:get-request-parameter('entry')}"
				method="get"
				replace="instance"
				instance="ins-media-entry"
				ref="instance('ins-noparams')">
                <xforms:message ev:event="xforms-submit-error" level="modal">An error occurred (<xforms:output value="event('error-type')"/>) while retrieving the study.</xforms:message>
				<xforms:send ev:event="xforms-submit-done" submission="sub-get-study-entry"/>
				<xforms:setvalue 
					ev:event="xforms-submit-done"
					ref="instance('ins-review-entry')/atom:title" 
					value="concat( 'Personal Data Review of file ' , instance('ins-media-entry')/manta:id/text() )"/>
			</xforms:submission>
			
			<xforms:instance id="ins-study-entry">
				<atom:entry/>
			</xforms:instance>
			
			<xforms:submission 
				id="sub-get-study-entry"
				resource="{instance('ins-media-entry')/atom:link[@rel='http://www.cggh.org/2010/chassis/terms/originStudy']/@href}"
				method="get"
				replace="instance"
				instance="ins-study-entry"
				ref="instance('ins-noparams')">
                <xforms:message ev:event="xforms-submit-error" level="modal">An error occurred (<xforms:output value="event('error-type')"/>) while retrieving the study.</xforms:message>
			</xforms:submission>
			
			<xforms:action ev:event="xforms-model-construct-done">
			
				<xforms:send submission="sub-get-media-entry"/>

				<xforms:setvalue 
					ref="instance('ins-review-entry')/atom:link[@rel='http://www.cggh.org/2010/chassis/terms/reviewSubject']/@href" 
					value="xxforms:get-request-parameter('entry')"/>

			</xforms:action>
			
			
			<xforms:instance id="ins-noparams">
				<params xmlns=""/>
			</xforms:instance>
			
			<xforms:instance id="ins-review-entry">
				<atom:entry>
					<atom:title type="text"></atom:title>
					<atom:link rel="http://www.cggh.org/2010/chassis/terms/reviewSubject" href="" type="application/atom+xml"/>
					<atom:content type="application/vnd.chassis-manta+xml">
						<review xmlns="">
							<outcome></outcome>
						</review>
					</atom:content>
				</atom:entry>
			</xforms:instance>
			
			<xforms:submission 
				id="sub-post-review"
				method="post"
				resource="{instance('ins-study-entry')/atom:link[@rel='http://www.cggh.org/2010/chassis/terms/personalDataReviews']/@href}"
				ref="instance('ins-review-entry')"
				replace="instance"
				instance="ins-review-entry"
				mediatype="application/atom+xml"
			>
                <xforms:message ev:event="xforms-submit-error" level="modal">An error occurred (<xforms:output value="event('error-type')"/>) while retrieving the study.</xforms:message>
                <xforms:send ev:event="xforms-submit-done" submission="sub-get-home"/>
			</xforms:submission>

			<xforms:submission
				id="sub-get-home"
				method="get"
				resource="home"
				replace="all"
				ref="instance('ins-noparams')"/>
				
        </xforms:model>

       	<xi:include href="/apps/common/includes/current-user-xforms-model.xml"/>

    </head>
    <body>

		<xi:include href="/apps/common/includes/current-user-actions.xml"/>
    
	    	<h1>Personal Data - Review File</h1>
	    	
	    	<xforms:group ref="instance('ins-media-entry')">
	    	
		    	<p>
		    		Code: <xforms:output value="manta:id"/>
		    	</p>
		    	<p>
		    		Original File Name: <xforms:output value="atom:title"/>
		    	</p>
		    	<p>
		    		Contributor: <xforms:output value="atom:author/atom:email"/> 
		    	</p>
		    	<p>
		    		Study: <xforms:output value="instance('ins-study-entry')/atom:title"/>
		    	</p>
		    	<p>
		    		<a href="{atom:content/@src}">download file</a>
		    	</p>
		    	
		    	<p>
		    		<xforms:select1 ref="instance('ins-review-entry')//outcome">
		    			<xforms:label>Review outcome: </xforms:label>
		    			<xforms:item>
		    				<xforms:label>please select</xforms:label>
		    				<xforms:value/>
		    			</xforms:item>
		    			<xforms:item>
		    				<xforms:label>file contains personal data to be removed</xforms:label>
		    				<xforms:value>fail</xforms:value>
		    			</xforms:item>
		    			<xforms:item>
		    				<xforms:label>file can proceed to curation</xforms:label>
		    				<xforms:value>pass</xforms:value>
		    			</xforms:item>
		    		</xforms:select1>
		    	</p>
		    	
		    	<p>
		    		<xforms:submit submission="sub-post-review">
		    			<xforms:label>Submit Review</xforms:label>
		    		</xforms:submit>
		    	</p>

	    	</xforms:group>

    </body>
</html>

