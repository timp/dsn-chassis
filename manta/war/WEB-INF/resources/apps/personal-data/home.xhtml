<!--
  Copyright (C) 2010 University of Oxford.
  
  This program is free software; you can redistribute it and/or modify it under the terms of the
  GNU Lesser General Public License as published by the Free Software Foundation; either version
  2.1 of the License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
  without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  See the GNU Lesser General Public License for more details.

  The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
  -->
<?oxygen NVDLSchema="../../../../../oxygen/samples/nvdl/xhtml-xforms-11-orbeon.nvdl"?>
<html 
	xmlns:xforms="http://www.w3.org/2002/xforms"
    xmlns:f="http://orbeon.org/oxf/xml/formatting" 
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:atom="http://www.w3.org/2005/Atom"
    xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
    xmlns:xi="http://www.w3.org/2001/XInclude"
    xmlns:manta="http://www.cggh.org/2010/chassis/manta/xmlns">
    
    <head>
    
        <title>Personal Data - Home</title>

        
        <xforms:model id="mod-main">

			<xforms:submission 
				id="sub-get-studies-feed"
				resource="/atombeat/content/studies"
				method="get"
				replace="instance"
				instance="ins-studies-feed"
				serialization="none">
				<!-- TODO error handling -->
                <xforms:message ev:event="xforms-submit-error" level="modal">
                	An error occurred (<xforms:output value="event('error-type')"/>) while retrieving studies.
               	</xforms:message>
               	<xforms:send ev:event="xforms-submit-done" submission="sub-get-all-reviews-feed"/>
			</xforms:submission>

			<xforms:submission 
				id="sub-get-all-reviews-feed"
				resource="/atombeat/content/reviews/personal-data"
				method="get"
				replace="instance"
				instance="ins-reviews-feed"
				serialization="none">
				<!-- TODO error handling -->
                <xforms:message ev:event="xforms-submit-error" level="modal">
                	An error occurred (<xforms:output value="event('error-type')"/>) while retrieving reviews.
               	</xforms:message>
               	<xforms:send ev:event="xforms-submit-done" submission="sub-get-all-derivations-feed"/>
			</xforms:submission>
        	
        	<xforms:submission id="sub-get-all-derivations-feed" resource="/atombeat/content/derivations" method="get" replace="instance" instance="ins-derivations-feed" serialization="none">
        		<xforms:message ev:event="xforms-submit-error" level="modal">
        			An error occurred (<xforms:output value="event('error-type')"/>) while retrieving derivations.
        		</xforms:message>
        		<xforms:send ev:event="xforms-submit-done" submission="sub-get-all-submitted-media-feed"/>
        	</xforms:submission>
			
			<xforms:submission 
				id="sub-get-all-submitted-media-feed"
				resource="/atombeat/content/media/submitted"
				method="get"
				replace="instance"
				instance="ins-submitted-media-feed" 
				serialization="none">
				<!-- TODO error handling -->
                <xforms:message ev:event="xforms-submit-error" level="modal">
                	An error occurred (<xforms:output value="event('error-type')"/>) while retrieving submitted media.
               	</xforms:message>
			</xforms:submission>
			
			<xforms:action ev:event="xforms-model-construct-done">
	        	<xforms:send submission="sub-get-studies-feed"/>
			</xforms:action>
				
			<xforms:instance id="ins-studies-feed">
				<atom:feed/>
			</xforms:instance>
			
			<xforms:instance id="ins-submitted-media-feed">
				<atom:feed/>
			</xforms:instance>
			
			<xforms:instance id="ins-reviews-feed">
				<atom:feed/>
			</xforms:instance>
        	
        	<xforms:instance id="ins-derivations-feed">
        		<atom:feed/>
        	</xforms:instance>
			
        </xforms:model>

       	<xi:include href="../common/includes/current-user-xforms-model.xml"/>

    </head>
    <body>

		<xi:include href="../common/includes/current-user-actions.xml"/>
    
    	<xforms:output ref="atom:published" xxforms:format="format-dateTime(., '[Y0001]-[M01]-[D01]')"/>
    	
    	<h1>Personal Data - Home</h1>

    	<h2>Files to Review</h2>

    	<fr:datatable>
    		<thead>
    			<tr>
    				<th fr:sortable="false" fr:resizeable="true">Code</th>
    				<th fr:sortable="false" fr:resizeable="true">Original File Name</th>
    				<th fr:sortable="true" fr:resizeable="true">Contributor</th>
    				<th fr:sortable="true" fr:resizeable="true">Submitted</th>
    				<th fr:sortable="false" fr:resizeable="true">Actions</th>
    			</tr>
    		</thead>
    		<tbody>
    			<xforms:repeat nodeset="
    				for $entry in instance('ins-submitted-media-feed')/atom:entry return
		    			if ( 
		    				empty( 
		    					instance('ins-reviews-feed')/atom:entry
		    						[ atom:link[@rel='http://www.cggh.org/2010/chassis/terms/reviewSubject']/@href = $entry/atom:link[@rel='edit']/@href ] 
	   						) 
						) then $entry else ()
				">
    				<tr>
    					<td>
    						<xforms:output value="manta:id"/>
    					</td>
    					<td>
    						<xforms:output value="atom:title"/>
    					</td>
    					<td>
    						<xforms:output value="atom:author/atom:email"/>
    					</td>
    					<td>
    						<xforms:output ref="atom:published" xxforms:format="format-dateTime(., '[Y0001]-[M01]-[D01]')"/>
    					</td>
    					<td>
    						<a href="review?media-link={atom:link[@rel='edit']/@href}">Review</a>
    					</td>
    				</tr>
    			</xforms:repeat>
    		</tbody>
    	</fr:datatable>
		    	
    	<h2>Files With Personal Data</h2>
    	
    	<fr:datatable>
    		<thead>
    			<tr>
    				<th fr:sortable="false" fr:resizeable="true">Code</th>
    				<th fr:sortable="true" fr:resizeable="true">Original File Name</th>
    				<th fr:sortable="true" fr:resizeable="true">Contributor</th>
    				<th fr:sortable="true" fr:resizeable="true">Submitted</th>
    				<th fr:sortable="false" fr:resizeable="true">Actions</th>
    			</tr>
    		</thead>
    		<tbody>
    			<xforms:repeat 
    				id="rep-submitted-media"
    				nodeset="
	    				for $entry in instance('ins-submitted-media-feed')/atom:entry return
			    			if ( 
			    				exists( 
			    					instance('ins-reviews-feed')/atom:entry[ 
		    							atom:link[@rel='http://www.cggh.org/2010/chassis/terms/reviewSubject']/@href = $entry/atom:link[@rel='edit']/@href 
		    							and .//outcome='fail'
	    							]     							
		   						) 
		   						and empty(
			   						instance('ins-derivations-feed')/atom:entry[
			   							atom:link[@rel='http://www.cggh.org/2010/chassis/terms/derivationInput']/@href = $entry/atom:link[@rel='edit']/@href	
		   							]
		   						)
							) then $entry else ()
	    			">
    				<tr>
    					<td>
    						<xforms:output value="manta:id"/>
    					</td>
    					<td>
    						<xforms:output value="atom:title"/>
    					</td>
    					<td>
    						<xforms:output value="atom:author/atom:email"/>
    					</td>
    					<td>
    						<xforms:output 
    							ref="atom:published" 
    							xxforms:format="format-dateTime(., '[Y0001]-[M01]-[D01]')"/>
    					</td>
    					<td>
    						<!-- action only available to curators -->
    						<xforms:group model="mod-current-user" ref="instance('ins-current-user')[roles/role='ROLE_CHASSIS_CURATOR']">
   								<a href="replace?media-link={xxforms:context('rep-submitted-media')/atom:link[@rel='edit']/@href}">Replace</a><br/>
    						</xforms:group>
    					</td>
    				</tr>
    			</xforms:repeat>
    		</tbody>
    	</fr:datatable>
		    			    	
    </body>
</html>

