<!--
  Copyright (C) 2010 University of Oxford.
  
  This program is free software; you can redistribute it and/or modify it under the terms of the
  GNU Lesser General Public License as published by the Free Software Foundation; either version
  2.1 of the License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
  without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  See the GNU Lesser General Public License for more details.

  The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
  -->
<html 
	xmlns:xforms="http://www.w3.org/2002/xforms"
    xmlns:f="http://orbeon.org/oxf/xml/formatting" 
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:atom="http://www.w3.org/2005/Atom"
    xmlns:xi="http://www.w3.org/2001/XInclude"
    xmlns:manta="http://www.cggh.org/2010/chassis/manta/xmlns"
    xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:atombeat="http://purl.org/atombeat/xmlns">

    <head>
    
        <title>Register Study</title>
        
        <xforms:model>

           <!-- This keeps application state variables, such as where to go after hitting next (saves having a different submission (success response) for each button) -->
           <!-- It shouldn't be saved in the draft-entry. -->
           <!-- Thought about providing a default fallback pane here, but it should really be specified in context during the application and a default would mask an error. -->
           <!-- Similarly, the value for the first wizard-pane-to-show is dependent on whether a draft is available, so should not default here. -->
       		<xforms:instance id="ins-control">
                <control xmlns="">
                	<fallback-wizard-pane/>
                	<!-- Note that the wizard is not driven by the wizard-pane-to-show in the draft-entry, but the wizard-pane-to-show in the control -->
                	<!-- The draft-entry should be changed first, and then on a successful attempt to submit the draft, the control element will then be updated. -->
                	<!-- It was decided to change to this method, rather than driving from the draft-entry, because a failure to post or put the draft-entry will cause a screen blip on slow machines. -->
                	<wizard-pane-to-show/>
                	<draft-entry-is-valid/>
                	<create-draft-trigger/>
                	<save-draft-trigger/>
                	<add-publication-trigger/>
                	<show-draft-saved-message/>
                	<draft-is-saved/>
                </control>
            </xforms:instance>    
            
            <xforms:setvalue
				ev:event="xforms-model-construct-done" 
				ref="instance('ins-control')/wizard-pane-to-show" 
				value="'study-terms'"
				if="empty(xxforms:get-request-parameter('draft'))"/>
            
			<xforms:action ev:event="xxforms-invalid" ev:observer="ins-draft-entry">
				<xforms:setvalue ev:event="xforms-value-changed" ref="instance('ins-control')/draft-entry-is-valid">false</xforms:setvalue>
			</xforms:action>
			<xforms:action ev:event="xxforms-valid" ev:observer="ins-draft-entry">
				<xforms:setvalue ev:event="xforms-value-changed" ref="instance('ins-control')/draft-entry-is-valid">true</xforms:setvalue>
			</xforms:action>
            
            <!-- TODO: Why doesn't this work? -->
            <!-- 
            <xforms:action ev:event="xforms-value-changed" ev:observer="ins-draft-entry">
            	<xforms:setvalue ref="instance('ins-control')/draft-is-saved">false</xforms:setvalue>
            </xforms:action>
             -->
            
            <xforms:bind nodeset="instance('ins-control')/create-draft-trigger" readonly="not(../draft-entry-is-valid = 'true')"/>
            <xforms:bind nodeset="instance('ins-control')/create-draft-trigger" relevant="not(instance('ins-draft-entry')/atom:link[@rel='edit'])"/>
			<xforms:bind nodeset="instance('ins-control')/save-draft-trigger" readonly="not(../draft-entry-is-valid = 'true')"/>
			<xforms:bind nodeset="instance('ins-control')/add-publication-trigger" relevant="instance('ins-draft-entry')/atom:content/draft/study-entry-container/atom:entry/atom:content/study/study-is-published='true'"/>
			<xforms:bind nodeset="instance('ins-control')/show-draft-saved-message" relevant="instance('ins-control')[draft-is-saved='true']"/>
			
			
			

        	<!-- xincludes don't parse within instance sources. -->
        	<!--   <xforms:instance id="ins-draft-entry" src="/apps/contributor/includes/model-instances/draft-entry.xml"/> -->
        	<!--  The temptation is to factor out instances to centralised file sources, but then you can't put includes in them. -->
        	<!-- This is used to store a draft during the wizard, and the default values here also acts like a template. -->
			<xforms:instance id="ins-draft-entry">
       			<atom:entry xmlns:atom="http://www.w3.org/2005/Atom">
       				<atom:title type="text" />
       				<atom:content type="application/vnd.chassis-manta+xml">
			        	<draft xmlns="">
							<wizard-pane-to-show>study-terms</wizard-pane-to-show>
							<registrant-has-agreed-to-the-terms/>
							<study-entry-container>
								<!-- TODO: need to clean the original -->
								<xi:include href="/apps/common/templates/study/clean-study-entry-template.xml" xxi:omit-xml-base="true"/>
							</study-entry-container>
							<permissions-entry-container>
								<xi:include href="/apps/contributor/includes/permissions-entry.xml" xxi:omit-xml-base="true"/>
							</permissions-entry-container>
							<uploads-entry-container>
								<xi:include href="/apps/contributor/includes/uploads-entry-template.xml" xxi:omit-xml-base="true"/>
							</uploads-entry-container>
						</draft>
        			</atom:content>
       			</atom:entry>
        	</xforms:instance>    
 
 			<!-- user template for adding a new administrator in the permissions pane -->
       		<xforms:instance id="ins-user-template">
       			<atombeat:member/>
  			</xforms:instance>

			<!-- This adds the current user as an administrator to the ACL in the draft.  -->
			<xforms:action ev:event="xforms-model-construct-done">
           		<xforms:setvalue ref="instance('ins-draft-entry')//permissions-entry-container//atombeat:security-descriptor/atombeat:groups/atombeat:group[@id='GROUP_ADMINISTRATORS']/atombeat:member" value="xxforms:get-remote-user()"/>
			</xforms:action>

			<!-- person template for adding a new acknowledgement (used to add the current user and add more in the acknowledgement pane) -->
			<xforms:instance id="ins-person-template" src="/apps/common/templates/study/person-template.xml"/>

			<!-- This adds the current user (email) to the acknowledgements in the draft. -->
			<xforms:action ev:event="xforms-model-construct-done">
				<xforms:insert 
					context="instance('ins-draft-entry')/atom:content/draft/study-entry-container/atom:entry/atom:content/study/acknowledgements" 
					nodeset="person"
					at="1"
					position="after"
					origin="instance('ins-person-template')"/>
				<xforms:setvalue 
					ref="instance('ins-draft-entry')/atom:content/draft/study-entry-container/atom:entry/atom:content/study/acknowledgements/person[1]/email-address"
					value="xxforms:get-remote-user()"/>
			</xforms:action>

				
			<xforms:bind nodeset="instance('ins-draft-entry')/atom:content/draft/uploads-entry-container/atom:entry/atom:content/uploads">
				<xforms:bind nodeset="@target" calculate="instance('ins-study-entry')/atom:link[@rel='http://www.cggh.org/2010/chassis/terms/submittedMedia']/@href"/>
				<xforms:bind nodeset="upload">
					<xforms:bind nodeset="@typeterm" required="true()"/>
					<xforms:bind nodeset="@typelabel" relevant="../@typeterm='http://www.cggh.org/2010/chassis/terms/Other'"/>
				</xforms:bind>
			</xforms:bind>

			<xforms:instance id="ins-upload-template">
				<upload
					xmlns=""
					filename=""
					mediatype=""
					size=""
					typeterm=""
					typelabel=""
					xsi:type="xs:anyURI"></upload>
			</xforms:instance>
			
			
			

       		<xforms:instance id="ins-publication-template" src="/apps/common/templates/study/publication-template.xml"/>

        	<xforms:bind nodeset="instance('ins-draft-entry')/atom:content/draft/study-entry-container/atom:entry/atom:content/study/publications">

			        <xforms:bind nodeset="publication" relevant="instance('ins-draft-entry')/atom:content/draft/study-entry-container/atom:entry/atom:content/study/study-is-published='true'">
			            
			            <xforms:bind nodeset="title" required="true()"/>
			            <xforms:bind nodeset="first-author" required="true()"/>
			            <xforms:bind nodeset="status" required="true()"/>
			            <xforms:bind nodeset="year"/>
			            <xforms:bind nodeset="journal"/>
			            <xforms:bind nodeset="url"/>
			            <xforms:bind nodeset="doi"/>
			            <xforms:bind nodeset="pubmed-id"/>
			            
			        </xforms:bind>
			        
       		</xforms:bind>




			<!-- Try to get the saved draft when the model has been constructed, if there is a draft parameter. -->
			<xforms:send 
				ev:event="xforms-model-construct-done" 
				submission="sub-get-draft-entry" 
				if="not(empty(xxforms:get-request-parameter('draft')))"/>

			<!-- With this, the get will not generate a validation-error when the instance is replaced. -->
        	<xforms:instance id="ins-noparams">
        		<params xmlns=""/>
        	</xforms:instance>

			<!-- This tries to get the current draft (by request-parameter). -->
			<xforms:submission 
				id="sub-get-draft-entry"
				action="{xxforms:get-request-parameter('draft')}"
				method="get"
				replace="instance"
				instance="ins-draft-entry"
				ref="instance('ins-noparams')">
				
				<xforms:setvalue ev:event="xforms-submit-done" ref="instance('ins-control')/wizard-pane-to-show" value="instance('ins-draft-entry')/atom:content/draft/wizard-pane-to-show"  />
				
                <!-- If not available (error) then reloads with no request param. -->
                <!-- Note that this behaviour will depend on the if-param-condition in the send to prevent an endless loop. -->
                <xforms:load ev:event="xforms-submit-error" resource="register-study-wizard"/>
                     
			</xforms:submission>  
			



			<!-- This creates a new draft (using the current draft-entry) and stores the returned entry in the draft-entry instance. -->
			<!-- If successful, it reloads the page with the appropriate URL (for book-marking). -->
            <xforms:submission 
            	id="sub-post-draft-entry" 
            	ref="instance('ins-draft-entry')"
                resource="/atombeat/content/drafts"
                method="post" 
                replace="instance" 
                instance="ins-draft-entry"
                mediatype="application/atom+xml">
                
                
                <!-- If there was no error, then reload with the draft reference in the URL. -->
                <xforms:load ev:event="xforms-submit-done" resource="register-study-wizard?draft={instance('ins-draft-entry')/atom:link[@rel='self']/@href}"/>

				<!-- If there was an error, then go back to the fallback-wizard-pane and show the error. -->
				<xforms:setvalue ev:event="xforms-submit-error" ref="instance('ins-draft-entry')/atom:content/draft/wizard-pane-to-show" value="instance('ins-control')/fallback-wizard-pane"  />
				<xforms:message ev:event="xforms-submit-error" level="modal">An error occurred (<xforms:output value="event('error-type')"/>) while creating a new draft.</xforms:message>
                         
            </xforms:submission>

            
           

			<!-- This will put the draft-entry to the edit link href. -->
            <xforms:submission 
            	id="sub-put-draft-entry" 
            	ref="instance('ins-draft-entry')"
                resource="{instance('ins-draft-entry')/atom:link[@rel='edit']/@href}"
                method="put" 
                replace="instance" 
                instance="ins-draft-entry"
                mediatype="application/atom+xml"> 
                
                <xforms:setvalue ev:event="xforms-submit-done" ref="instance('ins-control')/draft-is-saved">true</xforms:setvalue>
                <xforms:setvalue ev:event="xforms-submit-done" ref="instance('ins-control')/wizard-pane-to-show" value="instance('ins-draft-entry')/atom:content/draft/wizard-pane-to-show"  />
                
                <xforms:setvalue ev:event="xforms-submit-error" ref="instance('ins-control')/draft-is-saved">false</xforms:setvalue>
                <xforms:message ev:event="xforms-submit-error" level="modal">An error occurred (<xforms:output value="event('error-type')"/>) while saving the draft.</xforms:message>
                <xforms:setvalue ev:event="xforms-submit-error" ref="instance('ins-draft-entry')/atom:content/draft/wizard-pane-to-show" value="instance('ins-control')/fallback-wizard-pane"/>
                                
            </xforms:submission>





        
    	
        

        	<!-- bindings for the study-terms pane -->
			<xforms:bind nodeset="instance('ins-draft-entry')/atom:content/draft/registrant-has-agreed-to-the-terms" required="true()"/>
			<xforms:bind nodeset="instance('ins-draft-entry')/atom:content/draft/study-entry-container/atom:entry/atom:title" required="true()"/>


			<!-- This prevents the first user (current user) from removing themselves as an administrator from the ACL in the draft. -->

			<xforms:bind nodeset="instance('ins-draft-entry')//permissions-entry-container//atombeat:security-descriptor/atombeat:groups/atombeat:group[@id='GROUP_ADMINISTRATORS']">
                <xforms:bind nodeset="user[1]" readonly="true()" />
            </xforms:bind>



			<!-- This gets the list of different file types for the upload-files pane. -->
			<xforms:instance id="ins-file-terms" src="/apps/common/constants/file-terms.xml"/>

            <!-- This stores the local references to the files in the draft. -->
            <!-- TODO: Does this need encoding="multipart/form-data" ? -->
            <xforms:submission 
            	id="sub-post-background-uploads" 
            	ref="instance('ins-draft-entry')/atom:content/draft/uploads-entry-container/atom:entry/atom:content/uploads" 
            	method="post"
            	replace="none"
            	resource="test:"
            	validate="false"/>


			<!-- This stores the study entry once it has been posted -->
			<xforms:instance id="ins-study-entry">
				<atom:entry/>
			</xforms:instance>

            <xforms:submission 
            	id="sub-post-contribution" 
            	ref="instance('ins-draft-entry')/atom:content/draft/study-entry-container/atom:entry"
                resource="/atombeat/content/studies"
                method="post" 
                replace="instance" 
                instance="ins-study-entry"
                mediatype="application/atom+xml">
                
                
                <!-- If done, then post the permissions. -->
                <xforms:send ev:event="xforms-submit-done" submission="sub-put-permissions"/>
                
				<!-- If there was an error, then go back to the fallback-wizard-pane and show the error. -->
				<xforms:setvalue ev:event="xforms-submit-error" ref="instance('ins-draft-entry')/atom:content/draft/wizard-pane-to-show" value="instance('ins-control')/fallback-wizard-pane"  />
				<xforms:message ev:event="xforms-submit-error" level="modal">An error occurred (<xforms:output value="event('error-type')"/>) while creating a new study.</xforms:message>
                         
            </xforms:submission>

			<!-- This puts (updates) the permission list to the study's security descriptor link href. -->
            <xforms:submission 
            	id="sub-put-permissions" 
            	ref="instance('ins-draft-entry')/atom:content/draft/permissions-entry-container/atom:entry"
                resource="{instance('ins-study-entry')/atom:link[@rel='http://purl.org/atombeat/rel/security-descriptor']/@href}"
                method="put" 
                replace="none" 
                mediatype="application/atom+xml">
                
                
                <!-- If done, then post the uploads. -->
                <!-- The target is already copied to the uploads attribute using a bind calculation. -->
                <xforms:action ev:event="xforms-submit-done">
                	<xforms:send submission="sub-post-uploads"/>
                </xforms:action>
                
				<!-- If error, then go back to the fallback-wizard-pane and show the error. -->
				<xforms:setvalue ev:event="xforms-submit-error" ref="instance('ins-draft-entry')/atom:content/draft/wizard-pane-to-show" value="instance('ins-control')/fallback-wizard-pane"  />
				<xforms:message ev:event="xforms-submit-error" level="modal">An error occurred (<xforms:output value="event('error-type')"/>) while applying the permissions.</xforms:message>
                         
            </xforms:submission>

            
            <xforms:submission 
            	id="sub-post-uploads" 
            	ref="instance('ins-draft-entry')/atom:content/draft/uploads-entry-container/atom:entry/atom:content/uploads"
                resource="/util/store-uploads"
                method="post" 
                replace="none">
				
				<!-- If done, then delete the draft. -->
                <xforms:send ev:event="xforms-submit-done" submission="sub-delete-draft"/>

				<!-- If error, then go back to the fallback-wizard-pane and show the error. -->
				<xforms:setvalue ev:event="xforms-submit-error" ref="instance('ins-draft-entry')/atom:content/draft/wizard-pane-to-show" value="instance('ins-control')/fallback-wizard-pane"/>
				<xforms:message ev:event="xforms-submit-error" level="modal">An error occurred (<xforms:output value="event('error-type')"/>) while storing the files.</xforms:message>
                         
            </xforms:submission>
            
            <xforms:submission 
            	id="sub-delete-draft"  
            	method="delete"
            	replace="none"
            	action="{instance('ins-draft-entry')/atom:link[@rel='edit']/@href}">
            	
            	<xforms:setvalue ev:event="xforms-submit-done" ref="instance('ins-control')/wizard-pane-to-show" value="instance('ins-draft-entry')/atom:content/draft/wizard-pane-to-show" />
            	
            	<xforms:message ev:event="xforms-submit-error" level="modal">An error occurred (<xforms:output value="event('error-type')"/>) while deleting the draft.</xforms:message>       
            	
            </xforms:submission>

        </xforms:model>

       	<!-- <xi:include href="/apps/common/includes/study/questionnaire-xforms-model.xml"/> -->
       	<!-- <xi:include href="/apps/common/includes/current-user-xforms-model.xml"/> -->

        
    </head>
    
    <body>
    
		<!-- <xi:include href="/apps/common/includes/current-user-actions.xml"/>
		 -->

	    	<h1>Register Study</h1>

			<!-- Help boxes for wizard panes -->
			<!--  -->
	    	<xforms:group ref="instance('ins-control')[wizard-pane-to-show='study-terms']">
	    		<xi:include href="/apps/contributor/includes/help-boxes/for-wizard-panes/study-terms.xml"/>
	    	</xforms:group>
	    	<xforms:group ref="instance('ins-control')[wizard-pane-to-show='permissions']">
	    		<xi:include href="/apps/contributor/includes/help-boxes/for-wizard-panes/permissions.xml"/>
	    	</xforms:group>
	    	<xforms:group ref="instance('ins-control')[wizard-pane-to-show='acknowledgements']">
	    		<xi:include href="/apps/contributor/includes/help-boxes/for-wizard-panes/acknowledgements.xml"/>
	    	</xforms:group>
	    	<xforms:group ref="instance('ins-control')[wizard-pane-to-show='upload-files']">
	    		<xi:include href="/apps/contributor/includes/help-boxes/for-wizard-panes/upload-files.xml"/>
	    	</xforms:group>
	    	<xforms:group ref="instance('ins-control')[wizard-pane-to-show='publications']">
	    		<xi:include href="/apps/contributor/includes/help-boxes/for-wizard-panes/publications.xml"/>
	    	</xforms:group>
	    	<xforms:group ref="instance('ins-control')[wizard-pane-to-show='review']">
	    		<xi:include href="/apps/contributor/includes/help-boxes/for-wizard-panes/review.xml"/>
	    	</xforms:group>
	    	<xforms:group ref="instance('ins-control')[wizard-pane-to-show='confirmation']">
	    		<xi:include href="/apps/contributor/includes/help-boxes/for-wizard-panes/confirmation.xml"/>
	    	</xforms:group>

		   	<xforms:group ref="instance('ins-control')[draft-is-saved='true']">
			   	<xforms:group ref="instance('ins-control')[show-draft-saved-message='yes']">
		    		<p>A draft has been saved.</p>
		    	</xforms:group>
	    	</xforms:group>
	    	
	    	<xforms:group ref="instance('ins-control')[wizard-pane-to-show='study-terms']">
	    		<xi:include href="/apps/contributor/includes/wizard-panes/study-terms.xml"/>
	    	</xforms:group>
	    	
	    	<xforms:group ref="instance('ins-control')[wizard-pane-to-show='permissions']">
	    		<xi:include href="/apps/contributor/includes/wizard-panes/permissions.xml"/>
	    	</xforms:group>
	    	
	    	<xforms:group ref="instance('ins-control')[wizard-pane-to-show='acknowledgements']">
	    		<xi:include href="/apps/contributor/includes/wizard-panes/acknowledgements.xml"/>
	    	</xforms:group>
	    	
	    	<xforms:group ref="instance('ins-control')[wizard-pane-to-show='upload-files']">
	    		<xi:include href="/apps/contributor/includes/wizard-panes/upload-files.xml"/>
	    	</xforms:group>
	    	
	    	<xforms:group ref="instance('ins-control')[wizard-pane-to-show='publications']">
	    		<xi:include href="/apps/contributor/includes/wizard-panes/publications.xml"/>
	    	</xforms:group>
	    	
	    	<xforms:group ref="instance('ins-control')[wizard-pane-to-show='review']">
	    		<xi:include href="/apps/contributor/includes/wizard-panes/review.xml"/>
	    	</xforms:group>
	    	
	    	<xforms:group ref="instance('ins-control')[wizard-pane-to-show='confirmation']">
	    		<xi:include href="/apps/contributor/includes/wizard-panes/confirmation.xml"/>
	    	</xforms:group>

    </body>
    
</html>

