<?oxygen NVDLSchema="../../../../../../../oxygen/samples/nvdl/xhtml-xforms-11-orbeon.nvdl"?>
<div 
	xmlns="http://www.w3.org/1999/xhtml" 
	xmlns:xforms="http://www.w3.org/2002/xforms" 
	xmlns:ev="http://www.w3.org/2001/xml-events"
	xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
	xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
	xmlns:atombeat="http://purl.org/atombeat/xmlns">
	
	<h2>Submit a File</h2>

	<p>
		<xforms:upload ref="instance('ins-upload')/media">
			<xforms:label>File: </xforms:label>
			<xforms:filename ref="@filename"/>
			<xforms:mediatype ref="@mediatype"/>
			<xxforms:size ref="@size"/>
			<!-- uncomment line below to automatically post upload on file select -->
			<!--			<xforms:send ev:event="xforms-select" submission="sub-post-upload"/>-->
		</xforms:upload>
		
	</p>
	
	<p>	
		<xforms:select1 ref="instance('ins-upload')/@term">
			<xforms:label>Type:</xforms:label>
			<xforms:item>
				<xforms:label>Select...</xforms:label>
				<xforms:value></xforms:value>
			</xforms:item>
			<xforms:itemset nodeset="instance('ins-file-terms')/term">
				<xforms:label ref="label"/>
				<xforms:value ref="value"/>
			</xforms:itemset>
			<xforms:alert>Please select a file type.</xforms:alert>
		</xforms:select1>
		
		<xforms:input ref="instance('ins-upload')/@label">
			<xforms:label>Other Type:</xforms:label>
			<xforms:alert>Please enter the type of file.</xforms:alert>
		</xforms:input>
		
	</p>
	
	<p>
		<xforms:trigger ref="instance('ins-control')/upload-file-trigger">
			<xforms:label>Upload</xforms:label>
			<xforms:send ev:event="DOMActivate" submission="sub-post-upload"/>
		</xforms:trigger>
	</p>
	
	
	
	
			<h2>Submitted Files</h2>
    		
    		<xforms:group ref="instance('ins-submitted-media-feed')[empty(atom:entry)]">
    			<p>You have not submitted any files.</p>
    		</xforms:group>
    		
    		<xforms:group ref="instance('ins-submitted-media-feed')[exists(atom:entry)]">
    		
			    	<fr:datatable paginated="false">
			    		<thead>
			    			<tr>
			    				<th fr:sortable="true" fr:resizeable="true">Code</th>
			    				<th fr:sortable="true" fr:resizeable="true">File Name</th>
			    				<th fr:sortable="true" fr:resizeable="true">Date Submitted</th>
			    				<th fr:sortable="true" fr:resizeable="true">Submitted By</th>
			    				<th fr:sortable="true" fr:resizeable="true">Type</th>
			    				<th>Actions</th>
			    			</tr>
			    		</thead>
			    		<tbody>
			    			<xforms:repeat id="rep-media" nodeset="xxforms:sort(instance('ins-submitted-media-feed')/atom:entry, atom:published, 'text', 'ascending')">
			    				<tr>
			    					<td>
			    						<xforms:output ref="manta:id"/>
			    					</td>
			    					<td>
			    						<xforms:output ref="atom:title"/>
			    					</td>
			    					<td>
			    						<xforms:output ref="atom:published" xxforms:format="format-dateTime(., '[Y0001]-[M01]-[D01]')"/>
			    					</td>
			    					<td>
			    						<xforms:output ref="atom:author/atom:email"/>
			    					</td>
			    					<td>
			    						<xforms:output ref="
			    							for $cat in (./atom:category[@scheme='http://www.cggh.org/2010/chassis/scheme/FileTypes'])
			    							return
			    							if ( $cat/@term = 'http://www.cggh.org/2010/chassis/terms/Other' )
			    							then $cat/@label
			    							else instance('ins-file-terms')/term[value=$cat/@term]/label
			    							"/>
			    						
			    					</td>
			    					<!-- TODO: Only enable if the file has passed personal data review. -->
			    					<td>
			    						<xforms:group ref=".[contains( ./atom:link[@rel='edit-media']/@atombeat:allow , 'GET' )]">
			    							<a href="{atom:content/@src}">Download</a>
			    						</xforms:group>
			    					</td>
			    				</tr>
			    			</xforms:repeat>
			    		</tbody>
			    	</fr:datatable>
			    	
			</xforms:group>

	<h2>Curated Files</h2>
	
	<xforms:group ref="instance('ins-curated-media-feed')[empty(atom:entry)]">
		<p>There are no curated files.</p>
	</xforms:group>
	
	<xforms:group ref="instance('ins-curated-media-feed')[exists(atom:entry)]">
		
		<fr:datatable paginated="false">
			<thead>
				<tr>
					<th fr:sortable="true" fr:resizeable="true">Code</th>
					<th fr:sortable="true" fr:resizeable="true">File Name</th>
					<th fr:sortable="true" fr:resizeable="true">Date Submitted</th>
					<th fr:sortable="true" fr:resizeable="true">Curated By</th>
					<th fr:sortable="true" fr:resizeable="true">Type</th>
					<th>Actions</th>
				</tr>
			</thead>
			<tbody>
				<!-- will not try to use xxforms:sort on nodeset because it causes problems with datatable sorting by file type column -->
				<xforms:repeat id="rep-curated-media" nodeset="atom:entry">
					<tr>
						<td>
							<xforms:output ref="manta:id"/>
						</td>
						<td>
							<xforms:output ref="atom:title"/>
						</td>
						<td>
							<xforms:output ref="atom:published" xxforms:format="format-dateTime(., '[Y0001]-[M01]-[D01]')"/>
						</td>
						<td>
							<xforms:output ref="atom:author/atom:email"/>
						</td>
						<td>
							<xforms:output ref="
								for $cat in (./atom:category[@scheme='http://www.cggh.org/2010/chassis/scheme/FileTypes'])
								return
								if ( $cat/@term = 'http://www.cggh.org/2010/chassis/terms/Other' )
								then $cat/@label
								else instance('ins-file-terms')/term[value=$cat/@term]/label
								"/>
						</td>
						<td>
							<xforms:group ref=".[contains( ./atom:link[@rel='edit-media']/@atombeat:allow , 'GET' )]">
								<a href="{atom:content/@src}">Download</a>
							</xforms:group>
						</td>
					</tr>
				</xforms:repeat>
			</tbody>
		</fr:datatable>
		
	</xforms:group>
</div>