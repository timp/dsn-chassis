<div 
	xmlns="http://www.w3.org/1999/xhtml" 
	xmlns:xforms="http://www.w3.org/2002/xforms" 
	xmlns:ev="http://www.w3.org/2001/xml-events"
	xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
	xmlns:xxforms="http://orbeon.org/oxf/xml/xforms">
	
	<h2>Submit Files</h2>
	
	<table>

		<xforms:group ref="instance('ins-uploads-entry')/atom:content/uploads">
			<xforms:repeat nodeset="upload" id="rep-upload">
				<tr>
					<td>
                        <xforms:trigger>
                            <xforms:delete 
                            	ev:event="DOMActivate" 
	                        	context="instance('ins-uploads-entry')/atom:content/uploads" 
	                        	nodeset="upload" 
                            	at="index('rep-upload')"/>
                            <xforms:label><img src="/apps/contributor/common/remove.gif"/></xforms:label>
                        </xforms:trigger>
					</td>
					<td>
                        
                        <xforms:upload ref=".">
                        	<xforms:label>File:</xforms:label>
                            <xforms:filename ref="@filename"/>
                            <xforms:mediatype ref="@mediatype"/>
                            <xxforms:size ref="@size"/>
                            <xforms:send ev:event="xforms-select" submission="sub-post-background-uploads"/>
                        </xforms:upload>
                        
                        <br/>
						<xforms:select1 ref="@typeterm">
							<xforms:label>Type:</xforms:label>
							<xforms:alert>Please select a file type.</xforms:alert>
							<xforms:item>
								<xforms:value></xforms:value>
								<xforms:label>Select...</xforms:label>
							</xforms:item>
                        	<xforms:itemset nodeset="instance('ins-file-terms')/term">
                        		<xforms:label ref="label"/>
                        		<xforms:value ref="value"/>
                        	</xforms:itemset>
						</xforms:select1>
						
						<xforms:input ref="@typelabel">
							<xforms:label>Other Type:</xforms:label>
						</xforms:input>
                        
					</td>
				</tr>
			</xforms:repeat>
		</xforms:group>
		
		<tr>
			<td>
                   <xforms:trigger>
                       <xforms:label><img src="/apps/contributor/common/add.gif"/></xforms:label>
                       <xforms:insert 
                       	ev:event="DOMActivate" 
                       	context="instance('ins-uploads-entry')/atom:content/uploads" 
                       	nodeset="upload" 
                       	at="last()" 
                       	position="after" 
                       	origin="instance('ins-upload-template')"/>
                   </xforms:trigger>
			</td>
			<td >
                   <xforms:trigger appearance="minimal">
                       <xforms:label>Add a File</xforms:label>
                       <xforms:insert 
                       	ev:event="DOMActivate" 
                       	context="instance('ins-uploads-entry')/atom:content/uploads" 
                       	nodeset="upload" 
                       	at="last()" 
                       	position="after" 
                       	origin="instance('ins-upload-template')"/>
                   </xforms:trigger>
			</td>
		</tr>
	</table>

	 <xforms:group ref="instance('ins-uploads-entry')/atom:content/uploads[count(upload)>0]">
	     <p>
	         <xforms:trigger ref="instance('ins-control')/submit-files-trigger">
	             <xforms:label>Submit</xforms:label>
	             <xforms:send ev:event="DOMActivate" submission="sub-post-uploads"/>
	         </xforms:trigger>
	     </p>
     </xforms:group>
	
			<h2>Submitted Files</h2>
    		
    		<xforms:group ref="instance('ins-submitted-media-feed')[count(atom:entry)=0]">
    			<p>You have not submitted any files.</p>
    		</xforms:group>
    		
    		<xforms:group ref="instance('ins-submitted-media-feed')[count(atom:entry)>0]">
    		
			    	<fr:datatable paginated="false">
			    		<thead>
			    			<tr>
			    				<th fr:sortable="true" fr:resizeable="true">Code</th>
			    				<th fr:sortable="true" fr:resizeable="true">File Name</th>
			    				<th fr:sortable="true" fr:resizeable="true">Date Submitted</th>
			    				<th fr:sortable="true" fr:resizeable="true">Submitted By</th>
			    				<th fr:sortable="true" fr:resizeable="true">Type</th>
			    				<th>Actions</th>
			    			</tr>
			    		</thead>
			    		<tbody>
			    			<xforms:repeat id="rep-media" nodeset="xxforms:sort(instance('ins-submitted-media-feed')/atom:entry, atom:published, 'text', 'ascending')">
			    				<tr>
			    					<td>
			    						<xforms:output ref="manta:id"/>
			    					</td>
			    					<td>
			    						<xforms:output ref="atom:title"/>
			    					</td>
			    					<td>
			    						<xforms:output ref="atom:published" xxforms:format="format-dateTime(., '[Y0001]-[M01]-[D01]')"/>
			    					</td>
			    					<td>
			    						<xforms:output ref="atom:author/atom:email"/>
			    					</td>
			    					<td>
			    						<xforms:output ref="if(instance('ins-file-terms')/term[value=xxforms:context('rep-media')/atom:category[@scheme='http://www.cggh.org/2010/chassis/scheme/FileTypes']/@term]/value='http://www.cggh.org/2010/chassis/terms/Other') then atom:category[@scheme='http://www.cggh.org/2010/chassis/scheme/FileTypes']/@label else instance('ins-file-terms')/term[value=xxforms:context('rep-media')/atom:category[@scheme='http://www.cggh.org/2010/chassis/scheme/FileTypes']/@term]/label"/>
			    					</td>
			    					<!-- TODO: Only enable if the file has passed personal data review. -->
			    					<td><a href="{atom:content/@src}">Download</a></td>
			    				</tr>
			    			</xforms:repeat>
			    		</tbody>
			    	</fr:datatable>
			    	
			</xforms:group>
		
</div>