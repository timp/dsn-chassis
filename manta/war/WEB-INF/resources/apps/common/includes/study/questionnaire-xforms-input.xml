<div xmlns:xforms="http://www.w3.org/2002/xforms" xmlns:f="http://orbeon.org/oxf/xml/formatting"
	xmlns="http://www.w3.org/1999/xhtml" xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
	xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:ev="http://www.w3.org/2001/xml-events"
	xmlns:atom="http://www.w3.org/2005/Atom" xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
	xmlns:xi="http://www.w3.org/2001/XInclude">

	<xforms:group model="mod-study-questionnaire"
		ref="instance('ins-sq-study-entry')/atom:content/study">

		<p>
			<xforms:submit submission="sub-put-study-entry">
				<xforms:label>Save Changes</xforms:label>
			</xforms:submit>
		</p>

		<h2>General Questions</h2>

		<h3>Study Start and End</h3>

		<p>
			<xforms:input ref="start">
				<xforms:label>Start: </xforms:label>
				<xforms:alert>The date is not valid.</xforms:alert>
			</xforms:input>
		</p>

		<p>
			<xforms:input ref="end">
				<xforms:label>End: </xforms:label>
				<xforms:alert>The date is not valid.</xforms:alert>
			</xforms:input>
		</p>

		<h3>Pathogen Species</h3>

		<p>
			<xforms:select ref="pathogens" appearance="full">
				<xforms:label />
				<xforms:itemset model="mod-study-questionnaire"
					nodeset="instance('ins-pathogen-items')/pathogen">
					<xforms:label ref="label" />
					<xforms:value ref="value" />
				</xforms:itemset>
			</xforms:select>
		</p>

		<h3>Study Type (WWARN Modules)</h3>

		<p>
			<xforms:select ref="modules" appearance="full">
				<xforms:label />
				<xforms:itemset model="mod-study-questionnaire"
					nodeset="instance('ins-module-items')/module">
					<xforms:label ref="label" />
					<xforms:value ref="value" />
				</xforms:itemset>
			</xforms:select>
		</p>

		<h3>Study Site(s)</h3>

		<xforms:group ref="sites">

			<table class="repeat-table">
				<tr>
					<td>
						<xforms:trigger appearance="minimal">
							<xforms:label>
								<img src="/apps/submitter/common/add.gif" />
							</xforms:label>
							<xforms:insert ev:event="DOMActivate" context="."
								nodeset="site" at="1" position="before" origin="instance('ins-site-template')" />
						</xforms:trigger>
					</td>
					<td class="add-td">
						<xforms:trigger appearance="minimal">
							<xforms:label>Add a Site</xforms:label>
							<xforms:insert ev:event="DOMActivate" context="."
								nodeset="site" at="1" position="before" origin="instance('ins-site-template')" />
						</xforms:trigger>
					</td>
				</tr>
				<xforms:repeat nodeset="site" id="rep-site">
					<tr>
						<td>
							<xforms:trigger appearance="minimal">
								<xforms:delete ev:event="DOMActivate" context="."
									nodeset="." at="index('rep-site')" />
								<xforms:label>
									<img src="/apps/submitter/common/remove.gif" />
								</xforms:label>
							</xforms:trigger>
						</td>
						<td class="form-td">
							<xforms:select1 ref="country">
								<xforms:label />
								<xforms:itemset nodeset="instance('ins-country-items')/country">
									<xforms:label ref="label" />
									<xforms:value ref="value" />
								</xforms:itemset>
							</xforms:select1>
							<br />

							<!-- if the country has regions, use a select1 -->
							<xforms:group
								ref="
                                .[country/text() = instance('ins-countries-items')/country[exists(regions)]/value/text()]">

								<xforms:select1 ref="region">
									<xforms:label class="fixed-width">Region: </xforms:label>
									<xforms:itemset
										nodeset="instance('ins-countries-items')/country[value/text()=xxforms:context('rep-site')/country/text()]//region">
										<xforms:label ref="label" />
										<xforms:value ref="value" />
									</xforms:itemset>
								</xforms:select1>

							</xforms:group>

							<!-- if the country has no regions, use an input -->
							<xforms:group
								ref="
                                .[empty(country/text()) or country/text() = instance('ins-countries-items')/country[empty(regions)]/value/text()]">
								<xforms:input ref="region">
									<xforms:label class="fixed-width">Region: </xforms:label>
								</xforms:input>

							</xforms:group>

							<br />

							<xforms:input ref="district">
								<xforms:label class="fixed-width">District: </xforms:label>
							</xforms:input>
							<br />

							<xforms:input ref="locality">
								<xforms:label class="fixed-width">Locality: </xforms:label>
							</xforms:input>
							<br />

							<xforms:input ref="user-code">
								<xforms:label class="fixed-width">Your site code:</xforms:label>
							</xforms:input>
							<br />

							<xforms:select1 appearance="minimal" ref="testingDelay">
								<xforms:label class="fixed-width">Sampling/testing delay:</xforms:label>
								<xforms:itemset model="mod-study-questionnaire"
												nodeset="instance('ins-testingDelay-items')/testingDelay">
									<xforms:label ref="label" />
									<xforms:value ref="value" />
								</xforms:itemset>
								<xforms:alert>please select a value</xforms:alert>
							</xforms:select1>
							<br />

							<xforms:select1 appearance="minimal" ref="anticoagulant">
								<xforms:label class="fixed-width">Anticoagulant:</xforms:label>
								<xforms:itemset model="mod-study-questionnaire"
												nodeset="instance('ins-anticoagulant-items')/anticoagulant">
									<xforms:label ref="label" />
									<xforms:value ref="value" />
								</xforms:itemset>
								<xforms:alert>please select a value</xforms:alert>
							</xforms:select1>
							
							<br />

							<xforms:select1 appearance="minimal" ref="transportAndStorageTemperature">
								<xforms:label class="fixed-width">Transport/storage temperature:</xforms:label>
								<xforms:itemset model="mod-study-questionnaire"
												nodeset="instance('ins-transportAndStorageTemperature-items')/transportAndStorageTemperature">
									<xforms:label ref="label" />
									<xforms:value ref="value" />
								</xforms:itemset>
								<xforms:alert>please select a value</xforms:alert>
							</xforms:select1>
							
							
						</td>
					</tr>
				</xforms:repeat>
			</table>

		</xforms:group>


		<p>
			<xforms:submit submission="sub-put-study-entry">
				<xforms:label>Save Changes</xforms:label>
			</xforms:submit>
		</p>

		<xforms:group ref="clinical">

			<h2>Clinical Questions</h2>

			<p>TODO</p>

		</xforms:group>

		<xforms:group ref="molecular">

			<h2>Molecular Questions</h2>

			<p>TODO</p>

		</xforms:group>

		<xforms:group ref="in-vitro">

			<h2>
				<i>in vitro</i>
				Module Questions
			</h2>

			<xforms:input ref="invitro-analysisSite">
					<xforms:label>Where did the analysis take place?</xforms:label>
				<xforms:hint>
					<em>Enter a site code, or laboratory name and address if the analysis did not take place at
						any of the previously entered sites.
					</em>
				</xforms:hint>
			</xforms:input>
			<!--+
			|
			| BEGIN IN VITRO CULTURE NESTED QUESTIONNAIRE
			|
			+-->
			<xforms:group ref="invitro-culture">
				<h4>Culture for Drug Susceptibility Measure</h4>

				<xforms:select1 ref="invitro-culture-incubatorSystem"
					appearance="minimal">
					<xforms:label>Incubator system?</xforms:label>
					<xforms:itemset model="mod-study-questionnaire"
						nodeset="instance('ins-incubatorSystem-items')/incubatorSystem">
						<xforms:label ref="label" />
						<xforms:value ref="value" />
					</xforms:itemset>
				</xforms:select1>

				<xforms:input model="mod-study-questionnaire" ref="invitro-culture-co2">
					<xforms:label class="inline">
						CO
						<sub>2</sub>
						?
					</xforms:label>
					<xforms:hint>
						<p>
							<em>Temperature should be 37&#176;C.</em>
							<em>Don't forget to monitor the incubator system.</em>
						</p>
					</xforms:hint>
				</xforms:input>
				<p>
					<xforms:select1 ref="invitro-culture-healthyErythrocytesSource"
						appearance="minimal">
						<xforms:label>Healthy erythrocytes source?</xforms:label>
						<xforms:hint>
							<em>Healthy erythrocytes have to be deleucocyted.</em>
						</xforms:hint>
						<xforms:alert>please select a value</xforms:alert>
						<xforms:itemset model="mod-study-questionnaire"
							nodeset="instance('ins-healthyErythrocytesSource-items')/healthyErythrocytesSource">
							<xforms:label ref="label" />
							<xforms:value ref="value" />
						</xforms:itemset>
					</xforms:select1>
				</p>
				<p>
					<xforms:input ref="invitro-culture-hematocrit">
						<xforms:label>Hematocrit? (%)</xforms:label>
					</xforms:input>

				</p>
				<p>
					<xforms:select1 ref="invitro-culture-bloodGroup"
						appearance="minimal">
						<xforms:label>Blood group?</xforms:label>
						<xforms:itemset model="mod-study-questionnaire"
							nodeset="instance('ins-bloodGroup-items')/bloodGroup">
							<xforms:label ref="label" />
							<xforms:value ref="value" />
						</xforms:itemset>
					</xforms:select1>
					<xforms:alert>please select a value</xforms:alert>
				</p>
			</xforms:group>

			<!--
				+ | | BEGIN IN VITRO MEDIUM NESTED QUESTIONNAIRE | +
			-->

			<xforms:group ref="sites">
				<table class="repeat-table">
					<xforms:repeat nodeset="site" id="invitro-site-rep">
						<tr>
							<td>
							</td>
						</tr>
					</xforms:repeat>
				</table>
			</xforms:group>
			<xforms:group ref="invitro-medium">
				<h4 id="invitro-medium">Medium for Drug Susceptibility Measure</h4>
				<p>
					<xforms:select1 ref="invitro-medium-medium"
						appearance="minimal">
						<xforms:label>Medium?</xforms:label>
						<xforms:alert>please select a value</xforms:alert>
						<xforms:itemset model="mod-study-questionnaire"
							nodeset="instance('ins-medium-items')/medium">
							<xforms:label ref="label" />
							<xforms:value ref="value" />
						</xforms:itemset>
						<xforms:hint>
							<em>Storage temperature: 6 months at -20&#176;C and 1 week at
								+4&#176;C after using.</em>
						</xforms:hint>
					</xforms:select1>
				</p>
				<p>
					<xforms:select1 ref="invitro-medium-preparation"
						appearance="minimal">
						<xforms:label>Preparation?</xforms:label>
						<xforms:alert>please select a value</xforms:alert>
						<xforms:itemset model="mod-study-questionnaire"
							nodeset="instance('ins-mediumPreparation-items')/mediumPreparation">
							<xforms:label ref="label" />
							<xforms:value ref="value" />
						</xforms:itemset>
					</xforms:select1>
				</p>
				<p>
					<xforms:select1 ref="invitro-medium-serum"
						appearance="minimal">
						<xforms:label>Serum?</xforms:label>
						<xforms:alert>please select a value</xforms:alert>
						<xforms:itemset model="mod-study-questionnaire"
							nodeset="instance('ins-serum-items')/serum">
							<xforms:label ref="label" />
							<xforms:value ref="value" />
						</xforms:itemset>
					</xforms:select1>
				</p>

				<p>
					<xforms:input ref="invitro-medium-serum-finalConcentration">
						<xforms:label>Serum final concentration (g/L)? </xforms:label>
						<xforms:alert>Not a valid integer.</xforms:alert>
					</xforms:input>
				</p>
				<p>
					<xforms:input ref="invitro-medium-NaHCO3-finalConcentration">
						<xforms:label>Final concentration of NaHCO<sub>3</sub> ?</xforms:label>
						<xforms:alert>Not a valid integer.</xforms:alert>
					</xforms:input>
				</p>

				<xforms:group ref="invitro-medium-hypoxantine">
					<h5>Hypoxantine</h5>
					<p>
						<xforms:select1 ref="invitro-medium-hypoxantine-added"
							appearance="minimal">
							<xforms:label>Do you add Hypoxantine?</xforms:label>
							<xforms:alert>please select a value</xforms:alert>
							<xforms:itemset model="mod-study-questionnaire"
								nodeset="instance('ins-boolean-nullable')/booleanTerm">
								<xforms:label ref="label" />
								<xforms:value ref="value" />
							</xforms:itemset>
						</xforms:select1>
					</p>
					<p>
						<xforms:input ref="invitro-medium-hypoxantine-finalConcentration">
							<label>Final Hypoxantine concentration (g/L)?</label>
							<xforms:alert>Not a valid integer.</xforms:alert>
						</xforms:input>
					</p>
				</xforms:group>


				<xforms:group ref="invitro-medium-oroticAcid">
					<h5>Orotic Acid</h5>
					<p>
						<xforms:select1 ref="invitro-medium-oroticAcid-added"
							appearance="minimal">
							<xforms:label>Do you add Orotic Acid?</xforms:label>
							<xforms:alert>please select a value</xforms:alert>
							<xforms:itemset model="mod-study-questionnaire"
								nodeset="instance('ins-boolean-nullable')/booleanTerm">
								<xforms:label ref="label" />
								<xforms:value ref="value" />
							</xforms:itemset>
						</xforms:select1>
					</p>
					<p>
						<xforms:input ref="invitro-medium-oroticAcid-finalConcentration">
							<xforms:label>Final Orotic Acid concentration (g/L)?</xforms:label>
							<xforms:alert>Not a valid integer.</xforms:alert>
						</xforms:input>
					</p>
				</xforms:group>

				<xforms:group ref="invitro-medium-glucose">
					<h5>Glucose</h5>
					<p>
						<xforms:select1 ref="invitro-medium-glucose-added"
							appearance="minimal">
							<xforms:label>Do you add glucose?</xforms:label>
							<xforms:alert>please select a value</xforms:alert>
							<xforms:itemset model="mod-study-questionnaire"
								nodeset="instance('ins-boolean-nullable')/booleanTerm">
								<xforms:label ref="label" />
								<xforms:value ref="value" />
							</xforms:itemset>
						</xforms:select1>
					</p>
					<p>
						<xforms:input ref="invitro-medium-glucose-finalConcentration">
							<label>Final glucose concentration (g/L)?</label>
							<xforms:alert>Not a valid integer.</xforms:alert>
						</xforms:input>
					</p>
				</xforms:group>
				
				
				
				
				<xforms:group ref="antiBiotics">
					<table class="repeat-table">
						<tr>
							<td>
								<xforms:trigger appearance="minimal">
									<xforms:label>
										<img src="/apps/submitter/common/add.gif" />
									</xforms:label>
									<xforms:insert ev:event="DOMActivate" context="."
										nodeset="antiBiotic" 
										at="1" 
										position="before"
										origin="instance('ins-antiBiotic')" />
								</xforms:trigger>
							</td>
							<td class="add-td">
								<xforms:trigger appearance="minimal">
									<xforms:label>Add an Antibiotic</xforms:label>
									<xforms:insert ev:event="DOMActivate" context="."
										nodeset="antiBiotic" 
										at="1" 
										position="before"
										origin="instance('ins-antiBiotic')" />
								</xforms:trigger>
							</td>
						</tr>
						<xforms:repeat nodeset="antiBiotic" id="antiBiotic-rep">
							<tr>
								<td>
									<xforms:trigger appearance="minimal">
										<xforms:delete ev:event="DOMActivate" context="."
											nodeset="." at="index('antiBiotic-rep')" />
										<xforms:label>
											<img src="/apps/submitter/common/remove.gif" />
										</xforms:label>
									</xforms:trigger>
								</td>
								<td>
									<p>
										<xforms:input ref="antiBioticName">
											<xforms:label>Name of antibiotic?</xforms:label>
											<xforms:alert>Required field</xforms:alert>
										</xforms:input>
									</p>
									<p>
										<xforms:input ref="antiBioticFinalConcentration">
											<xforms:label>Final concentration (g/L)?</xforms:label>
											<xforms:alert>Not a valid integer.</xforms:alert>
										</xforms:input>
									</p>
								</td>
							</tr>
						</xforms:repeat>
					</table>

				</xforms:group>

			</xforms:group>
		<!--+
		|
		| BEGIN IN VITRO SUSCEPTIBILITY NESTED QUESTIONNAIRE
		|
		+-->

				<h4 id="invitro-susceptibility">Determination of Drug Susceptibility</h4>

				<xforms:group ref="susceptibility">
					<xforms:select1 appearance="minimal" ref="timeOfIncubation">
						<label>Time of incubation?</label>
						<xforms:alert>please select a value</xforms:alert>
						<xforms:itemset model="mod-study-questionnaire"
										nodeset="instance('ins-incubationTime-items')/incubationtime">
							<xforms:label ref="label" />
							<xforms:value ref="value" />
						</xforms:itemset>
						<xforms:hint>
							<em>If this is different for each sample, please include this information in your
								raw data.
							</em>
						</xforms:hint>
					</xforms:select1>
					<xforms:select1 appearance="minimal" ref="susceptibilityMethod">
						<label>Method used?</label>
						<xforms:alert>please select a value</xforms:alert>
						<xforms:hint>
							<em>If this is different for each sample, please include this information in your
								raw data.
							</em>
						</xforms:hint>
					</xforms:select1>
				</xforms:group>

				<!--+
		|
		| END IN VITRO SUSCEPTIBILITY NESTED QUESTIONNAIRE
		|
		+-->


				<!--+
				|
				| BEGIN IN VITRO DRUG STOCK SOLUTIONS NESTED QUESTIONNAIRE
				|
				+-->

				<h4 id="invitro-drug">Drug Stock Solutions</h4>

				<p>
				<em>Please complete the section below for each drug stock solution used.</em>
				</p>

				<xforms:group ref="drug" repeatable="yes">

						<xforms:select1 appearance="minimal" ref="invitro-drug-molecule">
							<label>Molecule?</label>
							<xforms:alert>please select a value</xforms:alert>
						</xforms:select1>
				<br/>			

						<xforms:select1 appearance="minimal" ref="solvent">
							<label>Solvent of stock solution?</label>
							<xforms:alert>please select a value</xforms:alert>
						</xforms:select1>
				<br/>			
							
						<xforms:input ref="solventFinalConcentration">
							<label>Solvent final concentration (g/L)?</label>
						</xforms:input>
							
						<p>
							<em>Storage temperature and shelf lives for each solution will be determined and
								indicated.
							</em>
						</p>

				<br/>			
						<xforms:select1 appearance="minimal" ref="providedByWwarn">
						<!--  TODO Check do they mean drug here? -->
							<label>Were stock solutions provided by WWARN?</label>
						</xforms:select1>
							
				<br/>			
						<xforms:input ref="provider">
									<xforms:label>Who provided the drug?</xforms:label>
						</xforms:input>


				</xforms:group>

				<!--+
				|
				| END IN VITRO DRUG STOCK SOLUTIONS NESTED QUESTIONNAIRE
				|
				+-->


				<!--+
				|
				| BEGIN IN VITRO PLATES NESTED QUESTIONNAIRE
				|
				+-->

				<h4 id="invitro-plates">Batch of Plates</h4>

				<xforms:group ref="plateBatches">
				<xforms:group ref="batch">

				<br/>			
					<xforms:select1 appearance="minimal" ref="clone3D7ProvidedByWwarn">
						<xforms:label>Were clones provided by WWARN?</xforms:label>
					</xforms:select1>
				<br/>			

					<xforms:input ref="cloneProvider">
						<xforms:label>Who provided the clone?</xforms:label>
					</xforms:input>

					<br/>			
							
					<xforms:select1 appearance="minimal" ref="includedInRawData">
						<label>Are your batch preparation dates and 3D7 information included with the raw data?</label>
					</xforms:select1>
					
					<xforms:group ref="notIncludedBatchDataHint">		
					<p>
						<em>If batch preparation dates and 3D7 information are
							<strong>not</strong>
							included with the raw data, please complete the section below for each batch.
							</em>
					</p>
					</xforms:group>

					<xforms:input ref="preparationDate">
							<xforms:label>Preparation date?</xforms:label>
					</xforms:input>
					<br/>			

					<xforms:select1 appearance="minimal" ref="clone3D7ProvidedByWwarn">
						<xforms:label>3D7 provided by WWARN?</xforms:label>
					</xforms:select1>
					<br/>			
							
									
					<xforms:input ref="parasitaemia3D7">
						<xforms:label>3D7 parasitaemia (%)?</xforms:label>
					</xforms:input>
					<br/>			
									
					<xforms:input ref="ringForms">
						<xforms:label>Ring forms after synchronisation (%)?</xforms:label>
					</xforms:input>

			</xforms:group>
			</xforms:group>

			<!--+
			|
			| END IN VITRO PLATES NESTED QUESTIONNAIRE
			|
			+-->

			
		</xforms:group>

		<xforms:group ref="pharmacology">

			<h2>Pharmacology Questions</h2>

			<p>TODO</p>

		</xforms:group>

	</xforms:group>

</div>