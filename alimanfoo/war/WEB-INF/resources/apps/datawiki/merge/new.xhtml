<!--
    Copyright (C) 2010 University of Oxford

    This program is free software; you can redistribute it and/or modify it under the terms of the
    GNU Lesser General Public License as published by the Free Software Foundation; either version
    2.1 of the License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
    without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
    See the GNU Lesser General Public License for more details.

    The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
-->
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:xforms="http://www.w3.org/2002/xforms"
      xmlns:xs="http://www.w3.org/2001/XMLSchema"
      xmlns:ev="http://www.w3.org/2001/xml-events"
      xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
      xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
      xmlns:atom="http://www.w3.org/2005/Atom">
      
    <head>
        <title>DataWiki > Merge > New</title>
        
        <xforms:model id="mod-main">
        
        	<xforms:instance id="ins-login">
        		<login xmlns="">
        			<user/>
        			<roles/>
        		</login>
        	</xforms:instance>
        	
        	<xforms:action ev:event="xforms-model-construct-done">
        		<xforms:setvalue ref="instance('ins-login')/user" value="xxforms:get-remote-user()"/>
		        <xforms:insert 
		            nodeset="instance('ins-login')/roles" 
		            at="1" 
		            position="before" 
		            origin="xxforms:get-request-attribute('user-roles-xml')"/>
        	</xforms:action>

        	<xforms:instance id="ins-table-feed">
        		<atom:feed/>
        	</xforms:instance>
        	
      		<xforms:submission 
      			id="sub-get-table-feed"
      			method="get"
      			resource="/atombeat/content/datawiki/tables"
      			replace="instance"
      			instance="ins-table-feed">
                <xforms:message ev:event="xforms-submit-error" level="modal">An error occurred (<xforms:output value="event('error-type')"/>).</xforms:message>
      		</xforms:submission>
      		
      		<xforms:submission
      			id="sub-post-preview"
      			method="post"
      			resource="/query/datawiki/merge"
      			ref="instance('ins-merge-entry')"
      			replace="instance"
      			instance="ins-merge-entry"
      			mediatype="application/atom+xml">
                <xforms:message ev:event="xforms-submit-error" level="modal">An error occurred (<xforms:output value="event('error-type')"/>).</xforms:message>
   			</xforms:submission>
   			
      		<xforms:submission
      			id="sub-post-entry"
      			method="post"
      			resource="/atombeat/content/datawiki/merges"
      			ref="instance('ins-merge-entry')"
      			replace="instance"
      			instance="ins-merge-entry"
      			mediatype="application/atom+xml">
      			<xforms:send ev:event="xforms-submit-done" submission="sub-get-merge-view-page"/>
                <xforms:message ev:event="xforms-submit-error" level="modal">An error occurred (<xforms:output value="event('error-type')"/>).</xforms:message>
   			</xforms:submission>
   			
   			<xforms:submission
   				id="sub-get-merge-view-page"
   				method="get"
   				resource="/datawiki/merge/view"
   				ref="instance('ins-get-merge-view-params')"
   				replace="all">
			</xforms:submission>
   			
   			<xforms:instance id="ins-get-merge-view-params">
   				<params xmlns="">
   					<entry/>
   				</params>
   			</xforms:instance>
   			
   			<xforms:bind 
   				ref="instance('ins-get-merge-view-params')/entry" 
   				calculate="instance('ins-merge-entry')/atom:link[@rel='edit']/@href"/>
   				
      		<xforms:send ev:event="xforms-model-construct-done" submission="sub-get-table-feed"/>

   			<xforms:action ev:event="xforms-model-construct-done">
   				<xforms:setvalue ref="instance('ins-acl')//group[@name='admins']/user" value="xxforms:get-remote-user()"/>
   			</xforms:action>
   			
			<xforms:instance id="ins-merge-template">
				<merge xmlns="">
					<col>
						<label></label>
					</col>
					<col>
						<label></label>
					</col>
					<label></label>
					<datatype></datatype>
					<required>false</required>
				</merge>
			</xforms:instance>
			
			<xforms:instance id="ins-copy-col-template">
				<col xmlns="">
					<source></source>
					<label></label>
					<rename></rename>
				</col>
			</xforms:instance>

			<xforms:instance id="ins-merge-entry">
				<atom:entry xmlns:atom="http://www.w3.org/2005/Atom">
					<atom:title type="text"/>
					<atom:content type="application/vnd.chassis+xml">
						<merge xmlns="">
							<design>
								<source></source>
								<source></source>
								<join>
									<col>
										<label></label>
									</col>
									<col>
										<label></label>
									</col>
									<label></label>
									<datatype></datatype>
									<required>true</required>
								</join>
								<merges>
								</merges>
								<copy>
								</copy>
							</design>
						</merge>
					</atom:content>
				</atom:entry>
			</xforms:instance>
			
			<xforms:bind nodeset="instance('ins-merge-entry')">
				<xforms:bind nodeset=".//merge">
					<xforms:bind nodeset="design">
						<xforms:bind nodeset="source[2]" constraint="if (exists(./text())) then ( . != ../source[1] ) else true()"/>
						<xforms:bind nodeset="merges">
							<xforms:bind nodeset="merge">
								<xforms:bind nodeset="col/label" required="true()"/>
							</xforms:bind>
						</xforms:bind>
					</xforms:bind>				
				</xforms:bind>
			</xforms:bind>
			
			<xforms:instance id="ins-source-1">
				<atom:entry/>
			</xforms:instance>
			
			<xforms:instance id="ins-source-2">
				<atom:entry/>
			</xforms:instance>
			
			<xforms:instance id="ins-empty-entry">
				<atom:entry/>
			</xforms:instance>
			
			<xforms:submission 
				id="sub-get-source-1"
				method="get"
				resource="{instance('ins-merge-entry')//design/source[1]}"
				replace="instance"
				instance="ins-source-1">
                <xforms:message ev:event="xforms-submit-error" level="modal">An error occurred (<xforms:output value="event('error-type')"/>).</xforms:message>
			</xforms:submission>
			
			<xforms:submission 
				id="sub-get-source-2"
				method="get"
				resource="{instance('ins-merge-entry')//design/source[2]}"
				replace="instance"
				instance="ins-source-2">
                <xforms:message ev:event="xforms-submit-error" level="modal">An error occurred (<xforms:output value="event('error-type')"/>).</xforms:message>
			</xforms:submission>

        </xforms:model>
        
        <link rel="stylesheet" type="text/css" href="/ops/yui/tabview/assets/skins/sam/tabview.css"></link>
        <link rel="stylesheet" type="text/css" href="/ops/yui/datatable/assets/skins/sam/datatable.css"></link>
        <style type="text/css">
.yui-skin-sam tr.yui-dt-selected td, .yui-skin-sam tr.yui-dt-selected td.yui-dt-asc, .yui-skin-sam tr.yui-dt-selected td.yui-dt-desc {
	background-color:inherit;
	color:inherit;
}
.yui-skin-sam .yui-dt th a {
	color: #666699;
}
.yui-skin-sam .yui-dt th a:hover {
	text-decoration: underline;
}
.unresolved-conflict {
	background-color: #faa;
	padding: .1em .2em .1em .2em;
	margin-top: .2em;
} 
.xforms-repeat-selected-item-1 { background: transparent }
.xforms-repeat-selected-item-2 { background: transparent }
        </style>

    </head>
    
    <body>
    
		<p><a href="../">DataWiki</a> - <strong><xforms:output ref="instance('ins-login')/user"/></strong></p>
    	
    	<hr/>
    	
		<h2>New Merge</h2>
		
		<p>
			<xforms:input ref="instance('ins-merge-entry')/atom:title">
				<xforms:label>Title: </xforms:label>
			</xforms:input>
		</p>
		
		<xforms:group ref="instance('ins-merge-entry')//design">
		
			<h3>Choose Sources</h3>
			<p>
	    		<xforms:select1 ref="source[1]">
	    			<xforms:label>[1] </xforms:label>
	    			<xforms:alert>Select a different table.</xforms:alert>
	    			<xforms:send ev:event="xforms-value-changed" submission="sub-get-source-1" if="instance('ins-merge-entry')//design/source[1]/text() != ''"/>
	    			<xforms:delete ev:event="xforms-value-changed" if="instance('ins-merge-entry')//design/source[1]/text() = ''" nodeset="instance('ins-source-1')/*"/>
	   				<xforms:item>
	   					<xforms:label>select table...</xforms:label>
	   					<xforms:value/>
	   				</xforms:item>
	    			<xforms:itemset nodeset="instance('ins-table-feed')/atom:entry">
	    				<xforms:label ref="atom:title"/>
	    				<xforms:value ref="atom:link[@rel='edit']/@href"/>
	    			</xforms:itemset>
	    		</xforms:select1><br/>
	    		<xforms:select1 ref="source[2]">
	    			<xforms:label>[2] </xforms:label>
	    			<xforms:alert>Select a different table.</xforms:alert>
	    			<xforms:send ev:event="xforms-value-changed" submission="sub-get-source-2" if="instance('ins-merge-entry')//design/source[2]/text() != ''"/>
	    			<xforms:delete ev:event="xforms-value-changed" if="instance('ins-merge-entry')//design/source[2]/text() = ''" nodeset="instance('ins-source-2')/*"/>
	   				<xforms:item>
	   					<xforms:label>select table...</xforms:label>
	   					<xforms:value/>
	   				</xforms:item>
	    			<xforms:itemset nodeset="instance('ins-table-feed')/atom:entry">
	    				<xforms:label ref="atom:title"/>
	    				<xforms:value ref="atom:link[@rel='edit']/@href"/>
	    			</xforms:itemset>
	    		</xforms:select1>
	    	</p>
	    	
	    	<h3>Choose Join Column</h3>
	    	
	    	<p>
	    		<xforms:select1 ref="join/col[1]/label">
	    			<xforms:label>[1] </xforms:label>
	    			<xforms:setvalue ev:event="xforms-value-changed" ref="../../label" value="../col[1]/label"/>
	   				<xforms:item>
	   					<xforms:label>select column...</xforms:label>
	   					<xforms:value/>
	   				</xforms:item>
	    			<xforms:itemset nodeset="instance('ins-source-1')//thead/tr/th">
	    				<xforms:label ref="label"/>
	    				<xforms:value ref="label"/>
	    			</xforms:itemset>
	    		</xforms:select1>
	    		<br/>
	    		<xforms:select1 ref="join/col[2]/label">
	    			<xforms:label>[2] </xforms:label>
	   				<xforms:item>
	   					<xforms:label>select column...</xforms:label>
	   					<xforms:value/>
	   				</xforms:item>
	    			<xforms:itemset nodeset="instance('ins-source-2')//thead/tr/th">
	    				<xforms:label ref="label"/>
	    				<xforms:value ref="label"/>
	    			</xforms:itemset>
	    		</xforms:select1>
	    	</p>
	    	
	    	<p>
	    		<xforms:input ref="join/label">
	    			<xforms:label>Rename to: </xforms:label>
	    		</xforms:input>
	    	
	    	</p>
	    	
	    	<h3>Choose Columns to Merge</h3>
	    	
			<xforms:group ref="merges">
			
				<div class="yui-dt">
					<div class="yui-dt-hd">
						<table class="yui-dt-table">
							<thead>
								<tr>
									<th>
										<div class="yui-dt-liner">
						                    <xforms:trigger appearance="minimal">
						                        <xforms:label><img src="/apps/fr/style/add.gif"/></xforms:label>
						                        <xforms:insert 
						                            ev:event="DOMActivate" 
						                            context="." 
						                            nodeset="merge" 
						                            at="1" 
						                            position="before" 
						                            origin="instance('ins-merge-template')"/>
						                    </xforms:trigger>
										</div>
									</th>
									<th>
										<div class="yui-dt-liner">
						                    <xforms:trigger appearance="minimal">
						                        <xforms:label>Add a Column Merge</xforms:label>
						                        <xforms:insert 
						                            ev:event="DOMActivate" 
						                            context="." 
						                            nodeset="merge" 
						                            at="1" 
						                            position="before" 
						                            origin="instance('ins-merge-template')"/>
						                    </xforms:trigger>
										</div>
									</th>
								</tr>
							</thead>
							<tbody class="yui-dt-data">
								<xforms:repeat 
									nodeset="merge" 
									id="rep-merge">
									<tr class="
										{if ( position() = 1 ) then 'yui-dt-first' else '' }
										{if ( position() mod 2 = 0 ) then 'yui-dt-even' else 'yui-dt-odd' }">
										<td>
											<div class="yui-dt-liner">
							                    <xforms:trigger appearance="minimal">
							                        <xforms:label><img src="/apps/fr/style/add.gif"/></xforms:label>
							                        <xforms:insert 
							                            ev:event="DOMActivate" 
							                            context="." 
							                            nodeset="." 
							                            at="position()" 
							                            position="after" 
							                            origin="instance('ins-merge-template')"/>
							                    </xforms:trigger>
							                    <xforms:trigger appearance="minimal">
						                            <xforms:delete 
						                                ev:event="DOMActivate" 
						                                context="." 
						                                nodeset="." 
						                                at="index('rep-merge')"/>
						                            <xforms:label><img src="/apps/fr/style/delete.gif"/></xforms:label>
						                        </xforms:trigger>
						                        <xforms:trigger appearance="minimal" ref=".[preceding-sibling::*]">
						                            <xforms:label><img src="/apps/fr/style/up.gif"/></xforms:label>
						                            <xforms:action ev:event="DOMActivate">
						                                <xforms:insert origin="context()" nodeset="preceding-sibling::*[1]" position="before"/>
						                                <xforms:delete nodeset="."/>
						                            </xforms:action>
						                        </xforms:trigger>
						                        <xforms:trigger appearance="minimal" ref=".[following-sibling::*]">
						                            <xforms:label><img src="/apps/fr/style/down.gif"/></xforms:label>
						                            <xforms:action ev:event="DOMActivate">
						                                <xforms:insert origin="context()" nodeset="following-sibling::*[1]"/>
						                                <xforms:delete nodeset="."/>
						                            </xforms:action>
						                        </xforms:trigger>
											</div>
										</td>
										<td>
											<div class="yui-dt-liner">
										    	<p>
										    		<xforms:select1 ref="col[1]/label">
										    			<xforms:label>[1] </xforms:label>
										    			<xforms:alert>Select a column from source 1.</xforms:alert>
										    			<xforms:setvalue ev:event="xforms-value-changed" ref="../../label" value="../col[1]/label"/>
										   				<xforms:item>
										   					<xforms:label>select column...</xforms:label>
										   					<xforms:value/>
										   				</xforms:item>
										    			<xforms:itemset nodeset="instance('ins-source-1')//thead/tr/th">
										    				<xforms:label ref="label"/>
										    				<xforms:value ref="label"/>
										    			</xforms:itemset>
										    		</xforms:select1>
										    		<br/>
										    		<xforms:select1 ref="col[2]/label">
										    			<xforms:label>[2] </xforms:label>
										    			<xforms:alert>Select a column from source 2.</xforms:alert>
										   				<xforms:item>
										   					<xforms:label>select column...</xforms:label>
										   					<xforms:value/>
										   				</xforms:item>
										    			<xforms:itemset nodeset="instance('ins-source-2')//thead/tr/th">
										    				<xforms:label ref="label"/>
										    				<xforms:value ref="label"/>
										    			</xforms:itemset>
										    		</xforms:select1>
										    	</p>
										    	
										    	<p>
										    		<xforms:input ref="label">
										    			<xforms:label>Rename to: </xforms:label>
										    		</xforms:input>
										    	
										    	</p>
										    	
											</div>
										</td>
									</tr>
								</xforms:repeat>
							</tbody>
						</table>
					</div>
				</div>
			</xforms:group>	   
			
			<h3>Choose Columns to Copy</h3> 	

			<xforms:group ref="copy">
			
				<div class="yui-dt">
					<div class="yui-dt-hd">
						<table class="yui-dt-table">
							<thead>
								<tr>
									<th>
										<div class="yui-dt-liner">
						                    <xforms:trigger appearance="minimal">
						                        <xforms:label><img src="/apps/fr/style/add.gif"/></xforms:label>
						                        <xforms:insert 
						                            ev:event="DOMActivate" 
						                            context="." 
						                            nodeset="col" 
						                            at="1" 
						                            position="before" 
						                            origin="instance('ins-copy-col-template')"/>
						                    </xforms:trigger>
										</div>
									</th>
									<th>
										<div class="yui-dt-liner">
						                    <xforms:trigger appearance="minimal">
						                        <xforms:label>Add a Column to Copy</xforms:label>
						                        <xforms:insert 
						                            ev:event="DOMActivate" 
						                            context="." 
						                            nodeset="col" 
						                            at="1" 
						                            position="before" 
						                            origin="instance('ins-copy-col-template')"/>
						                    </xforms:trigger>
										</div>
									</th>
								</tr>
							</thead>
							<tbody class="yui-dt-data">
								<xforms:repeat 
									nodeset="col" 
									id="rep-col">
									<tr class="
										{if ( position() = 1 ) then 'yui-dt-first' else '' }
										{if ( position() mod 2 = 0 ) then 'yui-dt-even' else 'yui-dt-odd' }">
										<td>
											<div class="yui-dt-liner">
							                    <xforms:trigger appearance="minimal">
							                        <xforms:label><img src="/apps/fr/style/add.gif"/></xforms:label>
							                        <xforms:insert 
							                            ev:event="DOMActivate" 
							                            context="." 
							                            nodeset="." 
							                            at="position()" 
							                            position="after" 
							                            origin="instance('ins-copy-col-template')"/>
							                    </xforms:trigger>
							                    <xforms:trigger appearance="minimal">
						                            <xforms:delete 
						                                ev:event="DOMActivate" 
						                                context="." 
						                                nodeset="." 
						                                at="index('rep-merge')"/>
						                            <xforms:label><img src="/apps/fr/style/delete.gif"/></xforms:label>
						                        </xforms:trigger>
						                        <xforms:trigger appearance="minimal" ref=".[preceding-sibling::*]">
						                            <xforms:label><img src="/apps/fr/style/up.gif"/></xforms:label>
						                            <xforms:action ev:event="DOMActivate">
						                                <xforms:insert origin="context()" nodeset="preceding-sibling::*[1]" position="before"/>
						                                <xforms:delete nodeset="."/>
						                            </xforms:action>
						                        </xforms:trigger>
						                        <xforms:trigger appearance="minimal" ref=".[following-sibling::*]">
						                            <xforms:label><img src="/apps/fr/style/down.gif"/></xforms:label>
						                            <xforms:action ev:event="DOMActivate">
						                                <xforms:insert origin="context()" nodeset="following-sibling::*[1]"/>
						                                <xforms:delete nodeset="."/>
						                            </xforms:action>
						                        </xforms:trigger>
											</div>
										</td>
										<td>
											<div class="yui-dt-liner">
										    	<p>
										    		<xforms:select1 ref="source">
										    			<xforms:label class="fixed-width">Source: </xforms:label>
										    			<xforms:alert>Select a source.</xforms:alert>
										   				<xforms:item>
										   					<xforms:label>select source...</xforms:label>
										   					<xforms:value/>
										   				</xforms:item>
										   				<xforms:item>
										   					<xforms:label><xforms:output ref="instance('ins-source-1')/atom:title"/></xforms:label>
										   					<xforms:value>1</xforms:value>
										   				</xforms:item>
										   				<xforms:item>
										   					<xforms:label><xforms:output ref="instance('ins-source-2')/atom:title"/></xforms:label>
										   					<xforms:value>2</xforms:value>
										   				</xforms:item>
										    		</xforms:select1>
										    		<br/>
										    		<xforms:select1 ref="label">
										    			<xforms:label class="fixed-width">Column: </xforms:label>
										    			<xforms:alert>Select a column to copy.</xforms:alert>
										    			<xforms:setvalue ev:event="xforms-value-changed" ref="../rename" value="../label"/>
										   				<xforms:item>
										   					<xforms:label>select column...</xforms:label>
										   					<xforms:value/>
										   				</xforms:item>
										    			<xforms:itemset nodeset="if (../source='1') then instance('ins-source-1')//thead/tr/th else instance('ins-source-2')//thead/tr/th">
										    				<xforms:label ref="label"/>
										    				<xforms:value ref="label"/>
										    			</xforms:itemset>
										    		</xforms:select1>
										    	</p>
										    	
										    	<p>
										    		<xforms:input ref="rename">
										    			<xforms:label class="fixed-width">Rename to: </xforms:label>
										    		</xforms:input>
										    	
										    	</p>
										    	
											</div>
										</td>
									</tr>
								</xforms:repeat>
							</tbody>
						</table>
					</div>
				</div>
			</xforms:group>	  
			
		</xforms:group>
    	
		<h3>Preview</h3>

		<p>
			<xforms:submit submission="sub-post-preview">
				<xforms:label>Calculate Preview</xforms:label>
			</xforms:submit>
    		<xforms:submit submission="sub-post-entry">
    			<xforms:label><img src="/apps/fr/style/new.gif"/> Save Merge</xforms:label>
    		</xforms:submit>
		</p>			

		<xforms:group ref="instance('ins-merge-entry')//table">
		
			<div class="yui-dt">
				<div class="yui-dt-hd">
					<table class="yui-dt-table">
						<thead>
		   					<tr>
		   						<xforms:repeat nodeset="thead/tr/th">
									<th fr:sortable="true" fr:resizeable="true">
										<div class="yui-dt-liner">
											<xforms:output value="label"/>
										</div>
									</th>	    						
		   						</xforms:repeat>
		   					</tr>
						</thead>
						<tbody class="yui-dt-data">
	   					<xforms:repeat nodeset="tbody/tr">
	   						<tr class="
									{if ( position() = 1 ) then 'yui-dt-first' else '' }
									{if ( position() mod 2 = 0 ) then 'yui-dt-even' else 'yui-dt-odd' }">
	    						<xforms:repeat nodeset="td">
									<td>
										<div class="yui-dt-liner">
											<xforms:output ref="decision"/>
											<xforms:group ref=".[empty(decision/text()) and source[1] != source[2]]">
												<div class="unresolved-conflict">
													<xforms:output ref="source[1]">
														<xforms:label>[1] </xforms:label>
													</xforms:output>
													<br/>
													<xforms:output ref="source[2]">
														<xforms:label>[2] </xforms:label>
													</xforms:output>
												</div>
											</xforms:group>
										</div>
									</td>	    						
	    						</xforms:repeat>
	   						</tr>
	   					</xforms:repeat>
						</tbody>
					</table>
				</div>
			</div>
		
		</xforms:group>
    </body>
</html>
