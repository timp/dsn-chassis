<!--
    Copyright (C) 2010 University of Oxford

    This program is free software; you can redistribute it and/or modify it under the terms of the
    GNU Lesser General Public License as published by the Free Software Foundation; either version
    2.1 of the License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
    without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
    See the GNU Lesser General Public License for more details.

    The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
-->
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:xforms="http://www.w3.org/2002/xforms"
      xmlns:xs="http://www.w3.org/2001/XMLSchema"
      xmlns:ev="http://www.w3.org/2001/xml-events"
      xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
      xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
      xmlns:atom="http://www.w3.org/2005/Atom">
      
    <head>
        <title>DataWiki</title>
        
        <xforms:model id="mod-main">
        
        	<xforms:instance id="ins-login">
        		<login xmlns="">
        			<user/>
        			<roles/>
        		</login>
        	</xforms:instance>
        	
        	<xforms:action ev:event="xforms-model-construct-done">
        		<xforms:setvalue ref="instance('ins-login')/user" value="xxforms:get-remote-user()"/>
		        <xforms:insert 
		            nodeset="instance('ins-login')/roles" 
		            at="1" 
		            position="before" 
		            origin="xxforms:get-request-attribute('user-roles-xml')"/>
        	</xforms:action>

        	<xforms:instance id="ins-table-feed">
        		<atom:feed/>
        	</xforms:instance>
        	
        	<xforms:instance id="ins-merge-feed">
        		<atom:feed/>
        	</xforms:instance>
        	
            <xforms:instance id="ins-table-entry-template" src="/apps/datawiki/table/template-entry.xml"/>
            
            <xforms:instance id="ins-table-entry">
            	<atom:entry/>
            </xforms:instance>
            
      		<xforms:submission 
      			id="sub-get-table-feed"
      			method="get"
      			resource="/atombeat/content/datawiki/tables"
      			replace="instance"
      			instance="ins-table-feed">
                <xforms:message ev:event="xforms-submit-error" level="modal">An error occurred (<xforms:output value="event('error-type')"/>).</xforms:message>
      		</xforms:submission>
      		
      		<xforms:submission 
      			id="sub-get-merge-feed"
      			method="get"
      			resource="/atombeat/content/datawiki/merges"
      			replace="instance"
      			instance="ins-merge-feed">
                <xforms:message ev:event="xforms-submit-error" level="modal">An error occurred (<xforms:output value="event('error-type')"/>).</xforms:message>
      		</xforms:submission>
      		
      		<xforms:send ev:event="xforms-model-construct-done" submission="sub-get-table-feed"/>
      		<xforms:send ev:event="xforms-model-construct-done" submission="sub-get-merge-feed"/>
      		
      		<xforms:submission
      			id="sub-post-table-entry"
      			method="post"
      			resource="/atombeat/content/datawiki/tables"
      			ref="instance('ins-table-entry-template')"
      			mediatype="application/atom+xml"
      			replace="instance"
      			instance="ins-table-entry">
      			<xforms:send ev:event="xforms-submit-done" submission="sub-put-table-acl"/>	
                <xforms:message ev:event="xforms-submit-error" level="modal">An error occurred (<xforms:output value="event('error-type')"/>).</xforms:message>
      		</xforms:submission>
      		
      		<xforms:instance id="ins-acl">
      			<atom:entry>
      				<atom:content type="application/vnd.atombeat+xml">
		       			<acl xmlns="">
		       				<groups>
		       					<group name="admins">
		       						<user></user>
		       					</group>
		       					<group name="editors">
		       					</group>
		       					<group name="viewers">
		       					</group>
		   					</groups>
				    		<rules>
				    		    <!-- admins can retrieve, update and change sharing -->
				                <allow>
				                    <group>admins</group>
				                    <operation>retrieve-member</operation>
				                </allow>
				                <allow>
				                    <group>admins</group>
				                    <operation>update-member</operation>
				                </allow>
				                <allow>
				                    <group>admins</group>
				                    <operation>update-acl</operation>
				                </allow>
				                <!-- editors can retrieve and update, but cannot change sharing -->
				                <allow>
				                    <group>editors</group>
				                    <operation>retrieve-member</operation>
				                </allow>
				                <allow>
				                    <group>editors</group>
				                    <operation>update-member</operation>
				                </allow>
				                <!-- viewers can retrieve only -->
				                <allow>
				                    <group>viewers</group>
				                    <operation>retrieve-member</operation>
				                </allow>
				    		</rules>
		   				</acl>
      				</atom:content>
      			</atom:entry>
      		</xforms:instance>
      		
      		<xforms:submission
      			id="sub-put-table-acl"
      			method="put"
      			resource="{instance('ins-table-entry')/atom:link[@rel='edit-acl']/@href}"
      			mediatype="application/atom+xml"
      			ref="instance('ins-acl')"
      			replace="none">
<!--      			<xforms:send ev:event="xforms-submit-done" submission="sub-get-table-feed"/>	-->
      			<xforms:send ev:event="xforms-submit-done" submission="sub-get-table-view-page"/>	
                <xforms:message ev:event="xforms-submit-error" level="modal">An error occurred (<xforms:output value="event('error-type')"/>) updating ACL.</xforms:message>
   			</xforms:submission>
   			
   			<xforms:instance id="ins-get-table-view-params">
   				<params xmlns="">
   					<entry/>
   				</params>
   			</xforms:instance>
   			
   			<xforms:bind 
   				ref="instance('ins-get-table-view-params')/entry" 
   				calculate="instance('ins-table-entry')/atom:link[@rel='edit']/@href"/>
   			
   			<xforms:submission
   				id="sub-get-table-view-page"
   				method="get"
   				resource="/datawiki/table/view"
   				ref="instance('ins-get-table-view-params')"
   				replace="all">
			</xforms:submission>
   			
   			<xforms:action ev:event="xforms-model-construct-done">
   				<xforms:setvalue ref="instance('ins-acl')//group[@name='admins']/user" value="xxforms:get-remote-user()"/>
   			</xforms:action>

			<xforms:instance id="ins-noparams">
				<params xmlns=""/>
			</xforms:instance>		
			
			<xforms:submission
				id="sub-get-new-merge"
				method="get"
				resource="/datawiki/merge/new"
				ref="instance('ins-noparams')"
				replace="all">
			</xforms:submission>	

        </xforms:model>
        
        <style type="text/css">
.yui-skin-sam tr.yui-dt-selected td, .yui-skin-sam tr.yui-dt-selected td.yui-dt-asc, .yui-skin-sam tr.yui-dt-selected td.yui-dt-desc {
	background-color:inherit;
	color:inherit;
}        </style>

    </head>
    
    <body>
    
		<p><a href="./">DataWiki</a> - <strong><xforms:output ref="instance('ins-login')/user"/></strong></p>
    	
    	<hr/>
    	
		<h2>Tables</h2>
		
    	<p>
    		<xforms:input ref="instance('ins-table-entry-template')/atom:title">
    			<xforms:label>Title: </xforms:label>
    			<xforms:send ev:event="DOMActivate" submission="sub-post-table-entry"/>
    		</xforms:input>
    		<xforms:submit submission="sub-post-table-entry">
    			<xforms:label><img src="/apps/fr/style/new.gif"/> New Table</xforms:label>
    		</xforms:submit>
    	</p>

		<xforms:group ref="instance('ins-table-feed')">
  			
   			<fr:datatable 
   				paginated="true" 
   				sortAndPaginationMode="internal" 
   				rowsPerPage="10"
   				maxNbPagesToDisplay="9"
   				>
   			
   				<thead>
   					<tr>
						<th fr:sortable="true" fr:resizeable="true">
							Title
						</th>	    						
						<th fr:sortable="true" fr:resizeable="true">
							Created
						</th>	    						
						<th fr:sortable="true" fr:resizeable="true">
							Updated
						</th>	 
   					</tr>
   				</thead>
   				
   				<tbody>
   					<xforms:repeat nodeset="atom:entry">
   						<tr>
							<td>
								<a href="table/view?entry={atom:link[@rel='edit']/@href}">
									<xforms:output ref="atom:title"/>
								</a>
							</td>	    						
							<td>
								<xforms:output ref="atom:published" xxforms:format="format-dateTime(., '[D01]/[M01]/[Y] - [h01]:[m01]:[s01]')"/>
							</td>	    						
							<td>
								<xforms:output ref="atom:updated" xxforms:format="format-dateTime(., '[D01]/[M01]/[Y] - [h01]:[m01]:[s01]')"/>
							</td>	 
   						</tr>
   					</xforms:repeat>
   				</tbody>
   				
   			</fr:datatable>

		</xforms:group>
		    	
		<h2>Merges</h2>
		
    	<p>
    		<xforms:submit submission="sub-get-new-merge">
    			<xforms:label><img src="/apps/fr/style/new.gif"/> New Merge</xforms:label>
    		</xforms:submit>
    	</p>

		<xforms:group ref="instance('ins-merge-feed')">
  			
   			<fr:datatable 
   				paginated="true" 
   				sortAndPaginationMode="internal" 
   				rowsPerPage="10"
   				maxNbPagesToDisplay="9"
   				>
   			
   				<thead>
   					<tr>
						<th fr:sortable="true" fr:resizeable="true">
							Title
						</th>	    						
						<th fr:sortable="true" fr:resizeable="true">
							Created
						</th>	    						
						<th fr:sortable="true" fr:resizeable="true">
							Updated
						</th>	 
   					</tr>
   				</thead>
   				
   				<tbody>
   					<xforms:repeat nodeset="atom:entry">
   						<tr>
							<td>
								<a href="merge/view?entry={atom:link[@rel='edit']/@href}">
									<xforms:output ref="atom:title"/>
								</a>
							</td>	    						
							<td>
								<xforms:output ref="atom:published" xxforms:format="format-dateTime(., '[D01]/[M01]/[Y] - [h01]:[m01]:[s01]')"/>
							</td>	    						
							<td>
								<xforms:output ref="atom:updated" xxforms:format="format-dateTime(., '[D01]/[M01]/[Y] - [h01]:[m01]:[s01]')"/>
							</td>	 
   						</tr>
   					</xforms:repeat>
   				</tbody>
   				
   			</fr:datatable>

		</xforms:group>
		    	
    	
    </body>
</html>
