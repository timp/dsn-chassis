<?oxygen NVDLSchema="../../../../../../../oxygen/samples/nvdl/xhtml-xforms-11-orbeon.nvdl"?>
<div 
	xmlns="http://www.w3.org/1999/xhtml" 
	xmlns:xforms="http://www.w3.org/2002/xforms" 
	xmlns:ev="http://www.w3.org/2001/xml-events"
	xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
	xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
	xmlns:atombeat="http://purl.org/atombeat/xmlns">
	
	<p><a href="upload-curated-files?study={instance('ins-study-entry')/atom:link[@rel='edit']/@href}">Upload Curated Files</a></p>
	
	<h2>Submitted Files</h2>
    
    <xforms:group ref="instance('ins-submitted-media-feed')[empty(atom:entry)]">
    	<p>No files have been submitted.</p>
    </xforms:group>
    
    <xforms:group ref="instance('ins-submitted-media-feed')[exists(atom:entry)]">

    	<fr:datatable paginated="false">
    		<thead>
    			<tr>
    				<th fr:sortable="true" fr:resizeable="true">Code</th>
    				<th fr:sortable="true" fr:resizeable="true">File Name</th>
    				<th fr:sortable="true" fr:resizeable="true">Date Submitted</th>
    				<th fr:sortable="true" fr:resizeable="true">Submitted By</th>
    				<th fr:sortable="true" fr:resizeable="true">Type</th>
    				<th>Actions</th>
    			</tr>
    		</thead>
    		<tbody>
    			<!-- will not try to use xxforms:sort on nodeset because it causes problems with datatable sorting by file type column -->
    			<xforms:repeat id="rep-submitted-media" nodeset="atom:entry">
    				<tr>
    					<td>
    						<xforms:output ref="manta:id"/>
    					</td>
    					<td>
    						<xforms:output ref="atom:title"/>
    					</td>
    					<td>
    						<xforms:output ref="atom:published" xxforms:format="format-dateTime(., '[Y0001]-[M01]-[D01]')"/>
    					</td>
    					<td>
    						<xforms:output ref="atom:author/atom:email"/>
    					</td>
    					<td>
    						<xforms:output ref="
    							for $cat in (./atom:category[@scheme='http://www.cggh.org/2010/chassis/scheme/FileTypes'])
    							return
    								if ( $cat/@term = 'http://www.cggh.org/2010/chassis/terms/Other' )
    								then $cat/@label
    								else instance('ins-file-terms')/term[value=$cat/@term]/label
							"/>
    					</td>
    					<td>
    						<xforms:group ref=".[contains( ./atom:link[@rel='edit-media']/@atombeat:allow , 'GET' )]">
    							<a href="{atom:content/@src}">Download</a><br/>
    						</xforms:group>
    						<a href="file-details?media-link={atom:link[@rel='edit']/@href}">Details</a>
    					</td>
    				</tr>
    			</xforms:repeat>
    		</tbody>
    	</fr:datatable>
	    	
	</xforms:group>

	<h2>Curated Files</h2>
	
	<xforms:group ref="instance('ins-curated-media-feed')[empty(atom:entry)]">
		<p>There are no curated files.</p>
	</xforms:group>
	
	<xforms:group ref="instance('ins-curated-media-feed')[exists(atom:entry)]">
		
		<fr:datatable paginated="false">
			<thead>
				<tr>
					<th fr:sortable="true" fr:resizeable="true">Code</th>
					<th fr:sortable="true" fr:resizeable="true">File Name</th>
					<th fr:sortable="true" fr:resizeable="true">Date Submitted</th>
					<th fr:sortable="true" fr:resizeable="true">Curated By</th>
					<th fr:sortable="true" fr:resizeable="true">Type</th>
					<th>Actions</th>
				</tr>
			</thead>
			<tbody>
				<!-- will not try to use xxforms:sort on nodeset because it causes problems with datatable sorting by file type column -->
				<xforms:repeat id="rep-curated-media" nodeset="atom:entry">
					<tr>
						<td>
							<xforms:output ref="manta:id"/>
						</td>
						<td>
							<xforms:output ref="atom:title"/>
						</td>
						<td>
							<xforms:output ref="atom:published" xxforms:format="format-dateTime(., '[Y0001]-[M01]-[D01]')"/>
						</td>
						<td>
							<xforms:output ref="atom:author/atom:email"/>
						</td>
						<td>
							<xforms:output ref="
								for $cat in (./atom:category[@scheme='http://www.cggh.org/2010/chassis/scheme/FileTypes'])
								return
									if ( $cat/@term = 'http://www.cggh.org/2010/chassis/terms/Other' )
									then $cat/@label
									else instance('ins-file-terms')/term[value=$cat/@term]/label
								"/>
						</td>
						<td>
							<xforms:group ref=".[contains( ./atom:link[@rel='edit-media']/@atombeat:allow , 'GET' )]">
								<a href="{atom:content/@src}">Download</a><br/>
							</xforms:group>
							<a href="file-details?media-link={atom:link[@rel='edit']/@href}">Details</a>
						</td>
					</tr>
				</xforms:repeat>
			</tbody>
		</fr:datatable>
		
	</xforms:group>
	
</div>