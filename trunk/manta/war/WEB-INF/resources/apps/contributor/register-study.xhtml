<!--
  Copyright (C) 2010 University of Oxford.
  
  This program is free software; you can redistribute it and/or modify it under the terms of the
  GNU Lesser General Public License as published by the Free Software Foundation; either version
  2.1 of the License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
  without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  See the GNU Lesser General Public License for more details.

  The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
  -->
<html 
	xmlns:xforms="http://www.w3.org/2002/xforms"
    xmlns:f="http://orbeon.org/oxf/xml/formatting" 
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:atom="http://www.w3.org/2005/Atom"
    xmlns:xi="http://www.w3.org/2001/XInclude"
    xmlns:manta="http://www.cggh.org/2010/chassis/manta/xmlns">

    <head>
    
        <title>Register Study</title>
        
        <xforms:model id="mod-main">

        	<!-- xincludes don't parse within instance sources. -->
        	<!--   <xforms:instance id="ins-draft-entry" src="/apps/contributor/includes/model-instances/draft-entry.xml"/> -->
        	<!--  The temptation is to factor out instances to centralised file sources, but then you can't put includes in them. -->
        	
        	<!-- This is used to create a new draft (upon the first next press?). -->
       		<xforms:instance id="ins-draft-entry-template">
       			<atom:entry xmlns:atom="http://www.w3.org/2005/Atom">
       				<atom:title type="text" />
       				<atom:content type="application/vnd.chassis-manta+xml">
			        	<draft xmlns="">
							<wizard-pane>study-terms</wizard-pane>
							<terms>terms go here</terms>
							<agreement-to-terms/>
							<study-entry-container>
								<xi:include href="/apps/common/templates/study/study-entry-template.xml"/>
							</study-entry-container>
							<acl-entry-container>
								<xi:include href="/apps/contributor/includes/acl-entry.xml"/>
							</acl-entry-container>
						</draft>
        			</atom:content>
       			</atom:entry>
  			</xforms:instance>	        

			<!-- additional model for adding a new acknowledgement (used to add the current user and add more in the acknowledgement pane) -->
			<xforms:instance id="ins-person-template" src="/apps/common/templates/study/person-template.xml"/>

			<!-- This adds the current user (email) to the acknowledgements in the draft template. -->
			<xforms:action ev:event="xforms-model-construct-done">
				<xforms:insert 
					context="instance('ins-draft-entry-template')/atom:content/draft/study-entry-container/atom:entry/atom:content/study/acknowledgements" 
					nodeset="person"
					at="1"
					position="after"
					origin="instance('ins-person-template')"/>
				<xforms:setvalue 
					ref="instance('ins-draft-entry-template')/atom:content/draft/study-entry-container/atom:entry/atom:content/study/acknowledgements/person[1]/email"
					value="xxforms:get-remote-user()"/>
			</xforms:action>

			<!-- This adds the current user as an administrator to the ACL in the draft template.  -->
			<xforms:action 
           		ev:event="xforms-model-construct-done">
           		<xforms:setvalue ref="instance('ins-draft-entry-template')/atom:content/draft/acl-entry-container/atom:entry/atom:content/acl/groups/group[@name='administrators']/user" value="xxforms:get-remote-user()"/>
			</xforms:action>







        
        	<!-- This is used to store a draft during the wizard. -->
			<xforms:instance id="ins-draft-entry">
				<atom:entry xmlns:atom="http://www.w3.org/2005/Atom"/>
        	</xforms:instance>        	
        

        	<!-- bindings for the study-terms pane -->
			<xforms:bind nodeset="instance('ins-draft-entry')/atom:content/draft/agreement-to-terms" required="true()"/>
			<xforms:bind nodeset="instance('ins-draft-entry')/atom:content/draft/study-entry-container/atom:entry/atom:title" required="true()"/>

			<!-- This prevents the first user (current user) from removing themselves as an administrator from the ACL in the draft. -->
			<xforms:bind nodeset="instance('ins-draft-entry')/atom:content/draft/acl-entry-container/atom:entry/atom:content/acl/groups/group[@name='administrators']">
                <xforms:bind nodeset="user[1]" readonly="true()"/>
            </xforms:bind>





			<!-- additional model for the permissions pane -->
       		<xforms:instance id="ins-user-template">
       			<user xmlns=""></user>
  			</xforms:instance>







			


       		<!-- Add this model when we get to publications. -->
       		
       		<!-- 
       			<xforms:instance id="ins-publication-template" src="/apps/common/templates/study/publication-template.xml"/>
       		 -->
       		

			
			<!-- Add these bindings when we get to publications. -->
			<!-- 
        	
        	<xforms:bind nodeset="instance('ins-draft-entry')/study-entry-container/atom:entry">

				<xi:include href="/apps/common/includes/study/publications-xforms-bindings.xml"/>
				       			
       		</xforms:bind>

			 -->


			<!-- Try to get the saved draft when the model has been constructed. -->
			<xforms:send ev:event="xforms-model-construct-done" submission="sub-get-draft-entry" />

			<!-- This tries to get the current draft (by request-parameter) and sends for a new draft if it fails. -->
			<xforms:submission 
				id="sub-get-draft-entry"
				action="{xxforms:get-request-parameter('draft')}"
				method="get"
				replace="instance"
				instance="ins-draft-entry">

                <!-- If there is an error, then make a new draft. -->
                <xforms:send ev:event="xforms-submit-error" submission="sub-post-draft-entry"/>
                
			</xforms:submission>  
			

			<!-- This creates a new draft (based on a template) and stores it in the draft-entry instance. -->
            <xforms:submission 
            	id="sub-post-draft-entry" 
            	ref="instance('ins-draft-entry-template')"
                resource="/atombeat/content/drafts"
                method="post" 
                replace="instance" 
                instance="ins-draft-entry"
                mediatype="application/atom+xml">
                <xforms:message ev:event="xforms-submit-error" level="modal">An error occurred (<xforms:output value="event('error-type')"/>) while creating a new draft.</xforms:message>
            </xforms:submission>
           
			
			<!-- get this working, then we can test get-draft-entry -->
			<!-- why is there an error saving the draft? -->
            <xforms:submission 
            	id="sub-put-draft-entry" 
            	ref="instance('ins-draft-entry')"
                resource="{instance('ins-draft-entry')/atom:link[@rel='edit']/@href}"
                method="put" 
                replace="instance" 
                instance="ins-draft-entry"
                mediatype="application/atom+xml"> 
                <xforms:setvalue ev:event="xforms-submit-done" ref="instance('ins-draft-entry')/atom:content/draft/wizard-pane" value="'permissions'"/>
                <xforms:message ev:event="xforms-submit-error" level="modal">An error occurred (<xforms:output value="event('error-type')"/>) while saving the draft.</xforms:message>
            </xforms:submission>

			<!-- failing on the second put, because haven't got an edit link -->






            

        </xforms:model>

       	<!-- <xi:include href="/apps/common/includes/study/questionnaire-xforms-model.xml"/> -->
       	<!-- <xi:include href="/apps/common/includes/current-user-xforms-model.xml"/> -->

        
    </head>
    
    <body>
    
		<!-- <xi:include href="/apps/common/includes/current-user-actions.xml"/>
		 -->

	    	<h1>Register Study</h1>
	    	
	    	
	    	<xforms:group ref="instance('ins-draft-entry')/atom:content/draft[wizard-pane='study-terms']">
	    		<xi:include href="/apps/contributor/includes/wizard-panes/study-terms.xml"/>
	    	</xforms:group>
	    	
	    	<xforms:group ref="instance('ins-draft-entry')/atom:content/draft[wizard-pane='permissions']">
	    		<xi:include href="/apps/contributor/includes/wizard-panes/permissions.xml"/>
	    	</xforms:group>
	    	
	    	<xforms:group ref="instance('ins-draft-entry')/atom:content/draft[wizard-pane='acknowledgements']">
	    		<xi:include href="/apps/contributor/includes/wizard-panes/acknowledgements.xml"/>
	    	</xforms:group>
	    	
	    	<xforms:group ref="instance('ins-draft-entry')/atom:content/draft[wizard-pane='upload-files']">
	    		<xi:include href="/apps/contributor/includes/wizard-panes/upload-files.xml"/>
	    	</xforms:group>
	    	
	    	<xforms:group ref="instance('ins-draft-entry')/atom:content/draft[wizard-pane='publications']">
	    		<xi:include href="/apps/contributor/includes/wizard-panes/publications.xml"/>
	    	</xforms:group>
	    	
	    	<xforms:group ref="instance('ins-draft-entry')/atom:content/draft[wizard-pane='review']">
	    		<xi:include href="/apps/contributor/includes/wizard-panes/review.xml"/>
	    	</xforms:group>
	    	
	    	<xforms:group ref="instance('ins-draft-entry')/atom:content/draft[wizard-pane='confirmation']">
	    		<xi:include href="/apps/contributor/includes/wizard-panes/confirmation.xml"/>
	    	</xforms:group>

    </body>
    
</html>

