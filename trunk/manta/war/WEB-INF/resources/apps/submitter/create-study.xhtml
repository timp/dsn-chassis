<!--
  Copyright (C) 2010 University of Oxford.
  
  This program is free software; you can redistribute it and/or modify it under the terms of the
  GNU Lesser General Public License as published by the Free Software Foundation; either version
  2.1 of the License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
  without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  See the GNU Lesser General Public License for more details.

  The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
  -->
<html 
	xmlns:xforms="http://www.w3.org/2002/xforms"
    xmlns:f="http://orbeon.org/oxf/xml/formatting" 
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:atom="http://www.w3.org/2005/Atom"
    xmlns:xi="http://www.w3.org/2001/XInclude"
    xmlns:manta="http://www.cggh.org/2010/chassis/manta/xmlns">

    <head>
    
        <title>Manta Data Management - Submitter - Create Study</title>
        <link rel="stylesheet" type="text/css" href="/apps/submitter/common/style.css"></link>
        <link rel="stylesheet" type="text/css" href="/ops/yui/tabview/assets/skins/sam/tabview.css"></link>
        
        <xforms:model id="mod-main">
        
        
        
        	<!--+
        		|
        		| The main instance holding the atom entry document to be POSTed to the
        		| studies collection.
        		|
        		+-->
        		
        	<xforms:instance id="ins-study-entry" src="/apps/common/templates/study/study-entry-template.xml"/>
       		
       		
       		
        	<!--+
        		|
        		| Form bindings for the main atom entry document.
        		|
        		+-->

       		<xforms:bind nodeset="instance('ins-study-entry')">
       		
       			<!-- the title is required -->
       			<xforms:bind nodeset="atom:title" required="true()"/>
       			
				<xi:include href="/apps/common/includes/study/publications-xforms-bindings.xml"/>
				       			
       		</xforms:bind>
       	
       		
       		
       		<!--+
        		|
        		| Template instance for additional publications.
        		|
        		+-->
       		
       		<xforms:instance id="ins-publication-template" src="/apps/common/templates/study/publication-template.xml"/>
       		


        	<!--+
        		|
        		| The ACL document to set once the study is created.
        		|
        		+-->

       		<xforms:instance id="ins-acl">
       			<atom:entry>
       				<atom:content type="application/vnd.atombeat+xml">
		       			<acl xmlns="">
		       				<groups>
		       					<group name="owners">
		       						<user></user>
		       					</group>
		       					<group name="submitters">
		       					</group>
		   					</groups>
				    		<rules>
				    		    <!-- owners can retrieve, update and change sharing -->
				                <allow>
				                    <group>owners</group>
				                    <operation>retrieve-member</operation>
				                </allow>
				                <allow>
				                    <group>owners</group>
				                    <operation>update-member</operation>
				                </allow>
				                <allow>
				                    <group>owners</group>
				                    <operation>update-acl</operation>
				                </allow>
				                <!-- submitters can retrieve and update, but cannot change sharing -->
				                <allow>
				                    <group>submitters</group>
				                    <operation>retrieve-member</operation>
				                </allow>
				                <allow>
				                    <group>submitters</group>
				                    <operation>update-member</operation>
				                </allow>
				    		</rules>
		   				</acl>
       				</atom:content>
       			</atom:entry>
       		</xforms:instance>



			<!--+
				|
				| Template instance for additional users.
				|
				+-->       		

       		<xforms:instance id="ins-user-template">
       			<user xmlns=""></user>
  			</xforms:instance>

       		<xforms:instance id="ins-person-template" src="/apps/common/templates/study/person-template.xml"/>
			
			
			<!--+
				|
				| Binding for the ACL document to ensure that the current user cannot
				| remove themselves as owner.
				|
				+-->       		
			       		
       		<xforms:bind nodeset="instance('ins-acl')//groups/group[@name='owners']">
                <xforms:bind nodeset="user[1]" readonly="true()"/>
            </xforms:bind>
            
            
       		
			<!--+
				|
				| Control instance to allow disabling of previous button at first step.
				|
				+-->       		
			       		
       		<xforms:instance id="ins-control">
                <ins-control xmlns="">
                </ins-control>
            </xforms:instance>
        	
            
			<!--+
				|
				| Action to set current user as first owner in ACL document by default.
				|
				+-->       		
			       		
           <xforms:action 
           		ev:event="xforms-model-construct-done">
           		<xforms:setvalue ref="instance('ins-acl')//groups/group[@name='owners']/user" value="xxforms:get-remote-user()"/>
           </xforms:action>
           
           
           <xforms:action ev:event="xforms-model-construct-done">
				<xforms:insert 
					context="instance('ins-study-entry')/atom:content/study/acknowledgements" 
					nodeset="person"
					at="1"
					position="after"
					origin="instance('ins-person-template')"
					/>
				<xforms:setvalue 
					ref="instance('ins-study-entry')/atom:content/study/acknowledgements/person[1]/email"
					value="xxforms:get-remote-user()"/>
           </xforms:action>



            <!--+
            	|
            	| Submission to create a study entry. 
            	|
            	+-->
            	
            <xforms:submission 
            	id="sub-post-study-entry" 
            	ref="instance('ins-study-entry')"
                resource="/atombeat/content/studies"
                method="post" 
                replace="instance" 
                instance="ins-study-entry"
                mediatype="application/atom+xml">
                <xforms:send ev:event="xforms-submit-done" submission="sub-put-acl"/>
                <xforms:message ev:event="xforms-submit-error" level="modal">An error occurred (<xforms:output value="event('error-type')"/>) while saving.</xforms:message>
            </xforms:submission>
            
            

            <!--+
            	|
            	| Submission to update the ACL after study is created. 
            	|
            	+-->
            	
            <xforms:submission 
            	id="sub-put-acl" 
            	ref="instance('ins-acl')"
                resource="{instance('ins-study-entry')/atom:link[@rel='edit-acl']/@href}"
                method="put" 
                replace="instance" 
                instance="ins-acl"
                mediatype="application/atom+xml">
                <xforms:toggle ev:event="xforms-submit-done" case="success"/>
				<!-- copy data across to study questionnaire model -->	
				<xforms:insert ev:event="xforms-submit-done" nodeset="xxforms:instance('ins-sq-study-entry')" origin="instance('ins-study-entry')"/>
                <xforms:message ev:event="xforms-submit-error" level="modal">An error occurred (<xforms:output value="event('error-type')"/>) while saving.</xforms:message>
            </xforms:submission>
            
            

        </xforms:model>

       	<xi:include href="/apps/common/includes/study/questionnaire-xforms-model.xml"/>
       	<xi:include href="/apps/common/includes/current-user-xforms-model.xml"/>
            

        
        <style type="text/css">
        </style>
        
    </head>
    
    <body>
    
		<xi:include href="/apps/common/includes/current-user-actions.xml"/>

		<!--+
			|
			| Main page content.
			|
			+-->       		
			       		
    	<div id="content">
    	
	    	<h1><a href="home">Submitter</a> - Create Study</h1>

	    	<xforms:switch>
	    		


				<!--+
					|
					| Step 1 - Study Title
					| ********************
					|
					+-->       		
			       		
	    		<xforms:case id="title" selected="true">

				   	<div class="help">
				   		<h2>Help</h2>
				   		<p>TODO guidance on titles</p>
				   	</div>
				   	
	    		
		            <table cellpadding="3" class="wizard">
		                <tr>
		                    <td rowspan="3" class="wizard-td">1</td>
		                    <td colspan="1"><b>Step 1 of 5 - Study Title</b></td>
		                </tr>
		                <tr>
		                    <td>
		                    
		                        <xforms:input ref="instance('ins-study-entry')/atom:title">
		                            <xforms:label class="fixed-width">Title:</xforms:label>
		                            <xforms:alert>The title is required.</xforms:alert>
		                            <xforms:toggle ev:event="DOMActivate" case="publications"/>
		                        </xforms:input>
		                        
		                    </td>
		                </tr>
		                <tr>
		                    <td>
		                        <xforms:trigger>
		                            <xforms:label>Next ></xforms:label>
		                            <xforms:toggle ev:event="DOMActivate" case="acknowledgements"/>
		                        </xforms:trigger>
		                    </td>
		                </tr>
		            </table>
                    <xforms:trigger appearance="minimal">
                        <xforms:label>skip to end >></xforms:label>
                        <xforms:toggle ev:event="DOMActivate" case="confirm"/>
                    </xforms:trigger>
	
	    		</xforms:case>



				<!--+
					|
					| Step 3 - Acknowledgements
					| *************************
					|
					+-->       		
			       		
	    		<xforms:case id="acknowledgements">

				   	<div class="help">
				   		<h2>Help</h2>
				   		<p>TODO</p>
				   	</div>
				   	
	    		
		            <table cellpadding="3" class="wizard">
		                <tr>
		                    <td rowspan="3" class="wizard-td">2</td>
		                    <td colspan="1"><b>Step 2 of 5 - Acknowledgements</b></td>
		                </tr>
		                <tr>
		                    <td>
		                    
			    				<xforms:group ref="instance('ins-study-entry')/atom:content/study">
			
			    					<xi:include href="/apps/common/includes/study/acknowledgements-xforms-input.xml"/>
			    					
			    				</xforms:group>

		                    </td>
		                </tr>
		                <tr>
		                    <td>
		                        <xforms:trigger>
		                            <xforms:label>&lt; Previous</xforms:label>
		                            <xforms:toggle ev:event="DOMActivate" case="title"/>
		                        </xforms:trigger>
		                        <xforms:trigger>
		                            <xforms:label>Next ></xforms:label>
		                            <xforms:toggle ev:event="DOMActivate" case="publications"/>
		                        </xforms:trigger>
		                    </td>
		                </tr>
		            </table>
                    <xforms:trigger appearance="minimal">
                        <xforms:label>skip to end >></xforms:label>
                        <xforms:toggle ev:event="DOMActivate" case="confirm"/>
                    </xforms:trigger>
		            
	    		</xforms:case>




				<!--+
					|
					| Step 3 - Publications
					| *********************
					|
					+-->       		
			       		
	    		<xforms:case id="publications">

				   	<div class="help">
				   		<h2>Help</h2>
				   		<p>TODO</p>
				   	</div>
				   	
	    		
		            <table cellpadding="3" class="wizard">
		                <tr>
		                    <td rowspan="3" class="wizard-td">3</td>
		                    <td colspan="1"><b>Step 3 of 5 - Publications</b></td>
		                </tr>
		                <tr>
		                    <td>
		                    
		                    	<xforms:group ref="instance('ins-study-entry')/atom:content/study">
		                    	
									<xi:include href="/apps/common/includes/study/publications-xforms-input.xml"/>
				
								</xforms:group>								
		                    </td>
		                </tr>
		                <tr>
		                    <td>
		                        <xforms:trigger>
		                            <xforms:label>&lt; Previous</xforms:label>
		                            <xforms:toggle ev:event="DOMActivate" case="acknowledgements"/>
		                        </xforms:trigger>
		                        <xforms:trigger>
		                            <xforms:label>Next ></xforms:label>
		                            <xforms:toggle ev:event="DOMActivate" case="permissions"/>
		                        </xforms:trigger>
		                    </td>
		                </tr>
		            </table>
                    <xforms:trigger appearance="minimal">
                        <xforms:label>skip to end >></xforms:label>
                        <xforms:toggle ev:event="DOMActivate" case="confirm"/>
                    </xforms:trigger>
		            
	    		</xforms:case>



				<!--+
					|
					| Step 4 - Permissions
					| ********************
					|
					+-->       		
	
	    		<xforms:case id="permissions">

				   	<div class="help">
				   		<h2>Help</h2>
				   		<p><strong>Owners</strong> have all permissions. 
				   		This includes modifying permissions, submitting files and modifying the study questionnaire.</p>
				   		<p><strong>Submitters</strong> can submit files and modify the study questionnaire.</p>
				   	</div>
				   	
		            <table cellpadding="3" class="wizard">
		                <tr>
		                    <td rowspan="3" class="wizard-td">4</td>
		                    <td colspan="1"><b>Step 4 of 5 - Permissions</b></td>
		                </tr>
		                <tr>
		                    <td>
		                    	<h2>Owners</h2>
		                    	<xforms:group ref="instance('ins-acl')//groups/group[@name='owners']">
									<table class="repeat-table">
										<tr>
											<td>
							                    <xforms:trigger appearance="minimal">
							                        <xforms:label><img src="/apps/submitter/common/add.gif"/></xforms:label>
							                        <xforms:insert 
							                        	ev:event="DOMActivate" 
							                        	context="." 
							                        	nodeset="user" 
							                        	at="1" 
							                        	position="after" 
							                        	origin="instance('ins-user-template')"/>
							                    </xforms:trigger>
											</td>
											<td class="add-td">
							                    <xforms:trigger appearance="minimal">
							                        <xforms:label>Add an Owner</xforms:label>
							                        <xforms:insert 
							                        	ev:event="DOMActivate" 
							                        	context="." 
							                        	nodeset="user" 
							                        	at="1" 
							                        	position="after" 
							                        	origin="instance('ins-user-template')"/>
							                    </xforms:trigger>
											</td>
										</tr>
										<xforms:repeat nodeset="user" id="rep-owner">
											<tr>
												<td>
							                        <xforms:trigger ref="." appearance="minimal">
							                            <xforms:delete 
							                            	ev:event="DOMActivate" 
								                        	context="." 
								                        	nodeset="." 
							                            	at="index('rep-owner')"/>
							                            <xforms:label><img src="/apps/submitter/common/remove.gif"/></xforms:label>
							                        </xforms:trigger>
												</td>
												<td class="form-td">
													<xforms:input ref=".">
														<xforms:label class="fixed-width">Email address:</xforms:label>
													</xforms:input>
												</td>
											</tr>
										</xforms:repeat>
									</table>
		                    	</xforms:group>

		                    	<h2>Submitters</h2>
		                    	
		                    	<xforms:group ref="instance('ins-acl')//groups/group[@name='submitters']">
									<table class="repeat-table">
										<tr>
											<td>
							                    <xforms:trigger appearance="minimal">
							                        <xforms:label><img src="/apps/submitter/common/add.gif"/></xforms:label>
							                        <xforms:insert 
							                        	ev:event="DOMActivate" 
							                        	context="." 
							                        	nodeset="user" 
							                        	at="1" 
							                        	position="after" 
							                        	origin="instance('ins-user-template')"/>
							                    </xforms:trigger>
											</td>
											<td class="add-td">
							                    <xforms:trigger appearance="minimal">
							                        <xforms:label>Add a Submitter</xforms:label>
							                        <xforms:insert 
							                        	ev:event="DOMActivate" 
							                        	context="." 
							                        	nodeset="user" 
							                        	at="1" 
							                        	position="after" 
							                        	origin="instance('ins-user-template')"/>
							                    </xforms:trigger>
											</td>
										</tr>
										<xforms:repeat nodeset="user" id="rep-submitter">
											<tr>
												<td>
							                        <xforms:trigger appearance="minimal">
							                            <xforms:delete 
							                            	ev:event="DOMActivate" 
								                        	context="." 
								                        	nodeset="." 
							                            	at="index('rep-submitter')"/>
							                            <xforms:label><img src="/apps/submitter/common/remove.gif"/></xforms:label>
							                        </xforms:trigger>
												</td>
												<td class="form-td">
													<xforms:input ref=".">
														<xforms:label class="fixed-width">Email address:</xforms:label>
													</xforms:input>
												</td>
											</tr>
										</xforms:repeat>
									</table>
		                    	</xforms:group>
		                    </td>
		                </tr>
		                <tr>
		                    <td>
		                        <xforms:trigger>
		                            <xforms:label>&lt; Previous</xforms:label>
		                            <xforms:toggle ev:event="DOMActivate" case="publications"/>
		                        </xforms:trigger>
		                        <xforms:trigger>
		                            <xforms:label>Next ></xforms:label>
		                            <xforms:toggle ev:event="DOMActivate" case="confirm"/>
		                        </xforms:trigger>
		                    </td>
		                </tr>
		            </table>
                    <xforms:trigger appearance="minimal">
                        <xforms:label>skip to end >></xforms:label>
                        <xforms:toggle ev:event="DOMActivate" case="confirm"/>
                    </xforms:trigger>

	    		</xforms:case>
	


				<!--+
					|
					| Step 5 - Confirm
					| ****************
					|
					+-->       		
			       		
	    		<xforms:case id="confirm">

				   	<div class="help">
				   		<h2>Help</h2>
				   		<p>TODO</p>
				   	</div>
				   	
		            <table cellpadding="3" class="wizard">
		                <tr>
		                    <td rowspan="3" class="wizard-td">5</td>
		                    <td colspan="1"><b>Step 5 of 5 - Review and Confirm</b></td>
		                </tr>
		                <tr>
		                    <td>
		                    	<h2>1. Study Title
		                    		<span class="mini-action">
				                        <xforms:trigger appearance="minimal">
				                        	<xforms:label>[edit]</xforms:label>
				                            <xforms:toggle ev:event="DOMActivate" case="title"/>
			                            </xforms:trigger>
		                            </span>
		                    	</h2>
		                        <strong><xforms:output value="instance('ins-study-entry')/atom:title"/></strong>
		                        <xforms:group ref="instance('ins-study-entry')/atom:title[empty(text())]">
		                        	(empty)
		                        </xforms:group>
		                        
		                        <h2>2. Acknowledgements
		                    		<span class="mini-action">
				                        <xforms:trigger appearance="minimal">
				                        	<xforms:label>[edit]</xforms:label>
				                            <xforms:toggle ev:event="DOMActivate" case="acknowledgements"/>
			                            </xforms:trigger>
		                            </span>
		                        </h2>
		                        
		                    	<xforms:group ref="instance('ins-study-entry')/atom:content/study/acknowledgements">
		                    	
									<table class="repeat-table">
										<xforms:repeat nodeset="person">
											<tr>
												<td class="form-td">
													<xforms:output value="given-name"/>
													<xforms:output value="family-name"/>
													- <xforms:output value="email"/>
													- <xforms:output value="organisation"/>
												</td>
											</tr>
										</xforms:repeat>
									</table>
									
								</xforms:group>		                        

		                    	<xforms:group ref="instance('ins-study-entry')/atom:content/study/acknowledgements[empty(person)]">
									no acknowledgements									
								</xforms:group>		                        
		                        
		                        <h2>
		                        	3. Publications
		                    		<span class="mini-action">
				                        <xforms:trigger appearance="minimal">
				                        	<xforms:label>[edit]</xforms:label>
				                            <xforms:toggle ev:event="DOMActivate" case="publications"/>
			                            </xforms:trigger>
		                            </span>
		                        </h2>
		                        
		                    	<xforms:group ref="instance('ins-study-entry')/atom:content/study">
		                    	
									<xforms:group ref="publications">
									
										<table class="repeat-table">
											<xforms:repeat nodeset="publication">
												<tr>
													<td class="form-td">
														<xforms:output value="title">
															<xforms:label class="fixed-width">Title:</xforms:label>
														</xforms:output>
														<br/>
														<xforms:output value="first-author">
															<xforms:label class="fixed-width">First author:</xforms:label>
														</xforms:output>
														<br/>
														<xforms:output value="year">
															<xforms:label class="fixed-width">Year:</xforms:label>
														</xforms:output>
														<br/>
														<xforms:output value="journal">
															<xforms:label class="fixed-width">Journal:</xforms:label>
														</xforms:output>
														<br/>
														<xforms:output value="url">
															<xforms:label class="fixed-width">Web link:</xforms:label>
														</xforms:output>
														<br/>
														<xforms:output value="doi">
															<xforms:label class="fixed-width">DOI:</xforms:label>
														</xforms:output>
														<br/>
													</td>
												</tr>
											</xforms:repeat>
										</table>
									
									</xforms:group>
									
									<xforms:group ref="publications[empty(publication)]">
									no publications
									</xforms:group>

		                    	</xforms:group>

		                    	<h2>
			                    	4. Permissions 
			                    	<span class="mini-action">
				                        <xforms:trigger appearance="minimal">
				                        	<xforms:label>[edit]</xforms:label>
				                            <xforms:toggle ev:event="DOMActivate" case="permissions"/>
			                            </xforms:trigger>
		                            </span>
		                    	</h2>
		                    	
		                    	<h3>Owners</h3>
								<table class="repeat-table">
									<xforms:repeat nodeset="instance('ins-acl')//groups/group[@name='owners']/user">
										<tr>
											<td class="form-td">
												<xforms:output value=".">
												</xforms:output>
											</td>
										</tr>
									</xforms:repeat>
								</table>
		                    	<h3>Submitters</h3>
								<table class="repeat-table">
									<xforms:repeat nodeset="instance('ins-acl')//groups/group[@name='submitters']/user">
										<tr>
											<td class="form-td">
												<xforms:output value=".">
												</xforms:output>
											</td>
										</tr>
									</xforms:repeat>
								</table>
								<xforms:group ref="instance('ins-acl')//groups/group[@name='submitters' and empty(user)]">
								no submitters
								</xforms:group>

		                    </td>
		                </tr>
		                <tr>
		                    <td>
		                        <xforms:trigger>
		                            <xforms:label>&lt; Previous</xforms:label>
		                            <xforms:toggle ev:event="DOMActivate" case="permissions"/>
		                        </xforms:trigger>
			                    <xforms:submit submission="sub-post-study-entry">
			                        <xforms:label>Confirm</xforms:label>
			                    </xforms:submit>
		                    </td>
		                </tr>
		            </table>
	    		</xforms:case>
	    		
				<!--+
					|
					| Success Case
					| ************
					|
					+-->       		
			       		
	    		<xforms:case id="success">
	    		
				   	<div class="help">
				   		<h2>Help</h2>
	                  	<p>You can also <strong><a href="study-summary?study={instance('ins-study-entry')/atom:link[@rel='edit']/@href}">review and modify</a></strong> any of the information you have provided for your study at any time, just click on your unique study code - <strong><a href="study-summary?study={instance('ins-study-entry')/atom:link[@rel='edit']/@href}"><xforms:output value="instance('ins-study-entry')/manta:id"/></a></strong>.</p>
						<p>Other links: <a href="home">Submitter Home</a> | <a href="study-summary?study={instance('ins-study-entry')/atom:link[@rel='edit']/@href}">Study <xforms:output value="instance('ins-study-entry')/manta:id"/></a> | <a href="submit-files?study={instance('ins-study-entry')/atom:link[@rel='edit']/@href}">Submit Files</a> | <a href="create-study">Create Another Study</a></p>
				   	</div>
				   	
	    			<h2>Success</h2>
	    			
	    			<p>Thank you for registering your study - <strong><xforms:output value="instance('ins-study-entry')/atom:title"/></strong>.</p>
	    			<p>Your study has been assigned the unique study code <strong><a href="study-summary?study={instance('ins-study-entry')/atom:link[@rel='edit']/@href}"><xforms:output value="instance('ins-study-entry')/manta:id"/></a></strong>.</p>
                   
                   	<h3>What Next? ... <a href="submit-files?study={instance('ins-study-entry')/atom:link[@rel='edit']/@href}">Submit Files</a></h3>
                   
                    <ul>
                    	<li>You can now <strong><a href="submit-files?study={instance('ins-study-entry')/atom:link[@rel='edit']/@href}">submit files</a></strong> containing data, dictionaries, protocols or publications.</li>
                    </ul>

	    		</xforms:case>
	    		
	
	    	</xforms:switch>
	    	
		</div>

    </body>
    
</html>

