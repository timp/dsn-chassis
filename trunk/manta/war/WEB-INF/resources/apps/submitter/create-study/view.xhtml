<!--
  Copyright (C) 2010 University of Oxford.
  
  This program is free software; you can redistribute it and/or modify it under the terms of the
  GNU Lesser General Public License as published by the Free Software Foundation; either version
  2.1 of the License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
  without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  See the GNU Lesser General Public License for more details.

  The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
  -->
<html 
	xmlns:xforms="http://www.w3.org/2002/xforms"
    xmlns:f="http://orbeon.org/oxf/xml/formatting" 
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:atom="http://www.w.org/2005/Atom">

    <head>
    
        <title>WWARN Data Management - Submitter - Create Study</title>
        <link rel="stylesheet" type="text/css" href="/apps/submitter/common/style.css"></link>
        
        <xforms:model>
        
        	<xforms:instance id="entry">
       			<atom:entry>
       				<atom:title type="text"></atom:title>
       				<atom:content type="application/vnd.chassis-manta+xml">
       					<study xmlns="">
       						<published>false</published>
       						<publications>
				       			<publication>
				       				<title></title>
				       				<first-author></first-author>
				       				<year></year>
				       				<journal></journal>
				       				<url></url>
				       				<doi></doi>
				       			</publication>
       						</publications>
       					</study>
       				</atom:content>
       			</atom:entry>
       		</xforms:instance>
       		
       		<xforms:bind nodeset="instance('entry')">
       			<xforms:bind nodeset="atom:title" required="true()"/>
       			<xforms:bind nodeset="atom:content/study">
       				<xforms:bind nodeset="published" type="xforms:boolean"/>
       				<xforms:bind nodeset="publications" relevant="../published = true()">
       					<xforms:bind nodeset="publication">
       						<xforms:bind nodeset="title" required="true()"/>
       						<xforms:bind nodeset="first-author" required="true()"/>
       						<xforms:bind nodeset="year" required="true()" type="xs:gYear"/>
       						<xforms:bind nodeset="journal" required="true()"/>
       					</xforms:bind>
       				</xforms:bind>
       			</xforms:bind>
       		</xforms:bind>
       		
       		<xforms:instance id="publication-template">
       			<publication xmlns="">
       				<title></title>
       				<first-author></first-author>
       				<year></year>
       				<journal></journal>
       				<url></url>
       				<doi></doi>
       			</publication>
       		</xforms:instance>
       		
       		<xforms:instance id="acl">
       			<acl xmlns="">
       				<groups>
       					<group name="owners">
       						<user></user>
       					</group>
       					<group name="submitters">
       					</group>
   					</groups>
		    		<rules>
		    		    <!-- owners can retrieve, update and change sharing -->
		                <allow>
		                    <group>owners</group>
		                    <operation>retrieve-member</operation>
		                </allow>
		                <allow>
		                    <group>owners</group>
		                    <operation>update-member</operation>
		                </allow>
		                <allow>
		                    <group>owners</group>
		                    <operation>update-acl</operation>
		                </allow>
		                <!-- submitters can retrieve and update, but cannot change sharing -->
		                <allow>
		                    <group>submitters</group>
		                    <operation>retrieve-member</operation>
		                </allow>
		                <allow>
		                    <group>submitters</group>
		                    <operation>update-member</operation>
		                </allow>
		    		</rules>
   				</acl>
       		</xforms:instance>
       		
       		<xforms:instance id="user-template">
       			<user xmlns="">
       			</user>
  			</xforms:instance>
       		
       		<xforms:bind nodeset="instance('acl')/groups/group[@name='owners']">
                <xforms:bind nodeset="user[1]" readonly="true()"/>
            </xforms:bind>
       		
       		<xforms:instance id="control-instance">
                <control-instance xmlns="">
                    <back/>
                    <finish readonly="false"/>
                </control-instance>
            </xforms:instance>
        	
            <xforms:bind nodeset="instance('control-instance')">
                <xforms:bind nodeset="back" readonly="true()"/>
                <xforms:bind nodeset="finish" readonly="@readonly = 'false'"/>
            </xforms:bind>
            
            <xforms:instance id="current-user">
            	<user xmlns="">
       				<name/>
       				<roles/>
            	</user>
           	</xforms:instance>
           	
           <xforms:action 
           		ev:event="xforms-model-construct-done">
           		<xforms:setvalue ref="instance('current-user')/name" value="xxforms:get-remote-user()"/>
           </xforms:action>

           <xforms:action 
           		ev:event="xforms-model-construct-done">
           		<xforms:setvalue ref="instance('acl')/groups/group[@name='owners']/user" value="xxforms:get-remote-user()"/>
           </xforms:action>

           <xforms:action 
           		ev:event="xforms-model-construct-done">
                <xforms:insert 
                	nodeset="instance('current-user')/roles" 
                	at="1" 
                	position="before" 
                	origin="xxforms:get-request-attribute('user-roles-xml')"/>
           </xforms:action>

        </xforms:model>
        
        <style type="text/css">
            .wizard-td { background-color: #fce5b6; font-size: 16pt }
            .repeat-table { background-color: #fce5b6 }
            .repeat-table .add-td { width: 33em }
            .repeat-table .form-td { width: 33em; background: white; padding: .5em }
        </style>
        
    </head>
    
    <body>
    
    	<h1>Submitter - Create Study</h1>
    	
    	<div id="home-nav"><xforms:output ref="instance('current-user')/name"/> | <a href="../">submitter home</a></div>
    	
    	<xforms:switch>
    		
    		<xforms:case id="title" selected="true">
    		
	            <table cellpadding="3">
	                <tr>
	                    <td rowspan="3" class="wizard-td">1</td>
	                    <td colspan="1"><b>Step 1 of 4 - Study Title</b></td>
	                </tr>
	                <tr>
	                    <td>
	                    
	                        <xforms:input ref="instance('entry')/atom:title">
	                            <xforms:label class="fixed-width">Title:</xforms:label>
	                            <xforms:alert>The title is required.</xforms:alert>
	                            <xforms:toggle ev:event="DOMActivate" case="publications"/>
	                        </xforms:input>
	                        
	                    </td>
	                </tr>
	                <tr>
	                    <td>
	                        <xforms:trigger ref="instance('control-instance')/back">
	                            <xforms:label>&lt; Previous</xforms:label>
	                        </xforms:trigger>
	                        <xforms:trigger>
	                            <xforms:label>Next ></xforms:label>
	                            <xforms:toggle ev:event="DOMActivate" case="publications"/>
	                        </xforms:trigger>
	                    </td>
	                </tr>
	            </table>
           		<fr:xforms-inspector xmlns:fr="http://orbeon.org/oxf/xml/form-runner"/>           
           
    		</xforms:case>

    		<xforms:case id="publications">
    		
	            <table cellpadding="3">
	                <tr>
	                    <td rowspan="3" class="wizard-td">2</td>
	                    <td colspan="1"><b>Step 2 of 4 - Publications</b></td>
	                </tr>
	                <tr>
	                    <td>
	                    
	                    	<xforms:group ref="instance('entry')/atom:content/study">
	                    	
								<p>
									<xforms:input ref="published">
										<xforms:label class="fixed-width">Has the study been published?</xforms:label>
									</xforms:input>									
								</p>
								
								<xforms:group ref="publications">
								
									<table class="repeat-table">
										<tr>
											<td>
							                    <xforms:trigger appearance="minimal">
							                        <xforms:label><img src="/apps/submitter/common/add.gif"/></xforms:label>
							                        <xforms:insert 
							                        	ev:event="DOMActivate" 
							                        	context="instance('entry')/atom:content/study/publications" 
							                        	nodeset="publication" 
							                        	at="1" 
							                        	position="before" 
							                        	origin="instance('publication-template')"/>
							                    </xforms:trigger>
											</td>
											<td class="add-td">
							                    <xforms:trigger appearance="minimal">
							                        <xforms:label>Add One</xforms:label>
							                        <xforms:insert 
							                        	ev:event="DOMActivate" 
							                        	context="instance('entry')/atom:content/study/publications" 
							                        	nodeset="publication" 
							                        	at="1" 
							                        	position="before" 
							                        	origin="instance('publication-template')"/>
							                    </xforms:trigger>
											</td>
										</tr>
										<xforms:repeat nodeset="publication" id="publication-repeat">
											<tr>
												<td>
							                        <xforms:trigger appearance="minimal">
							                            <xforms:delete 
							                            	ev:event="DOMActivate" 
								                        	context="instance('entry')/atom:content/study/publications" 
								                        	nodeset="publication" 
							                            	at="index('publication-repeat')"/>
							                            <xforms:label><img src="/apps/submitter/common/remove.gif"/></xforms:label>
							                        </xforms:trigger>
												</td>
												<td class="form-td">
													<xforms:input ref="title">
														<xforms:label class="fixed-width">Title:</xforms:label>
														<xforms:alert>The title is required.</xforms:alert>
													</xforms:input>
													<br/>
													<xforms:input ref="first-author">
														<xforms:label class="fixed-width">First author:</xforms:label>
														<xforms:alert>The first author is required.</xforms:alert>
													</xforms:input>
													<br/>
													<xforms:input ref="year">
														<xforms:label class="fixed-width">Year:</xforms:label>
														<xforms:alert>The year is required and must be a four digit number.</xforms:alert>
													</xforms:input>
													<br/>
													<xforms:input ref="journal">
														<xforms:label class="fixed-width">Journal:</xforms:label>
														<xforms:alert>The journal is required.</xforms:alert>
													</xforms:input>
													<br/>
													<xforms:input ref="url">
														<xforms:label class="fixed-width">Web link:</xforms:label>
													</xforms:input>
													<br/>
													<xforms:input ref="doi">
														<xforms:label class="fixed-width">DOI:</xforms:label>
													</xforms:input>
													<br/>
												</td>
											</tr>
										</xforms:repeat>
									</table>
								
								</xforms:group>
								

	                    	</xforms:group>
							
	                    </td>
	                </tr>
	                <tr>
	                    <td>
	                        <xforms:trigger>
	                            <xforms:label>&lt; Previous</xforms:label>
	                            <xforms:toggle ev:event="DOMActivate" case="title"/>
	                        </xforms:trigger>
	                        <xforms:trigger>
	                            <xforms:label>Next ></xforms:label>
	                            <xforms:toggle ev:event="DOMActivate" case="permissions"/>
	                        </xforms:trigger>
	                    </td>
	                </tr>
	            </table>
	            
				<fr:xforms-inspector xmlns:fr="http://orbeon.org/oxf/xml/form-runner"/>           
    		</xforms:case>

    		<xforms:case id="permissions">
	            <table cellpadding="3">
	                <tr>
	                    <td rowspan="3" class="wizard-td">3</td>
	                    <td colspan="1"><b>Step 3 of 4 - Permissions</b></td>
	                </tr>
	                <tr>
	                    <td>
	                    	<h2>Owners</h2>
							<table class="repeat-table">
								<tr>
									<td>
					                    <xforms:trigger appearance="minimal">
					                        <xforms:label><img src="/apps/submitter/common/add.gif"/></xforms:label>
					                        <xforms:insert 
					                        	ev:event="DOMActivate" 
					                        	context="instance('acl')/groups/group[@name='owners']" 
					                        	nodeset="user" 
					                        	at="1" 
					                        	position="after" 
					                        	origin="instance('user-template')"/>
					                    </xforms:trigger>
									</td>
									<td class="add-td">
					                    <xforms:trigger appearance="minimal">
					                        <xforms:label>Add One</xforms:label>
					                        <xforms:insert 
					                        	ev:event="DOMActivate" 
					                        	context="instance('acl')/groups/group[@name='owners']" 
					                        	nodeset="user" 
					                        	at="1" 
					                        	position="after" 
					                        	origin="instance('user-template')"/>
					                    </xforms:trigger>
									</td>
								</tr>
								<xforms:repeat nodeset="instance('acl')/groups/group[@name='owners']/user" id="owner-repeat">
									<tr>
										<td>
					                        <xforms:trigger appearance="minimal">
					                            <xforms:delete 
					                            	ev:event="DOMActivate" 
						                        	context="instance('acl')/groups/group[@name='owners']" 
						                        	nodeset="user" 
					                            	at="index('owner-repeat')"/>
					                            <xforms:label><img src="/apps/submitter/common/remove.gif"/></xforms:label>
					                        </xforms:trigger>
										</td>
										<td class="form-td">
											<xforms:input ref=".">
												<xforms:label class="fixed-width">Email address:</xforms:label>
											</xforms:input>
										</td>
									</tr>
								</xforms:repeat>
							</table>
	                    	<h2>Submitters</h2>
							<table class="repeat-table">
								<tr>
									<td>
					                    <xforms:trigger appearance="minimal">
					                        <xforms:label><img src="/apps/submitter/common/add.gif"/></xforms:label>
					                        <xforms:insert 
					                        	ev:event="DOMActivate" 
					                        	context="instance('acl')/groups/group[@name='submitters']" 
					                        	nodeset="user" 
					                        	at="1" 
					                        	position="after" 
					                        	origin="instance('user-template')"/>
					                    </xforms:trigger>
									</td>
									<td class="add-td">
					                    <xforms:trigger appearance="minimal">
					                        <xforms:label>Add One</xforms:label>
					                        <xforms:insert 
					                        	ev:event="DOMActivate" 
					                        	context="instance('acl')/groups/group[@name='submitters']" 
					                        	nodeset="user" 
					                        	at="1" 
					                        	position="after" 
					                        	origin="instance('user-template')"/>
					                    </xforms:trigger>
									</td>
								</tr>
								<xforms:repeat nodeset="instance('acl')/groups/group[@name='submitters']/user" id="submitter-repeat">
									<tr>
										<td>
					                        <xforms:trigger appearance="minimal">
					                            <xforms:delete 
					                            	ev:event="DOMActivate" 
						                        	context="instance('acl')/groups/group[@name='submitters']" 
						                        	nodeset="user" 
					                            	at="index('submitter-repeat')"/>
					                            <xforms:label><img src="/apps/submitter/common/remove.gif"/></xforms:label>
					                        </xforms:trigger>
										</td>
										<td class="form-td">
											<xforms:input ref=".">
												<xforms:label class="fixed-width">Email address:</xforms:label>
											</xforms:input>
										</td>
									</tr>
								</xforms:repeat>
							</table>
	                    </td>
	                </tr>
	                <tr>
	                    <td>
	                        <xforms:trigger>
	                            <xforms:label>&lt; Previous</xforms:label>
	                            <xforms:toggle ev:event="DOMActivate" case="publications"/>
	                        </xforms:trigger>
	                        <xforms:trigger>
	                            <xforms:label>Next ></xforms:label>
	                            <xforms:toggle ev:event="DOMActivate" case="confirm"/>
	                        </xforms:trigger>
	                    </td>
	                </tr>
	            </table>
				<fr:xforms-inspector xmlns:fr="http://orbeon.org/oxf/xml/form-runner"/>           
    		</xforms:case>

    		<xforms:case id="confirm">
	            <table cellpadding="3">
	                <tr>
	                    <td rowspan="3" class="wizard-td">4</td>
	                    <td colspan="1"><b>Step 4 of 4 - Confirm</b></td>
	                </tr>
	                <tr>
	                    <td>
							<p>TODO</p>
	                    </td>
	                </tr>
	                <tr>
	                    <td>
	                        <xforms:trigger>
	                            <xforms:label>&lt; Previous</xforms:label>
	                            <xforms:toggle ev:event="DOMActivate" case="permissions"/>
	                        </xforms:trigger>
	                        <xforms:trigger>
	                            <xforms:label>Confirm</xforms:label>
	                        </xforms:trigger>
	                    </td>
	                </tr>
	            </table>
    		</xforms:case>

    	</xforms:switch>
    	


	

    </body>
    
</html>

