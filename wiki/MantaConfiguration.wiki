#summary Setup Chassis on a VirtualBox VM
#labels Phase-Deploy

Setup a VirtualBox VM using Ubuntu 
  attach a second, host only adapter 
  Install - select Lamp
  

Add to /etc/hosts on host machine
{{{
192.168.56.20	chassis
}}}
apt-get install emacs

On vm add to /etc/network/interfaces
{{{
auto eth1
iface eth1 inet static
        address 192.168.56.20
        netmask 255.255.255.0
}}}
{{{
sudo apt-get install-openssh-server

/etc/init.d/networking restart
}}}
You should now be able to ssh into the VM, no need to use the VirtualBox window.

You should now be able to see 'It works!' on http://chassis/
{{{
sudo a2enmod ssl
sudo a2enmod rewrite
sudo a2enmod proxy
sudo a2enmod proxy_httpd
sudo a2ensite default-ssl
}}}
Update /etc/apache2/sites-available/default-ssl 
{{{
ProxyRequests Off
        <Proxy *>
                Order deny,allow
                Allow from all
        </Proxy>

        ProxyPass /sso http://chassis:8080/sso
        ProxyPassReverse /sso http://chassis:8080/sso
        ProxyPass /repository http://chassis:8080/repository
        ProxyPassReverse /repository http://chassis:8080/repository
        ProxyPass /repo http://chassis:8080/repo
        ProxyPassReverse /repo http://chassis:8080/repo

}}}
{{{
sudo /etc/init.d/apache2 restart
sudo apt-get install tomcat7
sudo apt-get install maven2
sudo apt-get install subversion
sudo apt-get install openjdk-6-jdk
}}}

ssh into vm as non-privileged user
{{{
ssh chassis
mkdir workspace
cd workspace
svn checkout http://dsn-chassis.googlecode.com/svn/trunk/manta-service 
cd manta-service
mvn install 
cd ..
svn checkout http://dsn-chassis.googlecode.com/svn/trunk/chassis-webapp 
cd chassis-webapp
mvn install 
cd ..
svn checkout http://dsn-chassis.googlecode.com/svn/trunk/manta-config
cd manta-config
mvn install

sudo mkdir /usr/share/tomcat7/endorsed
sudo cp target/manta-config-0.2-alpha-4.jar /usr/share/tomcat7/endorsed/

sudo cp ~/.m2/repository/mysql/mysql-connector-java/5.1.21/mysql-connector-java-5.1.21.jar /usr/share/tomcat7/endorsed/

sudo emacs /etc/tomcat7/server.xml
}}}
To GlobalNamingResources add
{{{
 <Resource auth="Container" factory="org.apache.naming.factory.BeanFactory" name="bean/existConfigFactory" type="org.cggh.chassis.manta.util.config.ExistConfig" username="admin" password=""
       serviceBaseURL="https://chassis/repository/service"/>
<Resource auth="Container" driverClassName="com.mysql.jdbc.Driver" initialSize="10" jdbcInterceptors="ConnectionState;StatementFinalizer;SlowQueryReportJmx(threshold=10000)" jmxEnabled="true" logAbandoned="true" maxActive="100" maxIdle="100" maxWait="10000" minEvictableIdleTimeMillis="30000" minIdle="10" name="jdbc/wwarn_drupal" password="" removeAbandoned="true" removeAbandonedTimeout="60" testOnBorrow="true" testOnReturn="false" testWhileIdle="true" timeBetweenEvictionRunsMillis="5000" type="javax.sql.DataSource" url="jdbc:mysql://127.0.0.1:3306/wwarn_drupal?autoReconnect=true" username="root" validationInterval="30000" validationQuery="SELECT 1"/>
}}}

Make sure you have enough memory for tomcat - you can get away with less if you only upload small files

e.g. in /usr/share/tomcat7/bin/catalina.sh
{{{
CATALINA_OPTS="$CATALINA_OPTS -Xms512m -Xmx2048m"
}}}

{{{


sudo emacs /etc/tomcat7/tomcat-users.xml 
add 
}}}
{{{
<user username="admin" password="" roles="manager,admin" />
}}}

Import the apache self-signed certificate into the java cacerts file

{{{
sudo mkdir /data
sudo mkdir /data/atombeat
sudo chown tomcat7:tomcat7
sudo /etc/init.d/tomcat7 restart
cd ~/workspace/manta-service/
mvn tomcat:deploy
cd ~/workspace/chassis-webapp/
mvn tomcat:deploy  -Dcas.url=https://chassis/sso -Dchassis.url=https://chassis


}}}
Point browser at https://chassis/repository/home/ and have a cuppa!