#summary how to install Chassis

<wiki:toc/>

= Introduction =

The instructions below guide you through a typical deployment, using a web server running Apache proxying through to an application server running Tomcat. N.B. This is one of many possible deployment setups, for more information see also [http://code.google.com/webtoolkit/doc/1.6/DevGuideServerCommunication.html#DevGuideRPCDeployment DevGuideRPCDeployment] and [http://code.google.com/webtoolkit/doc/1.6/DevGuideDeploying.html DevGuideDeploying] in the GWT docs.

The examples below assume your *web server* is deployed at `www.example.com`, and your *application server* is deployed at `servlet.example.com:8080`.

= Deploying WARs on the Application Server =

[http://code.google.com/p/dsn-chassis/downloads/list Download] the latest release of the Chassis Generic GWT Client, the Chassis Generic User Service, and the Chassis Generic Exist Service, to your *application server*. E.g. ...

{{{
user@servlet.example.com$ wget http://dsn-chassis.googlecode.com/files/chassis-generic-client-gwt-0.1-alpha-2.war
user@servlet.example.com$ wget http://dsn-chassis.googlecode.com/files/chassis-generic-service-user-0.1-alpha-2.war
user@servlet.example.com$ wget http://dsn-chassis.googlecode.com/files/chassis-generic-service-exist-0.1-alpha-2.war
}}}

Copy these war files to the Tomcat webapps folder. E.g. ...

{{{
user@servlet.example.com$ sudo cp chassis-generic-client-gwt-0.1-alpha-2.war /var/lib/tomcat6/webapps/
user@servlet.example.com$ sudo cp chassis-generic-service-user-0.1-alpha-2.war /var/lib/tomcat6/webapps/
user@servlet.example.com$ sudo cp chassis-generic-service-exist-0.1-alpha-2.war /var/lib/tomcat6/webapps/
}}}

Tomcat will usually unpack and deploy these war files automatically. If it doesn't, try restarting Tomcat.

= Creating Atom Collections =

Chassis uses an Atom service (based on Exist) to store data about studies, submissions, etc.

You will need to create the appropriate collections in the Atom service. This can be done by running the following Python script from the *application server*.

{{{
import httplib

host = "localhost:8080"
contextpath = "/chassis-generic-service-exist-0.1-alpha-2/atom/edit"

print "creating study collection ..."

content = u"""
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Studies</title>
</feed>
"""

path = contextpath + "/studies"

headers = { "Content-Type": "application/atom+xml", "Content-Length": len(content) }
conn = httplib.HTTPConnection(host)
conn.request("POST", path, content, headers)
response = conn.getresponse()

print response.status, response.reason
data = response.read()
print data
conn.close()
}}}

If you get a 204 response, the script was successful.

= Web Server Proxy Configuration =

Add or update proxy directives to the Apache configuration on your *web server*. E.g. ...

{{{
ProxyPass         /chassis/client  http://servlet.example.com:8080/chassis-generic-client-gwt-0.1-alpha-2
ProxyPassReverse  /chassis/client  http://servlet.example.com:8080/chassis-generic-client-gwt-0.1-alpha-2

ProxyPass         /chassis/service/user  http://servlet.example.com:8080/chassis-generic-service-user-0.1-alpha-2
ProxyPassReverse  /chassis/service/user  http://servlet.example.com:8080/chassis-generic-service-user-0.1-alpha-2

ProxyPass         /chassis/service/exist  http://servlet.example.com:8080/chassis-generic-service-exist-0.1-alpha-2
ProxyPassReverse  /chassis/service/exist  http://servlet.example.com:8080/chassis-generic-service-exist-0.1-alpha-2
}}}

Restart Apache on your web server.

= Client Configuration =

The Chassis client application needs to be configured to point to the correct locations for the services you have deployed.

Edit the Chassis Generic Client configuration file deployed on your *application server* to point to the correct User Service location. E.g. do ...

{{{
user@servlet.example.com$ sudo emacs /var/lib/tomcat6/webapps/chassis-generic-client-gwt-0.1-alpha-2/spike/configuration.js 
}}}

... and edit to ...

{{{
CHASSIS.userDetailsServiceEndpointURL = "/chassis/service/user/gwtrpc/userdetails";
CHASSIS.studyFeedURL = "/chassis/service/exist/atom/edit/studies";
}}}

= Security Configuration =

Chassis uses [http://static.springsource.org/spring-security/site/ Spring Security 2.0.x] to integrate with various authentication and authorisation mechanisms.

To integrate Chassis with your authentication and authorisation environment, you will have to create a Spring Security configuration file. 

You will need to create your own Spring Security configuration file, and place it in a secure location on your *application server*. Let's assume that you put this file at `/etc/chassis/security.xml`.

You will then need to edit the `web.xml` files in *each* of the deployed WARs on your application server, and update the following parameter to point to the location where your Spring Security configuration file is located.

{{{
  <context-param>
    <param-name>contextConfigLocation</param-name>
    <param-value>
      file:///etc/chassis/security.xml
    </param-value>
  </context-param>
}}}

A sed command like the following could be used to make this less of a chore.

{{{
sudo sed -i -e "s|classpath:/dev/configuration/spring/security\.xml|file:///etc/chassis/security.xml|" /var/lib/tomcat6/webapps/chassis-generic-*-0.1-alpha-2/WEB-INF/web.xml
}}}

== Example Spring Security Configuration - Simple ==

The Spring Security configuration file below is the one we use for our development environment. N.B. this may not suitable for a production environment.

{{{
<?xml version="1.0" encoding="UTF-8"?>
<beans:beans 
  xmlns:beans="http://www.springframework.org/schema/beans"
  xmlns="http://www.springframework.org/schema/security"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
              http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-2.0.4.xsd">  

  <http auto-config='true' realm="chassis-development-realm">
    <intercept-url pattern="/**" access="ROLE_CHASSIS_USER" />
    <http-basic/>
  </http>
  
  <authentication-provider>
    <user-service>
      <user name="foo" password="bar" authorities="ROLE_CHASSIS_USER, ROLE_CHASSIS_SUBMITTER, ROLE_CHASSIS_CURATOR, ROLE_CHASSIS_GATEKEEPER, ROLE_CHASSIS_COORDINATOR" />
      <user name="simple" password="user" authorities="ROLE_CHASSIS_USER" />
    </user-service>
  </authentication-provider>
  
</beans:beans>
}}}

== Example Spring Security Configuration - Webauth ==

The example below illustrates integration with an existing authentication system based on webauth, which we use for Chassis/WWARN.

{{{
<?xml version="1.0" encoding="UTF-8"?>
<beans:beans 
  xmlns:beans="http://www.springframework.org/schema/beans"
  xmlns="http://www.springframework.org/schema/security"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd
              http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-2.0.4.xsd">  

  <http auto-config='false' 
  		realm="chassis-development-realm"
  		entry-point-ref="authenticationEntryPoint"
  		access-decision-manager-ref="accessDecisionManager"/>
  
  <beans:bean id="authenticationEntryPoint" class="org.springframework.security.ui.preauth.PreAuthenticatedProcessingFilterEntryPoint"/>
  
  <!--Config to use external authentication-->
  <beans:bean id="WebAuthPreAuthenticatedProcessingFilter" class="org.cggh.chassis.generic.user.service.webauth.WebAuthPreAuthenticatedProcessingFilter">
      <custom-filter position="PRE_AUTH_FILTER" />
      <beans:property name="authenticationManager" ref="authenticationManager" />
    <beans:property name="dataSource" ref="dataSource"/>
  </beans:bean>

  <authentication-manager alias="authenticationManager" />

  <beans:bean id="preauthAuthProvider" class="org.springframework.security.providers.preauth.PreAuthenticatedAuthenticationProvider">
      <custom-authentication-provider />
      <beans:property name="preAuthenticatedUserDetailsService">
        <beans:bean id="userDetailsServiceWrapper"
              class="org.springframework.security.userdetails.UserDetailsByNameServiceWrapper">
          <beans:property name="userDetailsService" ref="userDetailsService"/>
        </beans:bean>
      </beans:property>
  </beans:bean>
  
  <!--Config to get user details and permissions directly from CGGH database-->
  <authentication-provider user-service-ref='userDetailsService'/>
  <beans:bean id="userDetailsService" class="org.springframework.security.userdetails.jdbc.JdbcDaoImpl">
    <beans:property name="dataSource" ref="dataSource"/>
    <beans:property name="enableGroups" value="false"/>
    <beans:property name="enableAuthorities" value="true"/>
    <beans:property name="usersByUsernameQuery" value="SELECT email AS user_name,
                                                              'password' AS password,
                                                              1 AS enabled
                                                         FROM master_user
                                                         WHERE email=?"/>
    <beans:property name="authoritiesByUsernameQuery" value="SELECT mu.email AS user_name,
                                                                    p.permission AS authority
                                                             FROM user_permission up
                                                              INNER JOIN master_user mu
                                                              	  ON up.user_id = mu.user_id
                                                              INNER JOIN permission p
                                                                  ON up.permission_id = p.permission_id
                                                             WHERE mu.email=?"/>
  </beans:bean>

  <beans:bean id="dataSource" class="org.springframework.jdbc.datasource.DriverManagerDataSource">
    <beans:property name="driverClassName" value="com.mysql.jdbc.Driver"/>
    <beans:property name="url" value="jdbc:mysql://[DB server name goes here]:3306/[user database name goes here]"/>
    <beans:property name="username" value="[DB username goes here]"/>
    <beans:property name="password" value="[DB password goes here]"/>
  </beans:bean>
    
  <!--Allow any kind of authority to be defined-->
  <beans:bean id="accessDecisionManager" class="org.springframework.security.vote.UnanimousBased">
      <beans:property name="decisionVoters">
          <beans:list>
              <beans:ref bean="roleVoter"/>
          </beans:list>
      </beans:property>
  </beans:bean>

  <beans:bean id="roleVoter" class="org.springframework.security.vote.RoleVoter">
      <beans:property name="rolePrefix" value=""/>
  </beans:bean>
  
</beans:beans>
}}}

Note that the db username and password need to be edited.

Note that the default permission prefix is 'ROLE_CHASSIS_'. This can be changed within the Chassis Generic Client configuration file deployed on your *application server*. E.G. do...

{{{
user@servlet.example.com$ sudo emacs /var/lib/tomcat6/webapps/chassis-generic-client-gwt-0.1-alpha-2/spike/configuration.js 
}}}

... and edit to ...

{{{
CHASSIS.userChassisRolesPrefix = "permission.cggh.chassis.wwarn.";
}}}


Note that this second example also requires the following directives to be added to the Apache configuration:

{{{
TODO get directives used on bravo
}}}

= It Works!? =

That's it.

You should now be able to visit http://www.example.com/chassis/client/spike/ to check it is working.