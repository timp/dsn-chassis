<?xml version="1.0" encoding="UTF-8"?>
<web-app version="2.4" xsi:schemaLocation="http://java.sun.com/xml/ns/j2ee http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://java.sun.com/xml/ns/j2ee">
    
    <display-name>manta-service</display-name>
    <description>
        Chassis Manta using AtomBeat with Orbeon (Minimal)
    </description>
    
    <!--+
        |
        | HTTP Method Override Filter
        | ***************************
        |
        | (N.B. put this before spring security, so security is applied to value of
        | method override if given)
        |
        +-->
    
    
    <filter>
        <filter-name>HttpMethodOverrideFilter</filter-name>
        <filter-class>org.atombeat.http.HttpMethodOverrideFilter</filter-class>
        <init-param>
            <param-name>allowedOverrides</param-name>
            <param-value>PUT DELETE</param-value>
        </init-param>
    </filter>
    
    
    <filter-mapping>
        <filter-name>HttpMethodOverrideFilter</filter-name>
        <url-pattern>/*</url-pattern>
    </filter-mapping>
    
    <!--+
        | Spring Security Configuration
        | *****************************
        | 
        +-->
    
    <context-param>
        <param-name>contextConfigLocation</param-name>
        <param-value>
            ${contextConfigLocation}
        </param-value>
    </context-param>
    
     <context-param>
                <param-name>log4jConfigLocation</param-name>
                <param-value>WEB-INF/resources/config/log4j.xml</param-value>
        </context-param>
        
        <context-param>
                <param-name>log4jExposeWebAppRoot</param-name>
                <param-value>false</param-value>
        </context-param>
        
        <context-param>
                <param-name>webAppRootKey</param-name>
                <param-value>repo</param-value>
        </context-param>
        
        <listener>
                <listener-class>org.springframework.web.util.Log4jConfigListener</listener-class>
        </listener>
        
          <!--
        Include the character encoding Filter as per JASIG recommenation when doing Single Sign Out
        https://wiki.jasig.org/display/CASC/Configuring+Single+Sign+Out
    -->
    <filter>
        <filter-name>characterEncodingFilter</filter-name>
        <filter-class>org.springframework.web.filter.CharacterEncodingFilter</filter-class>
        <init-param>
            <param-name>encoding</param-name>
            <param-value>UTF-8</param-value>
        </init-param>
    </filter>
    <filter>
        <filter-name>springSecurityFilterChain</filter-name>
        <filter-class>org.springframework.web.filter.DelegatingFilterProxy</filter-class>
    </filter>

    <filter-mapping>
        <filter-name>characterEncodingFilter</filter-name>
        <url-pattern>/*</url-pattern>
    </filter-mapping>
    <filter-mapping>
        <filter-name>springSecurityFilterChain</filter-name>
        <url-pattern>/*</url-pattern>
    </filter-mapping>

    <!--
        Included to support Single Logout. Note that the SingleSignOutFilter is included in the
        springSecurityFilterChain. However, it could also be placed as the first filter-mapping
        in the web.xml
    -->
    <listener>
        <listener-class>org.jasig.cas.client.session.SingleSignOutHttpSessionListener</listener-class>
    </listener>

    <!--
      - Loads the root application context of this web app at startup.
      - The application context is then available via
      - WebApplicationContextUtils.getWebApplicationContext(servletContext).
    -->
    <listener>
        <listener-class>org.springframework.web.context.ContextLoaderListener</listener-class>
    </listener>
        
  
    
    <!-- store username in request attribute so it can be accessed easily in xqueries -->
    
    <filter>
        <filter-name>SpringSecurityRequestAttributeFilter</filter-name>
        <filter-class>org.atombeat.http.SpringSecuritySetUserRequestAttributesFilter</filter-class>
    </filter>
    
    
    <filter-mapping>
        <filter-name>SpringSecurityRequestAttributeFilter</filter-name>
        <url-pattern>/*</url-pattern>
    </filter-mapping> 
    
    
  
    <servlet>
        <servlet-name>exist-xmlrpc-servlet</servlet-name>
        <servlet-class>org.exist.xmlrpc.RpcServlet</servlet-class>
    </servlet>
    <servlet>
        <servlet-name>exist-rest-servlet</servlet-name>
        <servlet-class>org.exist.http.servlets.EXistServlet</servlet-class>
        <init-param>
            <param-name>basedir</param-name>
            <param-value>WEB-INF/</param-value>
        </init-param>
        <init-param>
            <param-name>configuration</param-name>
            <param-value>exist-conf.xml</param-value>
        </init-param>
        <init-param>
            <param-name>start</param-name>
            <param-value>true</param-value>
        </init-param>
        <load-on-startup>2</load-on-startup>
    </servlet>
    <servlet>
        <servlet-name>exist-webdav-servlet</servlet-name>
        <servlet-class>org.exist.http.servlets.WebDAVServlet</servlet-class>
        <init-param>
            <param-name>authentication</param-name>
            <param-value>basic</param-value>
        </init-param>
    </servlet>
 
     
    <servlet-mapping>
        <servlet-name>exist-xmlrpc-servlet</servlet-name>
        <url-pattern>/xmlrpc</url-pattern>
    </servlet-mapping>
    
    <servlet-mapping>
        <servlet-name>exist-rest-servlet</servlet-name>
        <url-pattern>/rest/*</url-pattern>
    </servlet-mapping>

 
    <!--
    <servlet-mapping>
        <servlet-name>exist-webdav-servlet</servlet-name>
        <url-pattern>/exist/webdav/*</url-pattern>
    </servlet-mapping>
    -->
    
    <!--
    <servlet-mapping>
        <servlet-name>exist-atom-servlet</servlet-name>
        <url-pattern>/exist/atom/*</url-pattern>
    </servlet-mapping>
    -->
    
    <!-- Uncomment this for the SQL examples -->
    <resource-ref>
        <description>DataSource</description>
        <res-ref-name>jdbc/wwarn_drupal</res-ref-name>
        <res-type>javax.sql.DataSource</res-type>
        <res-auth>Container</res-auth>
    </resource-ref>
    <!-- End SQL examples -->
    <resource-env-ref>
        <description>
            Object factory for eXist config instances.
        </description>
        <resource-env-ref-name>bean/existConfigFactory</resource-env-ref-name>
        <resource-env-ref-type>org.cggh.chassis.manta.util.config.ExistConfig</resource-env-ref-type>
    </resource-env-ref>
    
    <session-config>
        <session-timeout>720</session-timeout>
    </session-config>
    
    <servlet>
        <servlet-name>XQueryServlet</servlet-name>
        <servlet-class>org.exist.http.servlets.XQueryServlet</servlet-class>
        
        <init-param>
            <param-name>uri</param-name>
            <param-value>xmldb:exist:///db</param-value>
        </init-param>
        
        <init-param>
            <param-name>form-encoding</param-name>
            <param-value>UTF-8</param-value>
        </init-param>
        
        <init-param>
            <param-name>container-encoding</param-name>
            <param-value>UTF-8</param-value>
        </init-param>
        
        <init-param>
            <param-name>encoding</param-name>
            <param-value>UTF-8</param-value>
        </init-param>
        
    </servlet>
    
    <!-- AtomBeat: add the XQueryURLRewrite filter needed by AtomBeat -->
    
    <filter>
        <filter-name>XQueryURLRewrite</filter-name>
        <filter-class>org.exist.http.urlrewrite.XQueryURLRewrite</filter-class>
        
        <!-- Defines the location of the controller-config.xml file, which defines
            the root mappings. -->
        <init-param>
            <param-name>config</param-name>
            <param-value>WEB-INF/controller-config.xml</param-value>
        </init-param>
        
        <!-- This could also be stored inside the db: -->
        <!--init-param>
            <param-name>config</param-name>
            <param-value>xmldb:exist:///db/controller-config.xml</param-value>
            </init-param-->
    </filter>
    
    <filter-mapping>
        <filter-name>XQueryURLRewrite</filter-name>
        <url-pattern>/service/*</url-pattern>
    </filter-mapping>
    
    <filter-mapping>
        <filter-name>XQueryURLRewrite</filter-name>
        <url-pattern>/admin/*</url-pattern>
    </filter-mapping>
    
    
    <!--+
        |
        | Custom servlets
        | ***************
        +-->
    
   
    
    <servlet>
        <servlet-name>StoreUploadsServlet</servlet-name>
        <servlet-class>org.cggh.chassis.manta.http.servlet.StoreUploadsServlet</servlet-class>
    </servlet>
    
    <servlet-mapping>
        <servlet-name>StoreUploadsServlet</servlet-name>
        <url-pattern>/util/store-uploads</url-pattern>
    </servlet-mapping>
    
    
    <!--+
        |
        | Custom error pages
        | ******************
        +-->
    
    <error-page>
        <error-code>403</error-code>
        <location>/common/forbidden</location>
    </error-page> 
    
    <error-page>
        <error-code>404</error-code>
        <location>/common/not-found</location>
    </error-page> 
    
    
</web-app>
