<?xml version="1.0" encoding="utf-8"?>

<xforms:model id="cmis-rest-model" xmlns:xforms="http://www.w3.org/2002/xforms"
    xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
    xmlns:xi="http://www.w3.org/2001/XInclude"
    xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:cmis="http://docs.oasis-open.org/ns/cmis/core/200908/"
    xmlns:cmisra="http://docs.oasis-open.org/ns/cmis/restatom/200908/"
    xmlns:alf="http://www.alfresco.org"
    xmlns:ev="http://www.w3.org/2001/xml-events">
    <xxforms:variable name="alfresco-uri" select="xxforms:property('chassis.alfresco.uri')"
        as="xs:anyURI"/>
    <xxforms:variable name="alfresco-username"
        select="xxforms:property('chassis.alfresco.username')"
        as="xs:string"/>
    <xxforms:variable name="alfresco-credentials"
        select="xxforms:property('chassis.alfresco.credentials')"
        as="xs:string"/>
    <xxforms:variable name="is-send-alfresco" select="xxforms:property('chassis.alfresco.send')" as="xs:boolean"/>
    
    <xxforms:variable name="alf-ticket" select="instance('ins-cmis-rest-auth')/ticket"/>
    <xxforms:variable name="studies-root" select="'WWARN/studies'" as="xs:string"/>
    <xxforms:variable name="files-root" select="''" as="xs:string"/>
    <!--
curl “http://localhost:8080/alfresco/s/api/login?u=admin&pw=admin”
Returns this:
<?xml version="1.0" encoding="UTF-8"?>
<ticket>TICKET_44740de7943f7bab5be61f787c62660ff3008299</ticket>
If you go this route, you’ll want to copy and paste the ticket (everything
between the open and closing ticket tags) somewhere convenient. Every call
you make from here on out will require it, like this:
curl
"http://localhost:8080/alfresco/s/cmis?alf_ticket=TICKET_44740de7943f7b
ab5be61f787c62660ff3008299"
    -->
    <xforms:instance id="ins-cmis-rest-control">
        <control>
            <site/>
            <modules/>
        </control>
    </xforms:instance>
    
    <xforms:instance id="ins-cmis-rest-auth">
        <ticket xmlns=""/>
    </xforms:instance>
    
    <xforms:instance id="ins-cmis-rest-create-site">
        <xi:include href="create-site.xml" xxi:omit-xml-base="true"/>
    </xforms:instance>

    <xforms:instance id="ins-cmis-rest-create-space">
        <xi:include href="create-space.xml" xxi:omit-xml-base="true"/>
    </xforms:instance>
    
    <xforms:instance id="ins-cmis-rest-create-file">
        <xi:include href="create-file.xml" xxi:omit-xml-base="true"/>
    </xforms:instance>
    
    <xforms:instance id="ins-cmis-rest-update-file">
        <xi:include href="create-file.xml" xxi:omit-xml-base="true"/>
    </xforms:instance>
    
    <xforms:instance id="ins-cmis-rest-binary-data">
        <study/>
    </xforms:instance>
    
    <!-- xxforms attribs work for http auth -->
    <xforms:submission ref="instance('ins-cmis-rest-auth')" id="cmis-rest-auth-submission" method="get"
        action="{$alfresco-uri}s/api/login?u={$alfresco-username}&amp;pw={$alfresco-credentials}"
        xxforms:username="{$alfresco-username}" xxforms:password="{$alfresco-credentials}"
        replace="instance" instance="ins-cmis-rest-auth" if="$is-send-alfresco">
        <xforms:action ev:event="xforms-submit-done"> </xforms:action>
    </xforms:submission>
    
    <!--
        <xforms:dispatch target="cmis-rest-model" name="alfresco-send-document">
            <xxforms:context name="fr:name" select="concat($form-title, ' (#', $document, ').xml')"/>
            <xxforms:context name="fr:title" select="$form-title"/>
            <xxforms:context name="fr:description" select="$form-description"/>
            <xxforms:context name="fr:mimetype" select="'application/xml'"/>
        XML data -> string -> Base64
            <xxforms:context name="fr:content" select="saxon:string-to-base64Binary(saxon:serialize(xxforms:instance('fr-form-instance'), 'xml'), 'UTF-8')"/>
    </xforms:dispatch>
    -->
    <xforms:action ev:event="cmis-rest-create-site">
        <!-- 
        <xforms:send submission="cmis-rest-auth-submission"/>
        -->
        <xforms:setvalue ref="instance('ins-cmis-rest-create-site')//atom:title" value="event('fr:title')"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-create-site')//cmis:propertyId[@propertyDefinitionId='cmis:objectTypeId']/cmis:value" value="'F:wc:study_folder'"/>
       
        <!-- Don't need to worry about editing the meta-data here as the study will be updated shortly afterwards
            when the meta-data will be filled in -->
        
        <xforms:send submission="cmis-rest-create-site-submission"/>
    </xforms:action>

    <xforms:instance id="clinical">
        <cmis:value>Clinical</cmis:value>
    </xforms:instance>
    
    <xforms:instance id="set-study-aspects">
        <alf:setAspects>
            <alf:aspectsToAdd>P:cm:titled</alf:aspectsToAdd>
            <alf:properties>
                <cmis:propertyString propertyDefinitionId="cm:title" displayName="Title" queryName="cm:title">
                    <cmis:value>Summary</cmis:value>
                </cmis:propertyString>
            </alf:properties>
        </alf:setAspects>
    </xforms:instance>
    <xforms:action ev:event="cmis-rest-update-study">
        <!-- Save the event values for later -->
        <xforms:setvalue ref="instance('ins-cmis-rest-control')//site" value="event('fr:title')"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-control')//modules" value="event('fr:modules')"/>
        <xforms:send submission="cmis-rest-get-folder-record"/>
        <!-- Update meta-data -->
        <!-- set title - doesn't work -->
        <xforms:delete nodeset="instance('ins-cmis-rest-create-file')//cmis:propertyString[@propertyDefinitionId='cm:title']/*"/>
        <xforms:insert context="instance('ins-cmis-rest-create-file')//cmisra:object" origin="instance('set-study-aspects')"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//alf:setAspects/alf:properties/cmis:propertyString[@propertyDefinitionId='cm:title']/cmis:value" value="event('fr:description')"/>
        <!-- end of set title -->
        <!-- set modules -->
        <xforms:delete nodeset="instance('ins-cmis-rest-create-file')//cmis:propertyString[@propertyDefinitionId='wc:modules']/*"/>
        <!-- if condition doesn't work -->
        <xforms:insert context="instance('ins-cmis-rest-create-file')//cmis:propertyString[@propertyDefinitionId='wc:modules']"
            origin="instance('clinical')" if="instance('ins-cmis-rest-control')//modules[contains(., 'clinical')]"/>
        <!-- end of modules -->
        <xforms:delete nodeset="instance('ins-cmis-rest-create-file')//cmis:propertyString[@propertyDefinitionId='wc:countries']/*"/>
        <xforms:insert context="instance('ins-cmis-rest-create-file')//cmis:propertyString[@propertyDefinitionId='wc:countries']"
            origin="xxforms:instance('ins-country-items')//country[value=xxforms:instance('ins-sq-study-info-entry')//country]/label"/>
        <!-- Need to work out where to put the people
        <xforms:insert context="instance('ins-cmis-rest-create-file')//cmis:propertyString[@propertyDefinitionId='']"
                origin="xxforms:instance('ins-permissions-entry')//atombeat:groups/atombeat:group[@id='GROUP_ADMINISTRATORS']/atombeat:member"/>
        -->    
        <xforms:send submission="sub-transform-study"/>
        <!--
        
        
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//cmis:propertyString[@propertyDefinitionId='wc:countries']/cmis:value" value="event('fr:author')"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//cmis:propertyString[@propertyDefinitionId='wc:study_info_link']/cmis:value" value="event('fr:author')"/>
        -->
        
        <xforms:send submission="cmis-rest-update-folder-submission"/>
    </xforms:action>
    
    <xforms:action ev:event="cmis-rest-delete-site">
        <xforms:setvalue ref="instance('ins-cmis-rest-control')//site" value="event('fr:site')"/>
        <xforms:send submission="cmis-rest-delete-site-submission"/>
    </xforms:action>
    
    <xforms:action ev:event="cmis-rest-create-document">
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//atom:title" value="concat(event('fr:name'),event('fr:file-ext'))"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//atom:summary" value="event('fr:title')"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//atom:content" value="saxon:string-to-base64Binary(saxon:serialize(event('fr:content'), 'xml'), 'UTF-8')"/>
        <!--saxon:string-to-base64Binary(saxon:serialize(event('fr:content'), 'xml'), 'UTF-8')-->
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//atom:content/@type" value="'application/octet-stream'"/> <!-- event('fr:mime-type') -->
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//cmis:propertyString[@propertyDefinitionId='cmis:contentStreamMimeType']/cmis:value" value="event('fr:mime-type')"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//cmis:propertyString[@propertyDefinitionId='cm:author']/cmis:value" value="event('fr:author')"/>
        
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//cmis:propertyId[@propertyDefinitionId='cmis:objectTypeId']/cmis:value" value="'D:wc:study_info'"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-control')//site" value="event('fr:site')"/>
        <xforms:send submission="cmis-rest-create-file-submission"/>
    </xforms:action>
    
    <xforms:action ev:event="cmis-rest-update-document">
        <!-- Save the event values for later -->
        <!-- <xforms:setvalue ref="instance('ins-cmis-rest-binary-data')" value="saxon:string-to-base64Binary(saxon:serialize(event('fr:content'), 'xml'), 'UTF-8')"/> -->
        <xforms:setvalue ref="instance('ins-cmis-rest-binary-data')" value="xxforms:instance('ins-study-entry')//study"/>
        <xforms:setvalue ref="instance('attachment')//attachment" value="event('fr:content')"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-update-file')//atom:summary" value="event('fr:title')"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-update-file')//atom:content/@type" value="event('fr:mime-type')"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-update-file')//cmis:propertyString[@propertyDefinitionId='cmis:contentStreamMimeType']/cmis:value" value="event('fr:mime-type')"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-update-file')//cmis:propertyString[@propertyDefinitionId='cm:author']/cmis:value" value="event('fr:author')"/>
        
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//atom:title" value="concat(event('fr:name'),event('fr:file-ext'))"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-control')//site" value="event('fr:site')"/>
        <xforms:send submission="cmis-rest-get-file-record"/>
        <!-- Update meta-data -->
        <!-- Need to check if the event can be used and can discard update-file instance -->
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//atom:summary" value="instance('ins-cmis-rest-update-file')//atom:summary"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//atom:content/@type" value="//atom:content/@type"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//cmis:propertyString[@cmis:propertyDefinitionId='cmis:contentStreamMimeType']/cmis:value" value="//cmis:propertyString[@propertyDefinitionId='cmis:contentStreamMimeType']/cmis:value"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//cmis:propertyString[@cmis:propertyDefinitionId='cm:author']/cmis:value" value="instance('ins-cmis-rest-update-file')//cmis:propertyString[@propertyDefinitionId='cm:author']/cmis:value"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//cmis:propertyId[@propertyDefinitionId='cmis:objectTypeId']/cmis:value" value="'D:wc:study_info'"/>
        
        <xforms:setvalue ref="instance('ins-cmis-rest-control')//site" value="event('fr:site')"/>
        <xforms:send submission="cmis-rest-update-file-submission"/>
        <!-- Update the file contents -->
        <xforms:send submission="cmis-rest-update-file-content-submission"/>
    </xforms:action>
    
    <xforms:action ev:event="cmis-rest-upload-file">
        <xforms:setvalue ref="instance('ins-cmis-rest-control')//site" value="event('fr:site')"/>
       
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//atom:title" value="event('fr:title')"/>
        
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//atom:summary" value="event('fr:atombeat-uri')"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//atom:category[@term]" value="event('fr:category-term')"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//atom:category[@label]" value="event('fr:category-label')"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//atom:content" value="event('fr:file-content')"/>
        
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//atom:content/@type" value="'application/octet-stream'"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-create-file')//cmis:propertyString[@propertyDefinitionId='cmis:contentStreamMimeType']/cmis:value" value="event('fr:content-type')"/>
        <xforms:setvalue ref="instance('ins-cmis-rest-control')//site" value="event('fr:site')"/>
        <xforms:send submission="cmis-rest-create-file-submission"/>
       
    </xforms:action>
<!-- End of actions -->   
    <xforms:submission ref="instance('ins-cmis-rest-create-site')" id="cmis-rest-create-site-submission" method="post"
        action="{$alfresco-uri}service/cmis/p/{$studies-root}/children"
        mediatype="application/atom+xml"
        xxforms:username="{$alfresco-username}" xxforms:password="{$alfresco-credentials}"
        replace="instance" instance="ins-cmis-rest-create-site" if="$is-send-alfresco">
    </xforms:submission>
  
    <xforms:submission ref="instance('ins-cmis-rest-create-space')" id="cmis-rest-create-space-submission" method="post"
        action="{instance('ins-cmis-rest-create-site')//atom:link[@rel='down' and @type='application/atom+xml;type=feed' ]/@href}"
        mediatype="application/atom+xml"
        xxforms:username="{$alfresco-username}" xxforms:password="{$alfresco-credentials}"
        replace="instance" instance="ins-cmis-rest-create-space" if="$is-send-alfresco">
    </xforms:submission>
    <!-- These submissions are the same apart from the action definition -->
    <xforms:submission ref="instance('ins-cmis-rest-create-file')" id="cmis-rest-create-study-file-submission" method="post"
        action="{instance('ins-cmis-rest-create-space')//atom:link[@rel='down' and @type='application/atom+xml;type=feed' ]/@href}"
        mediatype="application/atom+xml"
        xxforms:username="{$alfresco-username}" xxforms:password="{$alfresco-credentials}"
        replace="instance" instance="ins-cmis-rest-create-file" if="$is-send-alfresco">
    </xforms:submission>
    <xforms:submission ref="instance('ins-cmis-rest-create-file')" id="cmis-rest-create-file-submission" method="post"
        action="{$alfresco-uri}service/cmis/p/{$studies-root}/{instance('ins-cmis-rest-control')//site}/{$files-root}children"
        mediatype="application/atom+xml"
        xxforms:username="{$alfresco-username}" xxforms:password="{$alfresco-credentials}"
        replace="instance" instance="ins-cmis-rest-create-file" if="$is-send-alfresco">
    </xforms:submission>
    <!-- upload a file -->
    <xforms:submission ref="xxforms:instance('ins-upload')" id="cmis-rest-upload-file-submission" method="post"
        serialization="multipart/form-data"
        resource="{$alfresco-uri}service/cmis/p/{$studies-root}/{instance('ins-cmis-rest-control')//site}/{$files-root}children"
        xxforms:username="{$alfresco-username}" xxforms:password="{$alfresco-credentials}"
        replace="none" if="$is-send-alfresco">
    </xforms:submission>
    <!-- updating -->
    <!-- study -->
    <xforms:submission id="sub-transform-study" action="http://localhost:8080/repository/contributor/transform-study"
        replace="instance" method="post" ref="instance('ins-cmis-rest-create-file')"
        instance="ins-cmis-rest-create-file">
        
        <xforms:message ev:event="xforms-submit-error" level="modal">
            An error occurred (
            <xforms:output value="event('error-type')" />
            ) while trying to retrieve author information.
        </xforms:message>
        
    </xforms:submission>
    <xforms:submission id="cmis-rest-get-folder-record" method="get"
        action="{$alfresco-uri}service/cmis/p/{$studies-root}/{instance('ins-cmis-rest-control')//site}"
        mediatype="application/atom+xml"
        xxforms:username="{$alfresco-username}" xxforms:password="{$alfresco-credentials}"
        replace="instance" instance="ins-cmis-rest-create-file" if="$is-send-alfresco"
        serialization="none">
    </xforms:submission>
    <xforms:submission ref="instance('ins-cmis-rest-create-file')" id="cmis-rest-update-folder-submission" method="put"
        action="{$alfresco-uri}service/cmis/p/{$studies-root}/{instance('ins-cmis-rest-control')//site}"
        mediatype="application/atom+xml"
        xxforms:username="{$alfresco-username}" xxforms:password="{$alfresco-credentials}"
        replace="instance" instance="ins-cmis-rest-create-file" if="$is-send-alfresco">
    </xforms:submission>
    <!-- file -->
    <xforms:submission id="cmis-rest-get-file-record" method="get"
        action="{$alfresco-uri}service/cmis/p/{$studies-root}/{instance('ins-cmis-rest-control')//site}/{$files-root}{instance('ins-cmis-rest-create-file')//atom:title}"
        mediatype="application/atom+xml"
        xxforms:username="{$alfresco-username}" xxforms:password="{$alfresco-credentials}"
        replace="instance" instance="ins-cmis-rest-create-file" if="$is-send-alfresco"
        serialization="none">
    </xforms:submission>
    <xforms:submission ref="instance('ins-cmis-rest-create-file')" id="cmis-rest-update-file-submission" method="put"
        action="{$alfresco-uri}service/cmis/p/{$studies-root}/{instance('ins-cmis-rest-control')//site}/{$files-root}{instance('ins-cmis-rest-create-file')//atom:title}"
        mediatype="application/atom+xml"
        xxforms:username="{$alfresco-username}" xxforms:password="{$alfresco-credentials}"
        replace="instance" instance="ins-cmis-rest-create-file" if="$is-send-alfresco">
    </xforms:submission>
    <xforms:instance id="attachment">
        <attachment xsi:type="xs:anyURI">
            file:/Users/jdoe/Applications/apache-tomcat-5.5.20/temp/xforms_upload_30877.tmp
        </attachment>
    </xforms:instance>
    <!-- Actually update the file - this is for XML content -->
    <xforms:submission ref="xxforms:instance('ins-study-entry')//study" id="cmis-rest-update-file-content-submission" method="put"
        resource="{instance('ins-cmis-rest-create-file')//atom:link[@rel='edit-media']/@href}"
        xxforms:username="{$alfresco-username}" xxforms:password="{$alfresco-credentials}"
        replace="none" instance="xxforms:instance('ins-study-entry')//study" if="$is-send-alfresco">
        <!-- Together with mediatype="text/plain" serialization="application/x-www-form-urlencoded" omit-xml-declaration="true"
            <xforms:setvalue ev:event="xforms-submit-serialize" ref="event('submission-body')" value="/myXSLValue"> -->
    </xforms:submission>
    <!-- deleting including all descendants -->
    <xforms:submission id="cmis-rest-delete-site-submission" method="delete"
        resource="{$alfresco-uri}service/cmis/p/{$studies-root}/{instance('ins-cmis-rest-control')//site}/descendants"
        xxforms:username="{$alfresco-username}" xxforms:password="{$alfresco-credentials}"
        replace="none"  if="$is-send-alfresco">
    </xforms:submission>
</xforms:model>